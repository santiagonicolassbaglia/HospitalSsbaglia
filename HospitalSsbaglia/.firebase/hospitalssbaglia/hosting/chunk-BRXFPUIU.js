import{d as Nn,e as An,f as Gs,g as fe,k as Pn,l as xn,m as On,o as Dn,p as Co,q as To,r as bo,s as Io,t as Ro,u as So,v as ko,w as Ln,y as No}from"./chunk-S3JKDRC3.js";import{A as vo,B as g,C as X,D as B,E as qs,F as wo,G as Nt,H as k,I as he,J as Tn,K as Vs,L as Eo,M as bn,N as In,O as Rn,P as Sn,R as kn,T as et,U as de,a as _,b as Ze,c as uo,d as ho,e as fo,f as vn,g as $,h as wn,j as js,k as _o,l as ue,o as po,q as En,r as M,s as go,t as mo,u as se,v as Re,w as Cn,x as kt,z as yo}from"./chunk-K6Y3BNXS.js";import{$ as Ie,Aa as mn,B as ro,F as oo,L as Hs,M as ao,Ma as yn,O as lo,Q as Ce,U as co,Y as Je,ba as T,c as gn,h as io,m as St,n as Ee,r as G,x as Ws}from"./chunk-QPVJROBB.js";import{a as Fe,b as pn,h as D}from"./chunk-DEPBX7UX.js";var Ue=class{constructor(e,t,s,i,r,o,a=[],l,c,u,h,d,f=!1,p=null,m=[]){this.obraSocial=null,this.especialidad=[],this.aprobado=null,this.lastLogin=null,this.esAdmin=!1,this.idTurnos=[],this.uid=e,this.nombre=t,this.apellido=s,this.dni=i,this.edad=r,this.obraSocial=o,this.especialidad=a,this.contrase\u00F1a=l,this.mail=c,this.imagenes=u,this.code=h,this.lastLogin=d,this.esAdmin=f,this.aprobado=p}};var Ao="@firebase/database",Po="1.0.5";var sr="";function ir(n){sr=n}var Zs=class{constructor(e){this.domStorage_=e,this.prefix_="firebase:"}set(e,t){t==null?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),M(t))}get(e){let t=this.domStorage_.getItem(this.prefixedName_(e));return t==null?null:En(t)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}};var ei=class{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,t){t==null?delete this.cache_[e]:this.cache_[e]=t}get(e){return se(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}};var la=function(n){try{if(typeof window<"u"&&typeof window[n]<"u"){let e=window[n];return e.setItem("firebase:sentinel","cache"),e.removeItem("firebase:sentinel"),new Zs(e)}}catch{}return new ei},We=la("localStorage"),ti=la("sessionStorage");var it=new bn("@firebase/database"),ca=function(){let n=1;return function(){return n++}}(),ua=function(n){let e=wo(n),t=new vo;t.update(e);let s=t.digest();return uo.encodeByteArray(s)},Zt=function(...n){let e="";for(let t=0;t<n.length;t++){let s=n[t];Array.isArray(s)||s&&typeof s=="object"&&typeof s.length=="number"?e+=Zt.apply(null,s):typeof s=="object"?e+=M(s):e+=s,e+=" "}return e},He=null,xo=!0,ha=function(n,e){_(!e||n===!0||n===!1,"Can't turn on custom loggers persistently."),n===!0?(it.logLevel=Eo.VERBOSE,He=it.log.bind(it),e&&ti.set("logging_enabled",!0)):typeof n=="function"?He=n:(He=null,ti.remove("logging_enabled"))},W=function(...n){if(xo===!0&&(xo=!1,He===null&&ti.get("logging_enabled")===!0&&ha(!0)),He){let e=Zt.apply(null,n);He(e)}},en=function(n){return function(...e){W(n,...e)}},ni=function(...n){let e="FIREBASE INTERNAL ERROR: "+Zt(...n);it.error(e)},ge=function(...n){let e=`FIREBASE FATAL ERROR: ${Zt(...n)}`;throw it.error(e),new Error(e)},q=function(...n){let e="FIREBASE WARNING: "+Zt(...n);it.warn(e)},Uc=function(){typeof window<"u"&&window.location&&window.location.protocol&&window.location.protocol.indexOf("https:")!==-1&&q("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().")},cs=function(n){return typeof n=="number"&&(n!==n||n===Number.POSITIVE_INFINITY||n===Number.NEGATIVE_INFINITY)},Bc=function(n){if(ue()||document.readyState==="complete")n();else{let e=!1,t=function(){if(!document.body){setTimeout(t,Math.floor(10));return}e||(e=!0,n())};document.addEventListener?(document.addEventListener("DOMContentLoaded",t,!1),window.addEventListener("load",t,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{document.readyState==="complete"&&t()}),window.attachEvent("onload",t))}},Ae="[MIN_NAME]",Te="[MAX_NAME]",qe=function(n,e){if(n===e)return 0;if(n===Ae||e===Te)return-1;if(e===Ae||n===Te)return 1;{let t=Oo(n),s=Oo(e);return t!==null?s!==null?t-s===0?n.length-e.length:t-s:-1:s!==null?1:n<e?-1:1}},Wc=function(n,e){return n===e?0:n<e?-1:1},At=function(n,e){if(e&&n in e)return e[n];throw new Error("Missing required key ("+n+") in object: "+M(e))},rr=function(n){if(typeof n!="object"||n===null)return M(n);let e=[];for(let s in n)e.push(s);e.sort();let t="{";for(let s=0;s<e.length;s++)s!==0&&(t+=","),t+=M(e[s]),t+=":",t+=rr(n[e[s]]);return t+="}",t},da=function(n,e){let t=n.length;if(t<=e)return[n];let s=[];for(let i=0;i<t;i+=e)i+e>t?s.push(n.substring(i,t)):s.push(n.substring(i,i+e));return s};function H(n,e){for(let t in n)n.hasOwnProperty(t)&&e(t,n[t])}var fa=function(n){_(!cs(n),"Invalid JSON number");let e=11,t=52,s=(1<<e-1)-1,i,r,o,a,l;n===0?(r=0,o=0,i=1/n===-1/0?1:0):(i=n<0,n=Math.abs(n),n>=Math.pow(2,1-s)?(a=Math.min(Math.floor(Math.log(n)/Math.LN2),s),r=a+s,o=Math.round(n*Math.pow(2,t-a)-Math.pow(2,t))):(r=0,o=Math.round(n/Math.pow(2,1-s-t))));let c=[];for(l=t;l;l-=1)c.push(o%2?1:0),o=Math.floor(o/2);for(l=e;l;l-=1)c.push(r%2?1:0),r=Math.floor(r/2);c.push(i?1:0),c.reverse();let u=c.join(""),h="";for(l=0;l<64;l+=8){let d=parseInt(u.substr(l,8),2).toString(16);d.length===1&&(d="0"+d),h=h+d}return h.toLowerCase()},Hc=function(){return!!(typeof window=="object"&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))},jc=function(){return typeof Windows=="object"&&typeof Windows.UI=="object"};function qc(n,e){let t="Unknown Error";n==="too_big"?t="The data requested exceeds the maximum size that can be accessed with a single request.":n==="permission_denied"?t="Client doesn't have permission to access the desired data.":n==="unavailable"&&(t="The service is unavailable");let s=new Error(n+" at "+e._path.toString()+": "+t);return s.code=n.toUpperCase(),s}var Vc=new RegExp("^-?(0*)\\d{1,10}$"),Gc=-2147483648,$c=2147483647,Oo=function(n){if(Vc.test(n)){let e=Number(n);if(e>=Gc&&e<=$c)return e}return null},ft=function(n){try{n()}catch(e){setTimeout(()=>{let t=e.stack||"";throw q("Exception was thrown by user callback.",t),e},Math.floor(0))}},zc=function(){return(typeof window=="object"&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},Dt=function(n,e){let t=setTimeout(n,e);return typeof t=="number"&&typeof Deno<"u"&&Deno.unrefTimer?Deno.unrefTimer(t):typeof t=="object"&&t.unref&&t.unref(),t};var si=class{constructor(e,t){this.appName_=e,this.appCheckProvider=t,this.appCheck=t?.getImmediate({optional:!0}),this.appCheck||t?.get().then(s=>this.appCheck=s)}getToken(e){return this.appCheck?this.appCheck.getToken(e):new Promise((t,s)=>{setTimeout(()=>{this.appCheck?this.getToken(e).then(t,s):t(null)},0)})}addTokenChangeListener(e){var t;(t=this.appCheckProvider)===null||t===void 0||t.get().then(s=>s.addTokenListener(e))}notifyForInvalidToken(){q(`Provided AppCheck credentials for the app named "${this.appName_}" are invalid. This usually indicates your app was not initialized correctly.`)}};var ii=class{constructor(e,t,s){this.appName_=e,this.firebaseOptions_=t,this.authProvider_=s,this.auth_=null,this.auth_=s.getImmediate({optional:!0}),this.auth_||s.onInit(i=>this.auth_=i)}getToken(e){return this.auth_?this.auth_.getToken(e).catch(t=>t&&t.code==="auth/token-not-initialized"?(W("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(t)):new Promise((t,s)=>{setTimeout(()=>{this.auth_?this.getToken(e).then(t,s):t(null)},0)})}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then(t=>t.addAuthTokenListener(e))}removeTokenChangeListener(e){this.authProvider_.get().then(t=>t.removeAuthTokenListener(e))}notifyForInvalidToken(){let e='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?e+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?e+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':e+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',q(e)}},Lt=(()=>{class n{constructor(t){this.accessToken=t}getToken(t){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(t){t(this.accessToken)}removeTokenChangeListener(t){}notifyForInvalidToken(){}}n.OWNER="owner";return n})(),Fn="5",_a="v",pa="s",ga="r",ma="f",ya=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,va="ls",wa="p",ri="ac",Ea="websocket",Ca="long_polling";var Un=class{constructor(e,t,s,i,r=!1,o="",a=!1,l=!1){this.secure=t,this.namespace=s,this.webSocketOnly=i,this.nodeAdmin=r,this.persistenceKey=o,this.includeNamespaceInQueryParams=a,this.isUsingEmulator=l,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=We.get("host:"+e)||this._host}isCacheableHost(){return this.internalHost.substr(0,2)==="s-"}isCustomHost(){return this._domain!=="firebaseio.com"&&this._domain!=="firebaseio-demo.com"}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&We.set("host:"+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e}toURLString(){let e=this.secure?"https://":"http://",t=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${e}${this.host}/${t}`}};function Kc(n){return n.host!==n.internalHost||n.isCustomHost()||n.includeNamespaceInQueryParams}function Ta(n,e,t){_(typeof e=="string","typeof type must == string"),_(typeof t=="object","typeof params must == object");let s;if(e===Ea)s=(n.secure?"wss://":"ws://")+n.internalHost+"/.ws?";else if(e===Ca)s=(n.secure?"https://":"http://")+n.internalHost+"/.lp?";else throw new Error("Unknown connection type: "+e);Kc(n)&&(t.ns=n.namespace);let i=[];return H(t,(r,o)=>{i.push(r+"="+o)}),s+i.join("&")}var oi=class{constructor(){this.counters_={}}incrementCounter(e,t=1){se(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t}get(){return fo(this.counters_)}};var $s={},zs={};function or(n){let e=n.toString();return $s[e]||($s[e]=new oi),$s[e]}function Qc(n,e){let t=n.toString();return zs[t]||(zs[t]=e()),zs[t]}var ai=class{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,t){for(this.pendingResponses[e]=t;this.pendingResponses[this.currentResponseNum];){let s=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let i=0;i<s.length;++i)s[i]&&ft(()=>{this.onMessage_(s[i])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}};var Do="start",Yc="close",Xc="pLPCommand",Jc="pRTLPCB",ba="id",Ia="pw",Ra="ser",Zc="cb",eu="seg",tu="ts",nu="d",su="dframe",Sa=1870,ka=30,iu=Sa-ka,ru=25e3,ou=3e4,Bt=class n{constructor(e,t,s,i,r,o,a){this.connId=e,this.repoInfo=t,this.applicationId=s,this.appCheckToken=i,this.authToken=r,this.transportSessionId=o,this.lastSessionId=a,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=en(e),this.stats_=or(t),this.urlFn=l=>(this.appCheckToken&&(l[ri]=this.appCheckToken),Ta(t,Ca,l))}open(e,t){this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new ai(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(ou)),Bc(()=>{if(this.isClosed_)return;this.scriptTagHolder=new li((...r)=>{let[o,a,l,c,u]=r;if(this.incrementIncomingBytes_(r),!!this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,o===Do)this.id=a,this.password=l;else if(o===Yc)a?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(a,()=>{this.onClosed_()})):this.onClosed_();else throw new Error("Unrecognized command received: "+o)},(...r)=>{let[o,a]=r;this.incrementIncomingBytes_(r),this.myPacketOrderer.handleResponse(o,a)},()=>{this.onClosed_()},this.urlFn);let s={};s[Do]="t",s[Ra]=Math.floor(Math.random()*1e8),this.scriptTagHolder.uniqueCallbackIdentifier&&(s[Zc]=this.scriptTagHolder.uniqueCallbackIdentifier),s[_a]=Fn,this.transportSessionId&&(s[pa]=this.transportSessionId),this.lastSessionId&&(s[va]=this.lastSessionId),this.applicationId&&(s[wa]=this.applicationId),this.appCheckToken&&(s[ri]=this.appCheckToken),typeof location<"u"&&location.hostname&&ya.test(location.hostname)&&(s[ga]=ma);let i=this.urlFn(s);this.log_("Connecting via long-poll to "+i),this.scriptTagHolder.addTag(i,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){n.forceAllow_=!0}static forceDisallow(){n.forceDisallow_=!0}static isAvailable(){return ue()?!1:n.forceAllow_?!0:!n.forceDisallow_&&typeof document<"u"&&document.createElement!=null&&!Hc()&&!jc()}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(e){let t=M(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);let s=ho(t),i=da(s,iu);for(let r=0;r<i.length;r++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,i.length,i[r]),this.curSegmentNum++}addDisconnectPingFrame(e,t){if(ue())return;this.myDisconnFrame=document.createElement("iframe");let s={};s[su]="t",s[ba]=e,s[Ia]=t,this.myDisconnFrame.src=this.urlFn(s),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){let t=M(e).length;this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)}},li=class n{constructor(e,t,s,i){if(this.onDisconnect=s,this.urlFn=i,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(Math.random()*1e8),this.sendNewPolls=!0,ue())this.commandCB=e,this.onMessageCB=t;else{this.uniqueCallbackIdentifier=ca(),window[Xc+this.uniqueCallbackIdentifier]=e,window[Jc+this.uniqueCallbackIdentifier]=t,this.myIFrame=n.createIFrame_();let r="";this.myIFrame.src&&this.myIFrame.src.substr(0,11)==="javascript:"&&(r='<script>document.domain="'+document.domain+'";<\/script>');let o="<html><body>"+r+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(o),this.myIFrame.doc.close()}catch(a){W("frame writing exception"),a.stack&&W(a.stack),W(a)}}}static createIFrame_(){let e=document.createElement("iframe");if(e.style.display="none",document.body){document.body.appendChild(e);try{e.contentWindow.document||W("No IE domain setting required")}catch{let s=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+s+"';document.close();})())"}}else throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout(()=>{this.myIFrame!==null&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));let e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;let e={};e[ba]=this.myID,e[Ia]=this.myPW,e[Ra]=this.currentSerial;let t=this.urlFn(e),s="",i=0;for(;this.pendingSegs.length>0&&this.pendingSegs[0].d.length+ka+s.length<=Sa;){let o=this.pendingSegs.shift();s=s+"&"+eu+i+"="+o.seg+"&"+tu+i+"="+o.ts+"&"+nu+i+"="+o.d,i++}return t=t+s,this.addLongPollTag_(t,this.currentSerial),!0}else return!1}enqueueSegment(e,t,s){this.pendingSegs.push({seg:e,ts:t,d:s}),this.alive&&this.newRequest_()}addLongPollTag_(e,t){this.outstandingRequests.add(t);let s=()=>{this.outstandingRequests.delete(t),this.newRequest_()},i=setTimeout(s,Math.floor(ru)),r=()=>{clearTimeout(i),s()};this.addTag(e,r)}addTag(e,t){ue()?this.doNodeLongPoll(e,t):setTimeout(()=>{try{if(!this.sendNewPolls)return;let s=this.myIFrame.doc.createElement("script");s.type="text/javascript",s.async=!0,s.src=e,s.onload=s.onreadystatechange=function(){let i=s.readyState;(!i||i==="loaded"||i==="complete")&&(s.onload=s.onreadystatechange=null,s.parentNode&&s.parentNode.removeChild(s),t())},s.onerror=()=>{W("Long-poll script failed to load: "+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(s)}catch{}},Math.floor(1))}};var au=16384,lu=45e3,Bn=null;typeof MozWebSocket<"u"?Bn=MozWebSocket:typeof WebSocket<"u"&&(Bn=WebSocket);var nt=(()=>{class n{constructor(t,s,i,r,o,a,l){this.connId=t,this.applicationId=i,this.appCheckToken=r,this.authToken=o,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=en(this.connId),this.stats_=or(s),this.connURL=n.connectionURL_(s,a,l,r,i),this.nodeAdmin=s.nodeAdmin}static connectionURL_(t,s,i,r,o){let a={};return a[_a]=Fn,!ue()&&typeof location<"u"&&location.hostname&&ya.test(location.hostname)&&(a[ga]=ma),s&&(a[pa]=s),i&&(a[va]=i),r&&(a[ri]=r),o&&(a[wa]=o),Ta(t,Ea,a)}open(t,s){this.onDisconnect=s,this.onMessage=t,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,We.set("previous_websocket_failure",!0);try{let i;if(ue()){let r=this.nodeAdmin?"AdminNode":"Node";i={headers:{"User-Agent":`Firebase/${Fn}/${sr}/${process.platform}/${r}`,"X-Firebase-GMPID":this.applicationId||""}},this.authToken&&(i.headers.Authorization=`Bearer ${this.authToken}`),this.appCheckToken&&(i.headers["X-Firebase-AppCheck"]=this.appCheckToken);let o=process.env,a=this.connURL.indexOf("wss://")===0?o.HTTPS_PROXY||o.https_proxy:o.HTTP_PROXY||o.http_proxy;a&&(i.proxy={origin:a})}this.mySock=new Bn(this.connURL,[],i)}catch(i){this.log_("Error instantiating WebSocket.");let r=i.message||i.data;r&&this.log_(r),this.onClosed_();return}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=i=>{this.handleIncomingFrame(i)},this.mySock.onerror=i=>{this.log_("WebSocket error.  Closing connection.");let r=i.message||i.data;r&&this.log_(r),this.onClosed_()}}start(){}static forceDisallow(){n.forceDisallow_=!0}static isAvailable(){let t=!1;if(typeof navigator<"u"&&navigator.userAgent){let s=/Android ([0-9]{0,}\.[0-9]{0,})/,i=navigator.userAgent.match(s);i&&i.length>1&&parseFloat(i[1])<4.4&&(t=!0)}return!t&&Bn!==null&&!n.forceDisallow_}static previouslyFailed(){return We.isInMemoryStorage||We.get("previous_websocket_failure")===!0}markConnectionHealthy(){We.remove("previous_websocket_failure")}appendFrame_(t){if(this.frames.push(t),this.frames.length===this.totalFrames){let s=this.frames.join("");this.frames=null;let i=En(s);this.onMessage(i)}}handleNewFrameCount_(t){this.totalFrames=t,this.frames=[]}extractFrameCount_(t){if(_(this.frames===null,"We already have a frame buffer"),t.length<=6){let s=Number(t);if(!isNaN(s))return this.handleNewFrameCount_(s),null}return this.handleNewFrameCount_(1),t}handleIncomingFrame(t){if(this.mySock===null)return;let s=t.data;if(this.bytesReceived+=s.length,this.stats_.incrementCounter("bytes_received",s.length),this.resetKeepAlive(),this.frames!==null)this.appendFrame_(s);else{let i=this.extractFrameCount_(s);i!==null&&this.appendFrame_(i)}}send(t){this.resetKeepAlive();let s=M(t);this.bytesSent+=s.length,this.stats_.incrementCounter("bytes_sent",s.length);let i=da(s,au);i.length>1&&this.sendString_(String(i.length));for(let r=0;r<i.length;r++)this.sendString_(i[r])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(lu))}sendString_(t){try{this.mySock.send(t)}catch(s){this.log_("Exception thrown from WebSocket.send():",s.message||s.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}n.responsesRequiredToBeHealthy=2,n.healthyTimeout=3e4;return n})(),Na=(()=>{class n{constructor(t){this.initTransports_(t)}static get ALL_TRANSPORTS(){return[Bt,nt]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}initTransports_(t){let s=nt&&nt.isAvailable(),i=s&&!nt.previouslyFailed();if(t.webSocketOnly&&(s||q("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),i=!0),i)this.transports_=[nt];else{let r=this.transports_=[];for(let o of n.ALL_TRANSPORTS)o&&o.isAvailable()&&r.push(o);n.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}n.globalTransportInitialized_=!1;return n})(),cu=6e4,uu=5e3,hu=10*1024,du=100*1024,Ks="t",Lo="d",fu="s",Mo="r",_u="e",Fo="o",Uo="a",Bo="n",Wo="p",pu="h",ci=class{constructor(e,t,s,i,r,o,a,l,c,u){this.id=e,this.repoInfo_=t,this.applicationId_=s,this.appCheckToken_=i,this.authToken_=r,this.onMessage_=o,this.onReady_=a,this.onDisconnect_=l,this.onKill_=c,this.lastSessionId=u,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=en("c:"+this.id+":"),this.transportManager_=new Na(t),this.log_("Connection created"),this.start_()}start_(){let e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let t=this.connReceiver_(this.conn_),s=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(t,s)},Math.floor(0));let i=e.healthyTimeout||0;i>0&&(this.healthyTimeout_=Dt(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>du?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>hu?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(i)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(e){return t=>{e===this.conn_?this.onConnectionLost_(t):e===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(e){return t=>{this.state_!==2&&(e===this.rx_?this.onPrimaryMessageReceived_(t):e===this.secondaryConn_?this.onSecondaryMessageReceived_(t):this.log_("message on old connection"))}}sendRequest(e){let t={t:"d",d:e};this.sendData_(t)}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if(Ks in e){let t=e[Ks];t===Uo?this.upgradeIfSecondaryHealthy_():t===Mo?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):t===Fo&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){let t=At("t",e),s=At("d",e);if(t==="c")this.onSecondaryControl_(s);else if(t==="d")this.pendingDataMessages.push(s);else throw new Error("Unknown protocol layer: "+t)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:Wo,d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:Uo,d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:Bo,d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){let t=At("t",e),s=At("d",e);t==="c"?this.onControl_(s):t==="d"&&this.onDataMessage_(s)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){let t=At(Ks,e);if(Lo in e){let s=e[Lo];if(t===pu){let i=Object.assign({},s);this.repoInfo_.isUsingEmulator&&(i.h=this.repoInfo_.host),this.onHandshake_(i)}else if(t===Bo){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let i=0;i<this.pendingDataMessages.length;++i)this.onDataMessage_(this.pendingDataMessages[i]);this.pendingDataMessages=[],this.tryCleanupConnection()}else t===fu?this.onConnectionShutdown_(s):t===Mo?this.onReset_(s):t===_u?ni("Server Error: "+s):t===Fo?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):ni("Unknown control packet command: "+t)}}onHandshake_(e){let t=e.ts,s=e.v,i=e.h;this.sessionId=e.s,this.repoInfo_.host=i,this.state_===0&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),Fn!==s&&q("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){let e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let t=this.connReceiver_(this.secondaryConn_),s=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(t,s),Dt(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor(cu))}onReset_(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.host=e,this.state_===1?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,t){this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(t,this.sessionId),this.onReady_=null),this.primaryResponsesRequired_===0?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):Dt(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(uu))}sendPingOnPrimaryIfNecessary_(){!this.isHealthy_&&this.state_===1&&(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:Wo,d:{}}}))}onSecondaryConnectionLost_(){let e=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===e||this.rx_===e)&&this.close()}onConnectionLost_(e){this.conn_=null,!e&&this.state_===0?(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(We.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)):this.state_===1&&this.log_("Realtime connection lost."),this.close()}onConnectionShutdown_(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(e){if(this.state_!==1)throw"Connection is not connected";this.tx_.send(e)}close(){this.state_!==2&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}};var Wn=class{put(e,t,s,i){}merge(e,t,s,i){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,t,s){}onDisconnectMerge(e,t,s){}onDisconnectCancel(e,t){}reportStats(e){}};var Hn=class{constructor(e){this.allowedEvents_=e,this.listeners_={},_(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}trigger(e,...t){if(Array.isArray(this.listeners_[e])){let s=[...this.listeners_[e]];for(let i=0;i<s.length;i++)s[i].callback.apply(s[i].context,t)}}on(e,t,s){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:s});let i=this.getInitialEvent(e);i&&t.apply(s,i)}off(e,t,s){this.validateEventType_(e);let i=this.listeners_[e]||[];for(let r=0;r<i.length;r++)if(i[r].callback===t&&(!s||s===i[r].context)){i.splice(r,1);return}}validateEventType_(e){_(this.allowedEvents_.find(t=>t===e),"Unknown event: "+e)}};var jn=class n extends Hn{constructor(){super(["online"]),this.online_=!0,typeof window<"u"&&typeof window.addEventListener<"u"&&!js()&&(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}static getInstance(){return new n}getInitialEvent(e){return _(e==="online","Unknown event type: "+e),[this.online_]}currentlyOnline(){return this.online_}};var Ho=32,jo=768,I=class{constructor(e,t){if(t===void 0){this.pieces_=e.split("/");let s=0;for(let i=0;i<this.pieces_.length;i++)this.pieces_[i].length>0&&(this.pieces_[s]=this.pieces_[i],s++);this.pieces_.length=s,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}toString(){let e="";for(let t=this.pieceNum_;t<this.pieces_.length;t++)this.pieces_[t]!==""&&(e+="/"+this.pieces_[t]);return e||"/"}};function b(){return new I("")}function w(n){return n.pieceNum_>=n.pieces_.length?null:n.pieces_[n.pieceNum_]}function Pe(n){return n.pieces_.length-n.pieceNum_}function R(n){let e=n.pieceNum_;return e<n.pieces_.length&&e++,new I(n.pieces_,e)}function ar(n){return n.pieceNum_<n.pieces_.length?n.pieces_[n.pieces_.length-1]:null}function gu(n){let e="";for(let t=n.pieceNum_;t<n.pieces_.length;t++)n.pieces_[t]!==""&&(e+="/"+encodeURIComponent(String(n.pieces_[t])));return e||"/"}function Wt(n,e=0){return n.pieces_.slice(n.pieceNum_+e)}function Aa(n){if(n.pieceNum_>=n.pieces_.length)return null;let e=[];for(let t=n.pieceNum_;t<n.pieces_.length-1;t++)e.push(n.pieces_[t]);return new I(e,0)}function N(n,e){let t=[];for(let s=n.pieceNum_;s<n.pieces_.length;s++)t.push(n.pieces_[s]);if(e instanceof I)for(let s=e.pieceNum_;s<e.pieces_.length;s++)t.push(e.pieces_[s]);else{let s=e.split("/");for(let i=0;i<s.length;i++)s[i].length>0&&t.push(s[i])}return new I(t,0)}function E(n){return n.pieceNum_>=n.pieces_.length}function z(n,e){let t=w(n),s=w(e);if(t===null)return e;if(t===s)return z(R(n),R(e));throw new Error("INTERNAL ERROR: innerPath ("+e+") is not within outerPath ("+n+")")}function mu(n,e){let t=Wt(n,0),s=Wt(e,0);for(let i=0;i<t.length&&i<s.length;i++){let r=qe(t[i],s[i]);if(r!==0)return r}return t.length===s.length?0:t.length<s.length?-1:1}function lr(n,e){if(Pe(n)!==Pe(e))return!1;for(let t=n.pieceNum_,s=e.pieceNum_;t<=n.pieces_.length;t++,s++)if(n.pieces_[t]!==e.pieces_[s])return!1;return!0}function ie(n,e){let t=n.pieceNum_,s=e.pieceNum_;if(Pe(n)>Pe(e))return!1;for(;t<n.pieces_.length;){if(n.pieces_[t]!==e.pieces_[s])return!1;++t,++s}return!0}var ui=class{constructor(e,t){this.errorPrefix_=t,this.parts_=Wt(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let s=0;s<this.parts_.length;s++)this.byteLength_+=Nt(this.parts_[s]);Pa(this)}};function yu(n,e){n.parts_.length>0&&(n.byteLength_+=1),n.parts_.push(e),n.byteLength_+=Nt(e),Pa(n)}function vu(n){let e=n.parts_.pop();n.byteLength_-=Nt(e),n.parts_.length>0&&(n.byteLength_-=1)}function Pa(n){if(n.byteLength_>jo)throw new Error(n.errorPrefix_+"has a key path longer than "+jo+" bytes ("+n.byteLength_+").");if(n.parts_.length>Ho)throw new Error(n.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+Ho+") or object contains a cycle "+Be(n))}function Be(n){return n.parts_.length===0?"":"in property '"+n.parts_.join(".")+"'"}var hi=class n extends Hn{constructor(){super(["visible"]);let e,t;typeof document<"u"&&typeof document.addEventListener<"u"&&(typeof document.hidden<"u"?(t="visibilitychange",e="hidden"):typeof document.mozHidden<"u"?(t="mozvisibilitychange",e="mozHidden"):typeof document.msHidden<"u"?(t="msvisibilitychange",e="msHidden"):typeof document.webkitHidden<"u"&&(t="webkitvisibilitychange",e="webkitHidden")),this.visible_=!0,t&&document.addEventListener(t,()=>{let s=!document[e];s!==this.visible_&&(this.visible_=s,this.trigger("visible",s))},!1)}static getInstance(){return new n}getInitialEvent(e){return _(e==="visible","Unknown event type: "+e),[this.visible_]}};var Pt=1e3,wu=60*5*1e3,qo=30*1e3,Eu=1.3,Cu=3e4,Tu="server_kill",Vo=3,cr=(()=>{class n extends Wn{constructor(t,s,i,r,o,a,l,c){if(super(),this.repoInfo_=t,this.applicationId_=s,this.onDataUpdate_=i,this.onConnectStatus_=r,this.onServerInfoUpdate_=o,this.authTokenProvider_=a,this.appCheckTokenProvider_=l,this.authOverride_=c,this.id=n.nextPersistentConnectionId_++,this.log_=en("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=Pt,this.maxReconnectDelay_=wu,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,c&&!ue())throw new Error("Auth override specified in options, but not supported on non Node.js platforms");hi.getInstance().on("visible",this.onVisible_,this),t.host.indexOf("fblocal")===-1&&jn.getInstance().on("online",this.onOnline_,this)}sendRequest(t,s,i){let r=++this.requestNumber_,o={r,a:t,b:s};this.log_(M(o)),_(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(o),i&&(this.requestCBHash_[r]=i)}get(t){this.initConnection_();let s=new $,r={action:"g",request:{p:t._path.toString(),q:t._queryObject},onComplete:a=>{let l=a.d;a.s==="ok"?s.resolve(l):s.reject(l)}};this.outstandingGets_.push(r),this.outstandingGetCount_++;let o=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(o),s.promise}listen(t,s,i,r){this.initConnection_();let o=t._queryIdentifier,a=t._path.toString();this.log_("Listen called for "+a+" "+o),this.listens.has(a)||this.listens.set(a,new Map),_(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"listen() called for non-default but complete query"),_(!this.listens.get(a).has(o),"listen() called twice for same path/queryId.");let l={onComplete:r,hashFn:s,query:t,tag:i};this.listens.get(a).set(o,l),this.connected_&&this.sendListen_(l)}sendGet_(t){let s=this.outstandingGets_[t];this.sendRequest("g",s.request,i=>{delete this.outstandingGets_[t],this.outstandingGetCount_--,this.outstandingGetCount_===0&&(this.outstandingGets_=[]),s.onComplete&&s.onComplete(i)})}sendListen_(t){let s=t.query,i=s._path.toString(),r=s._queryIdentifier;this.log_("Listen on "+i+" for "+r);let o={p:i},a="q";t.tag&&(o.q=s._queryObject,o.t=t.tag),o.h=t.hashFn(),this.sendRequest(a,o,l=>{let c=l.d,u=l.s;n.warnOnListenWarnings_(c,s),(this.listens.get(i)&&this.listens.get(i).get(r))===t&&(this.log_("listen response",l),u!=="ok"&&this.removeListen_(i,r),t.onComplete&&t.onComplete(u,c))})}static warnOnListenWarnings_(t,s){if(t&&typeof t=="object"&&se(t,"w")){let i=Re(t,"w");if(Array.isArray(i)&&~i.indexOf("no_index")){let r='".indexOn": "'+s._queryParams.getIndex().toString()+'"',o=s._path.toString();q(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${r} at ${o} to your security rules for better performance.`)}}}refreshAuthToken(t){this.authToken_=t,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(t)}reduceReconnectDelayIfAdminCredential_(t){(t&&t.length===40||mo(t))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=qo)}refreshAppCheckToken(t){this.appCheckToken_=t,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){let t=this.authToken_,s=go(t)?"auth":"gauth",i={cred:t};this.authOverride_===null?i.noauth=!0:typeof this.authOverride_=="object"&&(i.authvar=this.authOverride_),this.sendRequest(s,i,r=>{let o=r.s,a=r.d||"error";this.authToken_===t&&(o==="ok"?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(o,a))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},t=>{let s=t.s,i=t.d||"error";s==="ok"?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(s,i)})}unlisten(t,s){let i=t._path.toString(),r=t._queryIdentifier;this.log_("Unlisten called for "+i+" "+r),_(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(i,r)&&this.connected_&&this.sendUnlisten_(i,r,t._queryObject,s)}sendUnlisten_(t,s,i,r){this.log_("Unlisten on "+t+" for "+s);let o={p:t},a="n";r&&(o.q=i,o.t=r),this.sendRequest(a,o)}onDisconnectPut(t,s,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",t,s,i):this.onDisconnectRequestQueue_.push({pathString:t,action:"o",data:s,onComplete:i})}onDisconnectMerge(t,s,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",t,s,i):this.onDisconnectRequestQueue_.push({pathString:t,action:"om",data:s,onComplete:i})}onDisconnectCancel(t,s){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",t,null,s):this.onDisconnectRequestQueue_.push({pathString:t,action:"oc",data:null,onComplete:s})}sendOnDisconnect_(t,s,i,r){let o={p:s,d:i};this.log_("onDisconnect "+t,o),this.sendRequest(t,o,a=>{r&&setTimeout(()=>{r(a.s,a.d)},Math.floor(0))})}put(t,s,i,r){this.putInternal("p",t,s,i,r)}merge(t,s,i,r){this.putInternal("m",t,s,i,r)}putInternal(t,s,i,r,o){this.initConnection_();let a={p:s,d:i};o!==void 0&&(a.h=o),this.outstandingPuts_.push({action:t,request:a,onComplete:r}),this.outstandingPutCount_++;let l=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(l):this.log_("Buffering put: "+s)}sendPut_(t){let s=this.outstandingPuts_[t].action,i=this.outstandingPuts_[t].request,r=this.outstandingPuts_[t].onComplete;this.outstandingPuts_[t].queued=this.connected_,this.sendRequest(s,i,o=>{this.log_(s+" response",o),delete this.outstandingPuts_[t],this.outstandingPutCount_--,this.outstandingPutCount_===0&&(this.outstandingPuts_=[]),r&&r(o.s,o.d)})}reportStats(t){if(this.connected_){let s={c:t};this.log_("reportStats",s),this.sendRequest("s",s,i=>{if(i.s!=="ok"){let o=i.d;this.log_("reportStats","Error sending stats: "+o)}})}}onDataMessage_(t){if("r"in t){this.log_("from server: "+M(t));let s=t.r,i=this.requestCBHash_[s];i&&(delete this.requestCBHash_[s],i(t.b))}else{if("error"in t)throw"A server-side error has occurred: "+t.error;"a"in t&&this.onDataPush_(t.a,t.b)}}onDataPush_(t,s){this.log_("handleServerMessage",t,s),t==="d"?this.onDataUpdate_(s.p,s.d,!1,s.t):t==="m"?this.onDataUpdate_(s.p,s.d,!0,s.t):t==="c"?this.onListenRevoked_(s.p,s.q):t==="ac"?this.onAuthRevoked_(s.s,s.d):t==="apc"?this.onAppCheckRevoked_(s.s,s.d):t==="sd"?this.onSecurityDebugPacket_(s):ni("Unrecognized action received from server: "+M(t)+`
Are you using the latest client?`)}onReady_(t,s){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(t),this.lastSessionId=s,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(t){_(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(t))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(t){t&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=Pt,this.realtime_||this.scheduleConnect_(0)),this.visible_=t}onOnline_(t){t?(this.log_("Browser went online."),this.reconnectDelay_=Pt,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&(new Date().getTime()-this.lastConnectionEstablishedTime_>Cu&&(this.reconnectDelay_=Pt),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime());let t=new Date().getTime()-this.lastConnectionAttemptTime_,s=Math.max(0,this.reconnectDelay_-t);s=Math.random()*s,this.log_("Trying to reconnect in "+s+"ms"),this.scheduleConnect_(s),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,this.reconnectDelay_*Eu)}this.onConnectStatus_(!1)}establishConnection_(){return D(this,null,function*(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;let t=this.onDataMessage_.bind(this),s=this.onReady_.bind(this),i=this.onRealtimeDisconnect_.bind(this),r=this.id+":"+n.nextConnectionId_++,o=this.lastSessionId,a=!1,l=null,c=function(){l?l.close():(a=!0,i())},u=function(d){_(l,"sendRequest call when we're not connected not allowed."),l.sendRequest(d)};this.realtime_={close:c,sendRequest:u};let h=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{let[d,f]=yield Promise.all([this.authTokenProvider_.getToken(h),this.appCheckTokenProvider_.getToken(h)]);a?W("getToken() completed but was canceled"):(W("getToken() completed. Creating connection."),this.authToken_=d&&d.accessToken,this.appCheckToken_=f&&f.token,l=new ci(r,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,t,s,i,p=>{q(p+" ("+this.repoInfo_.toString()+")"),this.interrupt(Tu)},o))}catch(d){this.log_("Failed to get token: "+d),a||(this.repoInfo_.nodeAdmin&&q(d),c())}}})}interrupt(t){W("Interrupting connection for reason: "+t),this.interruptReasons_[t]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(t){W("Resuming connection for reason: "+t),delete this.interruptReasons_[t],Cn(this.interruptReasons_)&&(this.reconnectDelay_=Pt,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(t){let s=t-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:s})}cancelSentTransactions_(){for(let t=0;t<this.outstandingPuts_.length;t++){let s=this.outstandingPuts_[t];s&&"h"in s.request&&s.queued&&(s.onComplete&&s.onComplete("disconnect"),delete this.outstandingPuts_[t],this.outstandingPutCount_--)}this.outstandingPutCount_===0&&(this.outstandingPuts_=[])}onListenRevoked_(t,s){let i;s?i=s.map(o=>rr(o)).join("$"):i="default";let r=this.removeListen_(t,i);r&&r.onComplete&&r.onComplete("permission_denied")}removeListen_(t,s){let i=new I(t).toString(),r;if(this.listens.has(i)){let o=this.listens.get(i);r=o.get(s),o.delete(s),o.size===0&&this.listens.delete(i)}else r=void 0;return r}onAuthRevoked_(t,s){W("Auth token revoked: "+t+"/"+s),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),(t==="invalid_token"||t==="permission_denied")&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=Vo&&(this.reconnectDelay_=qo,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(t,s){W("App check token revoked: "+t+"/"+s),this.appCheckToken_=null,this.forceTokenRefresh_=!0,(t==="invalid_token"||t==="permission_denied")&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=Vo&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(t){this.securityDebugCallback_?this.securityDebugCallback_(t):"msg"in t&&console.log("FIREBASE: "+t.msg.replace(`
`,`
FIREBASE: `))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(let t of this.listens.values())for(let s of t.values())this.sendListen_(s);for(let t=0;t<this.outstandingPuts_.length;t++)this.outstandingPuts_[t]&&this.sendPut_(t);for(;this.onDisconnectRequestQueue_.length;){let t=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(t.action,t.pathString,t.data,t.onComplete)}for(let t=0;t<this.outstandingGets_.length;t++)this.outstandingGets_[t]&&this.sendGet_(t)}sendConnectStats_(){let t={},s="js";ue()&&(this.repoInfo_.nodeAdmin?s="admin_node":s="node"),t["sdk."+s+"."+sr.replace(/\./g,"-")]=1,js()?t["framework.cordova"]=1:_o()&&(t["framework.reactnative"]=1),this.reportStats(t)}shouldReconnect_(){let t=jn.getInstance().currentlyOnline();return Cn(this.interruptReasons_)&&t}}n.nextPersistentConnectionId_=0,n.nextConnectionId_=0;return n})(),C=class n{constructor(e,t){this.name=e,this.node=t}static Wrap(e,t){return new n(e,t)}};var rt=class{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,t){let s=new C(Ae,e),i=new C(Ae,t);return this.compare(s,i)!==0}minPost(){return C.MIN}};var Mn,qn=class extends rt{static get __EMPTY_NODE(){return Mn}static set __EMPTY_NODE(e){Mn=e}compare(e,t){return qe(e.name,t.name)}isDefinedOn(e){throw Ze("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(e,t){return!1}minPost(){return C.MIN}maxPost(){return new C(Te,Mn)}makePost(e,t){return _(typeof e=="string","KeyIndex indexValue must always be a string."),new C(e,Mn)}toString(){return".key"}},pe=new qn;var st=class{constructor(e,t,s,i,r=null){this.isReverse_=i,this.resultGenerator_=r,this.nodeStack_=[];let o=1;for(;!e.isEmpty();)if(e=e,o=t?s(e.key,t):1,i&&(o*=-1),o<0)this.isReverse_?e=e.left:e=e.right;else if(o===0){this.nodeStack_.push(e);break}else this.nodeStack_.push(e),this.isReverse_?e=e.right:e=e.left}getNext(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_.pop(),t;if(this.resultGenerator_?t=this.resultGenerator_(e.key,e.value):t={key:e.key,value:e.value},this.isReverse_)for(e=e.left;!e.isEmpty();)this.nodeStack_.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack_.push(e),e=e.left;return t}hasNext(){return this.nodeStack_.length>0}peek(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}},ae=(()=>{class n{constructor(t,s,i,r,o){this.key=t,this.value=s,this.color=i??n.RED,this.left=r??re.EMPTY_NODE,this.right=o??re.EMPTY_NODE}copy(t,s,i,r,o){return new n(t??this.key,s??this.value,i??this.color,r??this.left,o??this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||!!t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,s,i){let r=this,o=i(t,r.key);return o<0?r=r.copy(null,null,null,r.left.insert(t,s,i),null):o===0?r=r.copy(null,s,null,null,null):r=r.copy(null,null,null,null,r.right.insert(t,s,i)),r.fixUp_()}removeMin_(){if(this.left.isEmpty())return re.EMPTY_NODE;let t=this;return!t.left.isRed_()&&!t.left.left.isRed_()&&(t=t.moveRedLeft_()),t=t.copy(null,null,null,t.left.removeMin_(),null),t.fixUp_()}remove(t,s){let i,r;if(i=this,s(t,i.key)<0)!i.left.isEmpty()&&!i.left.isRed_()&&!i.left.left.isRed_()&&(i=i.moveRedLeft_()),i=i.copy(null,null,null,i.left.remove(t,s),null);else{if(i.left.isRed_()&&(i=i.rotateRight_()),!i.right.isEmpty()&&!i.right.isRed_()&&!i.right.left.isRed_()&&(i=i.moveRedRight_()),s(t,i.key)===0){if(i.right.isEmpty())return re.EMPTY_NODE;r=i.right.min_(),i=i.copy(r.key,r.value,null,null,i.right.removeMin_())}i=i.copy(null,null,null,null,i.right.remove(t,s))}return i.fixUp_()}isRed_(){return this.color}fixUp_(){let t=this;return t.right.isRed_()&&!t.left.isRed_()&&(t=t.rotateLeft_()),t.left.isRed_()&&t.left.left.isRed_()&&(t=t.rotateRight_()),t.left.isRed_()&&t.right.isRed_()&&(t=t.colorFlip_()),t}moveRedLeft_(){let t=this.colorFlip_();return t.right.left.isRed_()&&(t=t.copy(null,null,null,null,t.right.rotateRight_()),t=t.rotateLeft_(),t=t.colorFlip_()),t}moveRedRight_(){let t=this.colorFlip_();return t.left.left.isRed_()&&(t=t.rotateRight_(),t=t.colorFlip_()),t}rotateLeft_(){let t=this.copy(null,null,n.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight_(){let t=this.copy(null,null,n.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip_(){let t=this.left.copy(null,null,!this.left.color,null,null),s=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,s)}checkMaxDepth_(){let t=this.check_();return Math.pow(2,t)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");let t=this.left.check_();if(t!==this.right.check_())throw new Error("Black depths differ");return t+(this.isRed_()?0:1)}}return n.RED=!0,n.BLACK=!1,n})(),di=class{copy(e,t,s,i,r){return this}insert(e,t,s){return new ae(e,t,null)}remove(e,t){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}},re=class n{constructor(e,t=n.EMPTY_NODE){this.comparator_=e,this.root_=t}insert(e,t){return new n(this.comparator_,this.root_.insert(e,t,this.comparator_).copy(null,null,ae.BLACK,null,null))}remove(e){return new n(this.comparator_,this.root_.remove(e,this.comparator_).copy(null,null,ae.BLACK,null,null))}get(e){let t,s=this.root_;for(;!s.isEmpty();){if(t=this.comparator_(e,s.key),t===0)return s.value;t<0?s=s.left:t>0&&(s=s.right)}return null}getPredecessorKey(e){let t,s=this.root_,i=null;for(;!s.isEmpty();)if(t=this.comparator_(e,s.key),t===0){if(s.left.isEmpty())return i?i.key:null;for(s=s.left;!s.right.isEmpty();)s=s.right;return s.key}else t<0?s=s.left:t>0&&(i=s,s=s.right);throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new st(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,t){return new st(this.root_,e,this.comparator_,!1,t)}getReverseIteratorFrom(e,t){return new st(this.root_,e,this.comparator_,!0,t)}getReverseIterator(e){return new st(this.root_,null,this.comparator_,!0,e)}};re.EMPTY_NODE=new di;function bu(n,e){return qe(n.name,e.name)}function ur(n,e){return qe(n,e)}var fi;function Iu(n){fi=n}var xa=function(n){return typeof n=="number"?"number:"+fa(n):"string:"+n},Oa=function(n){if(n.isLeafNode()){let e=n.val();_(typeof e=="string"||typeof e=="number"||typeof e=="object"&&se(e,".sv"),"Priority must be a string or number.")}else _(n===fi||n.isEmpty(),"priority of unexpected type.");_(n===fi||n.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};var Go,ot=(()=>{class n{constructor(t,s=n.__childrenNodeConstructor.EMPTY_NODE){this.value_=t,this.priorityNode_=s,this.lazyHash_=null,_(this.value_!==void 0&&this.value_!==null,"LeafNode shouldn't be created with null/undefined value."),Oa(this.priorityNode_)}static set __childrenNodeConstructor(t){Go=t}static get __childrenNodeConstructor(){return Go}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(t){return new n(this.value_,t)}getImmediateChild(t){return t===".priority"?this.priorityNode_:n.__childrenNodeConstructor.EMPTY_NODE}getChild(t){return E(t)?this:w(t)===".priority"?this.priorityNode_:n.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(t,s){return null}updateImmediateChild(t,s){return t===".priority"?this.updatePriority(s):s.isEmpty()&&t!==".priority"?this:n.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(t,s).updatePriority(this.priorityNode_)}updateChild(t,s){let i=w(t);return i===null?s:s.isEmpty()&&i!==".priority"?this:(_(i!==".priority"||Pe(t)===1,".priority must be the last token in a path"),this.updateImmediateChild(i,n.__childrenNodeConstructor.EMPTY_NODE.updateChild(R(t),s)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(t,s){return!1}val(t){return t&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(this.lazyHash_===null){let t="";this.priorityNode_.isEmpty()||(t+="priority:"+xa(this.priorityNode_.val())+":");let s=typeof this.value_;t+=s+":",s==="number"?t+=fa(this.value_):t+=this.value_,this.lazyHash_=ua(t)}return this.lazyHash_}getValue(){return this.value_}compareTo(t){return t===n.__childrenNodeConstructor.EMPTY_NODE?1:t instanceof n.__childrenNodeConstructor?-1:(_(t.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(t))}compareToLeafNode_(t){let s=typeof t.value_,i=typeof this.value_,r=n.VALUE_TYPE_ORDER.indexOf(s),o=n.VALUE_TYPE_ORDER.indexOf(i);return _(r>=0,"Unknown leaf type: "+s),_(o>=0,"Unknown leaf type: "+i),r===o?i==="object"?0:this.value_<t.value_?-1:this.value_===t.value_?0:1:o-r}withIndex(){return this}isIndexed(){return!0}equals(t){if(t===this)return!0;if(t.isLeafNode()){let s=t;return this.value_===s.value_&&this.priorityNode_.equals(s.priorityNode_)}else return!1}}n.VALUE_TYPE_ORDER=["object","boolean","number","string"];return n})(),Da,La;function Ru(n){Da=n}function Su(n){La=n}var _i=class extends rt{compare(e,t){let s=e.node.getPriority(),i=t.node.getPriority(),r=s.compareTo(i);return r===0?qe(e.name,t.name):r}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,t){return!e.getPriority().equals(t.getPriority())}minPost(){return C.MIN}maxPost(){return new C(Te,new ot("[PRIORITY-POST]",La))}makePost(e,t){let s=Da(e);return new C(t,new ot("[PRIORITY-POST]",s))}toString(){return".priority"}},S=new _i;var ku=Math.log(2),pi=class{constructor(e){let t=r=>parseInt(Math.log(r)/ku,10),s=r=>parseInt(Array(r+1).join("1"),2);this.count=t(e+1),this.current_=this.count-1;let i=s(this.count);this.bits_=e+1&i}nextBitIsOne(){let e=!(this.bits_&1<<this.current_);return this.current_--,e}},Vn=function(n,e,t,s){n.sort(e);let i=function(l,c){let u=c-l,h,d;if(u===0)return null;if(u===1)return h=n[l],d=t?t(h):h,new ae(d,h.node,ae.BLACK,null,null);{let f=parseInt(u/2,10)+l,p=i(l,f),m=i(f+1,c);return h=n[f],d=t?t(h):h,new ae(d,h.node,ae.BLACK,p,m)}},r=function(l){let c=null,u=null,h=n.length,d=function(p,m){let v=h-p,L=h;h-=p;let F=i(v+1,L),P=n[v],U=t?t(P):P;f(new ae(U,P.node,m,null,F))},f=function(p){c?(c.left=p,c=p):(u=p,c=p)};for(let p=0;p<l.count;++p){let m=l.nextBitIsOne(),v=Math.pow(2,l.count-(p+1));m?d(v,ae.BLACK):(d(v,ae.BLACK),d(v,ae.RED))}return u},o=new pi(n.length),a=r(o);return new re(s||e,a)};var Qs,tt={},at=class n{constructor(e,t){this.indexes_=e,this.indexSet_=t}static get Default(){return _(tt&&S,"ChildrenNode.ts has not been loaded"),Qs=Qs||new n({".priority":tt},{".priority":S}),Qs}get(e){let t=Re(this.indexes_,e);if(!t)throw new Error("No index defined for "+e);return t instanceof re?t:null}hasIndex(e){return se(this.indexSet_,e.toString())}addIndex(e,t){_(e!==pe,"KeyIndex always exists and isn't meant to be added to the IndexMap.");let s=[],i=!1,r=t.getIterator(C.Wrap),o=r.getNext();for(;o;)i=i||e.isDefinedOn(o.node),s.push(o),o=r.getNext();let a;i?a=Vn(s,e.getCompare()):a=tt;let l=e.toString(),c=Object.assign({},this.indexSet_);c[l]=e;let u=Object.assign({},this.indexes_);return u[l]=a,new n(u,c)}addToIndexes(e,t){let s=kt(this.indexes_,(i,r)=>{let o=Re(this.indexSet_,r);if(_(o,"Missing index implementation for "+r),i===tt)if(o.isDefinedOn(e.node)){let a=[],l=t.getIterator(C.Wrap),c=l.getNext();for(;c;)c.name!==e.name&&a.push(c),c=l.getNext();return a.push(e),Vn(a,o.getCompare())}else return tt;else{let a=t.get(e.name),l=i;return a&&(l=l.remove(new C(e.name,a))),l.insert(e,e.node)}});return new n(s,this.indexSet_)}removeFromIndexes(e,t){let s=kt(this.indexes_,i=>{if(i===tt)return i;{let r=t.get(e.name);return r?i.remove(new C(e.name,r)):i}});return new n(s,this.indexSet_)}};var xt,y=(()=>{class n{constructor(t,s,i){this.children_=t,this.priorityNode_=s,this.indexMap_=i,this.lazyHash_=null,this.priorityNode_&&Oa(this.priorityNode_),this.children_.isEmpty()&&_(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}static get EMPTY_NODE(){return xt||(xt=new n(new re(ur),null,at.Default))}isLeafNode(){return!1}getPriority(){return this.priorityNode_||xt}updatePriority(t){return this.children_.isEmpty()?this:new n(this.children_,t,this.indexMap_)}getImmediateChild(t){if(t===".priority")return this.getPriority();{let s=this.children_.get(t);return s===null?xt:s}}getChild(t){let s=w(t);return s===null?this:this.getImmediateChild(s).getChild(R(t))}hasChild(t){return this.children_.get(t)!==null}updateImmediateChild(t,s){if(_(s,"We should always be passing snapshot nodes"),t===".priority")return this.updatePriority(s);{let i=new C(t,s),r,o;s.isEmpty()?(r=this.children_.remove(t),o=this.indexMap_.removeFromIndexes(i,this.children_)):(r=this.children_.insert(t,s),o=this.indexMap_.addToIndexes(i,this.children_));let a=r.isEmpty()?xt:this.priorityNode_;return new n(r,a,o)}}updateChild(t,s){let i=w(t);if(i===null)return s;{_(w(t)!==".priority"||Pe(t)===1,".priority must be the last token in a path");let r=this.getImmediateChild(i).updateChild(R(t),s);return this.updateImmediateChild(i,r)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(t){if(this.isEmpty())return null;let s={},i=0,r=0,o=!0;if(this.forEachChild(S,(a,l)=>{s[a]=l.val(t),i++,o&&n.INTEGER_REGEXP_.test(a)?r=Math.max(r,Number(a)):o=!1}),!t&&o&&r<2*i){let a=[];for(let l in s)a[l]=s[l];return a}else return t&&!this.getPriority().isEmpty()&&(s[".priority"]=this.getPriority().val()),s}hash(){if(this.lazyHash_===null){let t="";this.getPriority().isEmpty()||(t+="priority:"+xa(this.getPriority().val())+":"),this.forEachChild(S,(s,i)=>{let r=i.hash();r!==""&&(t+=":"+s+":"+r)}),this.lazyHash_=t===""?"":ua(t)}return this.lazyHash_}getPredecessorChildName(t,s,i){let r=this.resolveIndex_(i);if(r){let o=r.getPredecessorKey(new C(t,s));return o?o.name:null}else return this.children_.getPredecessorKey(t)}getFirstChildName(t){let s=this.resolveIndex_(t);if(s){let i=s.minKey();return i&&i.name}else return this.children_.minKey()}getFirstChild(t){let s=this.getFirstChildName(t);return s?new C(s,this.children_.get(s)):null}getLastChildName(t){let s=this.resolveIndex_(t);if(s){let i=s.maxKey();return i&&i.name}else return this.children_.maxKey()}getLastChild(t){let s=this.getLastChildName(t);return s?new C(s,this.children_.get(s)):null}forEachChild(t,s){let i=this.resolveIndex_(t);return i?i.inorderTraversal(r=>s(r.name,r.node)):this.children_.inorderTraversal(s)}getIterator(t){return this.getIteratorFrom(t.minPost(),t)}getIteratorFrom(t,s){let i=this.resolveIndex_(s);if(i)return i.getIteratorFrom(t,r=>r);{let r=this.children_.getIteratorFrom(t.name,C.Wrap),o=r.peek();for(;o!=null&&s.compare(o,t)<0;)r.getNext(),o=r.peek();return r}}getReverseIterator(t){return this.getReverseIteratorFrom(t.maxPost(),t)}getReverseIteratorFrom(t,s){let i=this.resolveIndex_(s);if(i)return i.getReverseIteratorFrom(t,r=>r);{let r=this.children_.getReverseIteratorFrom(t.name,C.Wrap),o=r.peek();for(;o!=null&&s.compare(o,t)>0;)r.getNext(),o=r.peek();return r}}compareTo(t){return this.isEmpty()?t.isEmpty()?0:-1:t.isLeafNode()||t.isEmpty()?1:t===tn?-1:0}withIndex(t){if(t===pe||this.indexMap_.hasIndex(t))return this;{let s=this.indexMap_.addIndex(t,this.children_);return new n(this.children_,this.priorityNode_,s)}}isIndexed(t){return t===pe||this.indexMap_.hasIndex(t)}equals(t){if(t===this)return!0;if(t.isLeafNode())return!1;{let s=t;if(this.getPriority().equals(s.getPriority()))if(this.children_.count()===s.children_.count()){let i=this.getIterator(S),r=s.getIterator(S),o=i.getNext(),a=r.getNext();for(;o&&a;){if(o.name!==a.name||!o.node.equals(a.node))return!1;o=i.getNext(),a=r.getNext()}return o===null&&a===null}else return!1;else return!1}}resolveIndex_(t){return t===pe?null:this.indexMap_.get(t.toString())}}return n.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/,n})(),gi=class extends y{constructor(){super(new re(ur),y.EMPTY_NODE,at.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return y.EMPTY_NODE}isEmpty(){return!1}},tn=new gi;Object.defineProperties(C,{MIN:{value:new C(Ae,y.EMPTY_NODE)},MAX:{value:new C(Te,tn)}});qn.__EMPTY_NODE=y.EMPTY_NODE;ot.__childrenNodeConstructor=y;Iu(tn);Su(tn);var Nu=!0;function x(n,e=null){if(n===null)return y.EMPTY_NODE;if(typeof n=="object"&&".priority"in n&&(e=n[".priority"]),_(e===null||typeof e=="string"||typeof e=="number"||typeof e=="object"&&".sv"in e,"Invalid priority type found: "+typeof e),typeof n=="object"&&".value"in n&&n[".value"]!==null&&(n=n[".value"]),typeof n!="object"||".sv"in n){let t=n;return new ot(t,x(e))}if(!(n instanceof Array)&&Nu){let t=[],s=!1;if(H(n,(o,a)=>{if(o.substring(0,1)!=="."){let l=x(a);l.isEmpty()||(s=s||!l.getPriority().isEmpty(),t.push(new C(o,l)))}}),t.length===0)return y.EMPTY_NODE;let r=Vn(t,bu,o=>o.name,ur);if(s){let o=Vn(t,S.getCompare());return new y(r,x(e),new at({".priority":o},{".priority":S}))}else return new y(r,x(e),at.Default)}else{let t=y.EMPTY_NODE;return H(n,(s,i)=>{if(se(n,s)&&s.substring(0,1)!=="."){let r=x(i);(r.isLeafNode()||!r.isEmpty())&&(t=t.updateImmediateChild(s,r))}}),t.updatePriority(x(e))}}Ru(x);var Ht=class extends rt{constructor(e){super(),this.indexPath_=e,_(!E(e)&&w(e)!==".priority","Can't create PathIndex with empty path or .priority key")}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,t){let s=this.extractChild(e.node),i=this.extractChild(t.node),r=s.compareTo(i);return r===0?qe(e.name,t.name):r}makePost(e,t){let s=x(e),i=y.EMPTY_NODE.updateChild(this.indexPath_,s);return new C(t,i)}maxPost(){let e=y.EMPTY_NODE.updateChild(this.indexPath_,tn);return new C(Te,e)}toString(){return Wt(this.indexPath_,0).join("/")}};var mi=class extends rt{compare(e,t){let s=e.node.compareTo(t.node);return s===0?qe(e.name,t.name):s}isDefinedOn(e){return!0}indexedValueChanged(e,t){return!e.equals(t)}minPost(){return C.MIN}maxPost(){return C.MAX}makePost(e,t){let s=x(e);return new C(t,s)}toString(){return".value"}},hr=new mi;function Ma(n){return{type:"value",snapshotNode:n}}function lt(n,e){return{type:"child_added",snapshotNode:e,childName:n}}function jt(n,e){return{type:"child_removed",snapshotNode:e,childName:n}}function qt(n,e,t){return{type:"child_changed",snapshotNode:e,childName:n,oldSnap:t}}function Au(n,e){return{type:"child_moved",snapshotNode:e,childName:n}}var Vt=class{constructor(e){this.index_=e}updateChild(e,t,s,i,r,o){_(e.isIndexed(this.index_),"A node must be indexed if only a child is updated");let a=e.getImmediateChild(t);return a.getChild(i).equals(s.getChild(i))&&a.isEmpty()===s.isEmpty()||(o!=null&&(s.isEmpty()?e.hasChild(t)?o.trackChildChange(jt(t,a)):_(e.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):a.isEmpty()?o.trackChildChange(lt(t,s)):o.trackChildChange(qt(t,s,a))),e.isLeafNode()&&s.isEmpty())?e:e.updateImmediateChild(t,s).withIndex(this.index_)}updateFullNode(e,t,s){return s!=null&&(e.isLeafNode()||e.forEachChild(S,(i,r)=>{t.hasChild(i)||s.trackChildChange(jt(i,r))}),t.isLeafNode()||t.forEachChild(S,(i,r)=>{if(e.hasChild(i)){let o=e.getImmediateChild(i);o.equals(r)||s.trackChildChange(qt(i,r,o))}else s.trackChildChange(lt(i,r))})),t.withIndex(this.index_)}updatePriority(e,t){return e.isEmpty()?y.EMPTY_NODE:e.updatePriority(t)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}};var Gn=class n{constructor(e){this.indexedFilter_=new Vt(e.getIndex()),this.index_=e.getIndex(),this.startPost_=n.getStartPost_(e),this.endPost_=n.getEndPost_(e),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(e){let t=this.startIsInclusive_?this.index_.compare(this.getStartPost(),e)<=0:this.index_.compare(this.getStartPost(),e)<0,s=this.endIsInclusive_?this.index_.compare(e,this.getEndPost())<=0:this.index_.compare(e,this.getEndPost())<0;return t&&s}updateChild(e,t,s,i,r,o){return this.matches(new C(t,s))||(s=y.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,s,i,r,o)}updateFullNode(e,t,s){t.isLeafNode()&&(t=y.EMPTY_NODE);let i=t.withIndex(this.index_);i=i.updatePriority(y.EMPTY_NODE);let r=this;return t.forEachChild(S,(o,a)=>{r.matches(new C(o,a))||(i=i.updateImmediateChild(o,y.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(e,i,s)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(e){if(e.hasStart()){let t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}else return e.getIndex().minPost()}static getEndPost_(e){if(e.hasEnd()){let t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}else return e.getIndex().maxPost()}};var yi=class{constructor(e){this.withinDirectionalStart=t=>this.reverse_?this.withinEndPost(t):this.withinStartPost(t),this.withinDirectionalEnd=t=>this.reverse_?this.withinStartPost(t):this.withinEndPost(t),this.withinStartPost=t=>{let s=this.index_.compare(this.rangedFilter_.getStartPost(),t);return this.startIsInclusive_?s<=0:s<0},this.withinEndPost=t=>{let s=this.index_.compare(t,this.rangedFilter_.getEndPost());return this.endIsInclusive_?s<=0:s<0},this.rangedFilter_=new Gn(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft(),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}updateChild(e,t,s,i,r,o){return this.rangedFilter_.matches(new C(t,s))||(s=y.EMPTY_NODE),e.getImmediateChild(t).equals(s)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,s,i,r,o):this.fullLimitUpdateChild_(e,t,s,r,o)}updateFullNode(e,t,s){let i;if(t.isLeafNode()||t.isEmpty())i=y.EMPTY_NODE.withIndex(this.index_);else if(this.limit_*2<t.numChildren()&&t.isIndexed(this.index_)){i=y.EMPTY_NODE.withIndex(this.index_);let r;this.reverse_?r=t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):r=t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let o=0;for(;r.hasNext()&&o<this.limit_;){let a=r.getNext();if(this.withinDirectionalStart(a))if(this.withinDirectionalEnd(a))i=i.updateImmediateChild(a.name,a.node),o++;else break;else continue}}else{i=t.withIndex(this.index_),i=i.updatePriority(y.EMPTY_NODE);let r;this.reverse_?r=i.getReverseIterator(this.index_):r=i.getIterator(this.index_);let o=0;for(;r.hasNext();){let a=r.getNext();o<this.limit_&&this.withinDirectionalStart(a)&&this.withinDirectionalEnd(a)?o++:i=i.updateImmediateChild(a.name,y.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,i,s)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(e,t,s,i,r){let o;if(this.reverse_){let h=this.index_.getCompare();o=(d,f)=>h(f,d)}else o=this.index_.getCompare();let a=e;_(a.numChildren()===this.limit_,"");let l=new C(t,s),c=this.reverse_?a.getFirstChild(this.index_):a.getLastChild(this.index_),u=this.rangedFilter_.matches(l);if(a.hasChild(t)){let h=a.getImmediateChild(t),d=i.getChildAfterChild(this.index_,c,this.reverse_);for(;d!=null&&(d.name===t||a.hasChild(d.name));)d=i.getChildAfterChild(this.index_,d,this.reverse_);let f=d==null?1:o(d,l);if(u&&!s.isEmpty()&&f>=0)return r?.trackChildChange(qt(t,s,h)),a.updateImmediateChild(t,s);{r?.trackChildChange(jt(t,h));let m=a.updateImmediateChild(t,y.EMPTY_NODE);return d!=null&&this.rangedFilter_.matches(d)?(r?.trackChildChange(lt(d.name,d.node)),m.updateImmediateChild(d.name,d.node)):m}}else return s.isEmpty()?e:u&&o(c,l)>=0?(r!=null&&(r.trackChildChange(jt(c.name,c.node)),r.trackChildChange(lt(t,s))),a.updateImmediateChild(t,s).updateImmediateChild(c.name,y.EMPTY_NODE)):e}};var Gt=class n{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=S}hasStart(){return this.startSet_}isViewFromLeft(){return this.viewFrom_===""?this.startSet_:this.viewFrom_==="l"}getIndexStartValue(){return _(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return _(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:Ae}hasEnd(){return this.endSet_}getIndexEndValue(){return _(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return _(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:Te}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&this.viewFrom_!==""}getLimit(){return _(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===S}copy(){let e=new n;return e.limitSet_=this.limitSet_,e.limit_=this.limit_,e.startSet_=this.startSet_,e.startAfterSet_=this.startAfterSet_,e.indexStartValue_=this.indexStartValue_,e.startNameSet_=this.startNameSet_,e.indexStartName_=this.indexStartName_,e.endSet_=this.endSet_,e.endBeforeSet_=this.endBeforeSet_,e.indexEndValue_=this.indexEndValue_,e.endNameSet_=this.endNameSet_,e.indexEndName_=this.indexEndName_,e.index_=this.index_,e.viewFrom_=this.viewFrom_,e}};function Pu(n){return n.loadsAllData()?new Vt(n.getIndex()):n.hasLimit()?new yi(n):new Gn(n)}function xu(n,e){let t=n.copy();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="l",t}function Ou(n,e){let t=n.copy();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="r",t}function vi(n,e,t){let s=n.copy();return s.startSet_=!0,e===void 0&&(e=null),s.indexStartValue_=e,t!=null?(s.startNameSet_=!0,s.indexStartName_=t):(s.startNameSet_=!1,s.indexStartName_=""),s}function Du(n,e,t){let s;return n.index_===pe||t?s=vi(n,e,t):s=vi(n,e,Te),s.startAfterSet_=!0,s}function wi(n,e,t){let s=n.copy();return s.endSet_=!0,e===void 0&&(e=null),s.indexEndValue_=e,t!==void 0?(s.endNameSet_=!0,s.indexEndName_=t):(s.endNameSet_=!1,s.indexEndName_=""),s}function Lu(n,e,t){let s;return n.index_===pe||t?s=wi(n,e,t):s=wi(n,e,Ae),s.endBeforeSet_=!0,s}function us(n,e){let t=n.copy();return t.index_=e,t}function $o(n){let e={};if(n.isDefault())return e;let t;if(n.index_===S?t="$priority":n.index_===hr?t="$value":n.index_===pe?t="$key":(_(n.index_ instanceof Ht,"Unrecognized index type!"),t=n.index_.toString()),e.orderBy=M(t),n.startSet_){let s=n.startAfterSet_?"startAfter":"startAt";e[s]=M(n.indexStartValue_),n.startNameSet_&&(e[s]+=","+M(n.indexStartName_))}if(n.endSet_){let s=n.endBeforeSet_?"endBefore":"endAt";e[s]=M(n.indexEndValue_),n.endNameSet_&&(e[s]+=","+M(n.indexEndName_))}return n.limitSet_&&(n.isViewFromLeft()?e.limitToFirst=n.limit_:e.limitToLast=n.limit_),e}function zo(n){let e={};if(n.startSet_&&(e.sp=n.indexStartValue_,n.startNameSet_&&(e.sn=n.indexStartName_),e.sin=!n.startAfterSet_),n.endSet_&&(e.ep=n.indexEndValue_,n.endNameSet_&&(e.en=n.indexEndName_),e.ein=!n.endBeforeSet_),n.limitSet_){e.l=n.limit_;let t=n.viewFrom_;t===""&&(n.isViewFromLeft()?t="l":t="r"),e.vf=t}return n.index_!==S&&(e.i=n.index_.toString()),e}var Ei=class n extends Wn{constructor(e,t,s,i){super(),this.repoInfo_=e,this.onDataUpdate_=t,this.authTokenProvider_=s,this.appCheckTokenProvider_=i,this.log_=en("p:rest:"),this.listens_={}}reportStats(e){throw new Error("Method not implemented.")}static getListenId_(e,t){return t!==void 0?"tag$"+t:(_(e._queryParams.isDefault(),"should have a tag if it's not a default query."),e._path.toString())}listen(e,t,s,i){let r=e._path.toString();this.log_("Listen called for "+r+" "+e._queryIdentifier);let o=n.getListenId_(e,s),a={};this.listens_[o]=a;let l=$o(e._queryParams);this.restRequest_(r+".json",l,(c,u)=>{let h=u;if(c===404&&(h=null,c=null),c===null&&this.onDataUpdate_(r,h,!1,s),Re(this.listens_,o)===a){let d;c?c===401?d="permission_denied":d="rest_error:"+c:d="ok",i(d,null)}})}unlisten(e,t){let s=n.getListenId_(e,t);delete this.listens_[s]}get(e){let t=$o(e._queryParams),s=e._path.toString(),i=new $;return this.restRequest_(s+".json",t,(r,o)=>{let a=o;r===404&&(a=null,r=null),r===null?(this.onDataUpdate_(s,a,!1,null),i.resolve(a)):i.reject(new Error(a))}),i.promise}refreshAuthToken(e){}restRequest_(e,t={},s){return t.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([i,r])=>{i&&i.accessToken&&(t.auth=i.accessToken),r&&r.token&&(t.ac=r.token);let o=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+e+"?ns="+this.repoInfo_.namespace+yo(t);this.log_("Sending REST request for "+o);let a=new XMLHttpRequest;a.onreadystatechange=()=>{if(s&&a.readyState===4){this.log_("REST Response for "+o+" received. status:",a.status,"response:",a.responseText);let l=null;if(a.status>=200&&a.status<300){try{l=En(a.responseText)}catch{q("Failed to parse JSON response for "+o+": "+a.responseText)}s(null,l)}else a.status!==401&&a.status!==404&&q("Got unsuccessful REST response for "+o+" Status: "+a.status),s(a.status);s=null}},a.open("GET",o,!0),a.send()})}};var Ci=class{constructor(){this.rootNode_=y.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)}};function $n(){return{value:null,children:new Map}}function _t(n,e,t){if(E(e))n.value=t,n.children.clear();else if(n.value!==null)n.value=n.value.updateChild(e,t);else{let s=w(e);n.children.has(s)||n.children.set(s,$n());let i=n.children.get(s);e=R(e),_t(i,e,t)}}function Ti(n,e){if(E(e))return n.value=null,n.children.clear(),!0;if(n.value!==null){if(n.value.isLeafNode())return!1;{let t=n.value;return n.value=null,t.forEachChild(S,(s,i)=>{_t(n,new I(s),i)}),Ti(n,e)}}else if(n.children.size>0){let t=w(e);return e=R(e),n.children.has(t)&&Ti(n.children.get(t),e)&&n.children.delete(t),n.children.size===0}else return!0}function bi(n,e,t){n.value!==null?t(e,n.value):Mu(n,(s,i)=>{let r=new I(e.toString()+"/"+s);bi(i,r,t)})}function Mu(n,e){n.children.forEach((t,s)=>{e(s,t)})}var Ii=class{constructor(e){this.collection_=e,this.last_=null}get(){let e=this.collection_.get(),t=Object.assign({},e);return this.last_&&H(this.last_,(s,i)=>{t[s]=t[s]-i}),this.last_=e,t}};var Ko=10*1e3,Fu=30*1e3,Uu=5*60*1e3,Ri=class{constructor(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new Ii(e);let s=Ko+(Fu-Ko)*Math.random();Dt(this.reportStats_.bind(this),Math.floor(s))}reportStats_(){let e=this.statsListener_.get(),t={},s=!1;H(e,(i,r)=>{r>0&&se(this.statsToReport_,i)&&(t[i]=r,s=!0)}),s&&this.server_.reportStats(t),Dt(this.reportStats_.bind(this),Math.floor(Math.random()*2*Uu))}};var _e=function(n){return n[n.OVERWRITE=0]="OVERWRITE",n[n.MERGE=1]="MERGE",n[n.ACK_USER_WRITE=2]="ACK_USER_WRITE",n[n.LISTEN_COMPLETE=3]="LISTEN_COMPLETE",n}(_e||{});function dr(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function fr(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function _r(n){return{fromUser:!1,fromServer:!0,queryId:n,tagged:!0}}var Si=class n{constructor(e,t,s){this.path=e,this.affectedTree=t,this.revert=s,this.type=_e.ACK_USER_WRITE,this.source=dr()}operationForChild(e){if(E(this.path)){if(this.affectedTree.value!=null)return _(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{let t=this.affectedTree.subtree(new I(e));return new n(b(),t,this.revert)}}else return _(w(this.path)===e,"operationForChild called for unrelated child."),new n(R(this.path),this.affectedTree,this.revert)}};var zn=class n{constructor(e,t){this.source=e,this.path=t,this.type=_e.LISTEN_COMPLETE}operationForChild(e){return E(this.path)?new n(this.source,b()):new n(this.source,R(this.path))}};var ct=class n{constructor(e,t,s){this.source=e,this.path=t,this.snap=s,this.type=_e.OVERWRITE}operationForChild(e){return E(this.path)?new n(this.source,b(),this.snap.getImmediateChild(e)):new n(this.source,R(this.path),this.snap)}};var $t=class n{constructor(e,t,s){this.source=e,this.path=t,this.children=s,this.type=_e.MERGE}operationForChild(e){if(E(this.path)){let t=this.children.subtree(new I(e));return t.isEmpty()?null:t.value?new ct(this.source,b(),t.value):new n(this.source,b(),t)}else return _(w(this.path)===e,"Can't get a merge for a child not on the path of the operation"),new n(this.source,R(this.path),this.children)}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}};var me=class{constructor(e,t,s){this.node_=e,this.fullyInitialized_=t,this.filtered_=s}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(E(e))return this.isFullyInitialized()&&!this.filtered_;let t=w(e);return this.isCompleteForChild(t)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}};var ki=class{constructor(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()}};function Bu(n,e,t,s){let i=[],r=[];return e.forEach(o=>{o.type==="child_changed"&&n.index_.indexedValueChanged(o.oldSnap,o.snapshotNode)&&r.push(Au(o.childName,o.snapshotNode))}),Ot(n,i,"child_removed",e,s,t),Ot(n,i,"child_added",e,s,t),Ot(n,i,"child_moved",r,s,t),Ot(n,i,"child_changed",e,s,t),Ot(n,i,"value",e,s,t),i}function Ot(n,e,t,s,i,r){let o=s.filter(a=>a.type===t);o.sort((a,l)=>Hu(n,a,l)),o.forEach(a=>{let l=Wu(n,a,r);i.forEach(c=>{c.respondsTo(a.type)&&e.push(c.createEvent(l,n.query_))})})}function Wu(n,e,t){return e.type==="value"||e.type==="child_removed"||(e.prevName=t.getPredecessorChildName(e.childName,e.snapshotNode,n.index_)),e}function Hu(n,e,t){if(e.childName==null||t.childName==null)throw Ze("Should only compare child_ events.");let s=new C(e.childName,e.snapshotNode),i=new C(t.childName,t.snapshotNode);return n.index_.compare(s,i)}function hs(n,e){return{eventCache:n,serverCache:e}}function Mt(n,e,t,s){return hs(new me(e,t,s),n.serverCache)}function Fa(n,e,t,s){return hs(n.eventCache,new me(e,t,s))}function Kn(n){return n.eventCache.isFullyInitialized()?n.eventCache.getNode():null}function je(n){return n.serverCache.isFullyInitialized()?n.serverCache.getNode():null}var Ys,ju=()=>(Ys||(Ys=new re(Wc)),Ys),K=class n{constructor(e,t=ju()){this.value=e,this.children=t}static fromObject(e){let t=new n(null);return H(e,(s,i)=>{t=t.set(new I(s),i)}),t}isEmpty(){return this.value===null&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,t){if(this.value!=null&&t(this.value))return{path:b(),value:this.value};if(E(e))return null;{let s=w(e),i=this.children.get(s);if(i!==null){let r=i.findRootMostMatchingPathAndValue(R(e),t);return r!=null?{path:N(new I(s),r.path),value:r.value}:null}else return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,()=>!0)}subtree(e){if(E(e))return this;{let t=w(e),s=this.children.get(t);return s!==null?s.subtree(R(e)):new n(null)}}set(e,t){if(E(e))return new n(t,this.children);{let s=w(e),r=(this.children.get(s)||new n(null)).set(R(e),t),o=this.children.insert(s,r);return new n(this.value,o)}}remove(e){if(E(e))return this.children.isEmpty()?new n(null):new n(null,this.children);{let t=w(e),s=this.children.get(t);if(s){let i=s.remove(R(e)),r;return i.isEmpty()?r=this.children.remove(t):r=this.children.insert(t,i),this.value===null&&r.isEmpty()?new n(null):new n(this.value,r)}else return this}}get(e){if(E(e))return this.value;{let t=w(e),s=this.children.get(t);return s?s.get(R(e)):null}}setTree(e,t){if(E(e))return t;{let s=w(e),r=(this.children.get(s)||new n(null)).setTree(R(e),t),o;return r.isEmpty()?o=this.children.remove(s):o=this.children.insert(s,r),new n(this.value,o)}}fold(e){return this.fold_(b(),e)}fold_(e,t){let s={};return this.children.inorderTraversal((i,r)=>{s[i]=r.fold_(N(e,i),t)}),t(e,this.value,s)}findOnPath(e,t){return this.findOnPath_(e,b(),t)}findOnPath_(e,t,s){let i=this.value?s(t,this.value):!1;if(i)return i;if(E(e))return null;{let r=w(e),o=this.children.get(r);return o?o.findOnPath_(R(e),N(t,r),s):null}}foreachOnPath(e,t){return this.foreachOnPath_(e,b(),t)}foreachOnPath_(e,t,s){if(E(e))return this;{this.value&&s(t,this.value);let i=w(e),r=this.children.get(i);return r?r.foreachOnPath_(R(e),N(t,i),s):new n(null)}}foreach(e){this.foreach_(b(),e)}foreach_(e,t){this.children.inorderTraversal((s,i)=>{i.foreach_(N(e,s),t)}),this.value&&t(e,this.value)}foreachChild(e){this.children.inorderTraversal((t,s)=>{s.value&&e(t,s.value)})}};var le=class n{constructor(e){this.writeTree_=e}static empty(){return new n(new K(null))}};function Ft(n,e,t){if(E(e))return new le(new K(t));{let s=n.writeTree_.findRootMostValueAndPath(e);if(s!=null){let i=s.path,r=s.value,o=z(i,e);return r=r.updateChild(o,t),new le(n.writeTree_.set(i,r))}else{let i=new K(t),r=n.writeTree_.setTree(e,i);return new le(r)}}}function Ni(n,e,t){let s=n;return H(t,(i,r)=>{s=Ft(s,N(e,i),r)}),s}function Qo(n,e){if(E(e))return le.empty();{let t=n.writeTree_.setTree(e,new K(null));return new le(t)}}function Ai(n,e){return Ve(n,e)!=null}function Ve(n,e){let t=n.writeTree_.findRootMostValueAndPath(e);return t!=null?n.writeTree_.get(t.path).getChild(z(t.path,e)):null}function Yo(n){let e=[],t=n.writeTree_.value;return t!=null?t.isLeafNode()||t.forEachChild(S,(s,i)=>{e.push(new C(s,i))}):n.writeTree_.children.inorderTraversal((s,i)=>{i.value!=null&&e.push(new C(s,i.value))}),e}function ke(n,e){if(E(e))return n;{let t=Ve(n,e);return t!=null?new le(new K(t)):new le(n.writeTree_.subtree(e))}}function Pi(n){return n.writeTree_.isEmpty()}function ut(n,e){return Ua(b(),n.writeTree_,e)}function Ua(n,e,t){if(e.value!=null)return t.updateChild(n,e.value);{let s=null;return e.children.inorderTraversal((i,r)=>{i===".priority"?(_(r.value!==null,"Priority writes must always be leaf nodes"),s=r.value):t=Ua(N(n,i),r,t)}),!t.getChild(n).isEmpty()&&s!==null&&(t=t.updateChild(N(n,".priority"),s)),t}}function ds(n,e){return ja(e,n)}function qu(n,e,t,s,i){_(s>n.lastWriteId,"Stacking an older write on top of newer ones"),i===void 0&&(i=!0),n.allWrites.push({path:e,snap:t,writeId:s,visible:i}),i&&(n.visibleWrites=Ft(n.visibleWrites,e,t)),n.lastWriteId=s}function Vu(n,e,t,s){_(s>n.lastWriteId,"Stacking an older merge on top of newer ones"),n.allWrites.push({path:e,children:t,writeId:s,visible:!0}),n.visibleWrites=Ni(n.visibleWrites,e,t),n.lastWriteId=s}function Gu(n,e){for(let t=0;t<n.allWrites.length;t++){let s=n.allWrites[t];if(s.writeId===e)return s}return null}function $u(n,e){let t=n.allWrites.findIndex(a=>a.writeId===e);_(t>=0,"removeWrite called with nonexistent writeId.");let s=n.allWrites[t];n.allWrites.splice(t,1);let i=s.visible,r=!1,o=n.allWrites.length-1;for(;i&&o>=0;){let a=n.allWrites[o];a.visible&&(o>=t&&zu(a,s.path)?i=!1:ie(s.path,a.path)&&(r=!0)),o--}if(i){if(r)return Ku(n),!0;if(s.snap)n.visibleWrites=Qo(n.visibleWrites,s.path);else{let a=s.children;H(a,l=>{n.visibleWrites=Qo(n.visibleWrites,N(s.path,l))})}return!0}else return!1}function zu(n,e){if(n.snap)return ie(n.path,e);for(let t in n.children)if(n.children.hasOwnProperty(t)&&ie(N(n.path,t),e))return!0;return!1}function Ku(n){n.visibleWrites=Ba(n.allWrites,Qu,b()),n.allWrites.length>0?n.lastWriteId=n.allWrites[n.allWrites.length-1].writeId:n.lastWriteId=-1}function Qu(n){return n.visible}function Ba(n,e,t){let s=le.empty();for(let i=0;i<n.length;++i){let r=n[i];if(e(r)){let o=r.path,a;if(r.snap)ie(t,o)?(a=z(t,o),s=Ft(s,a,r.snap)):ie(o,t)&&(a=z(o,t),s=Ft(s,b(),r.snap.getChild(a)));else if(r.children){if(ie(t,o))a=z(t,o),s=Ni(s,a,r.children);else if(ie(o,t))if(a=z(o,t),E(a))s=Ni(s,b(),r.children);else{let l=Re(r.children,w(a));if(l){let c=l.getChild(R(a));s=Ft(s,b(),c)}}}else throw Ze("WriteRecord should have .snap or .children")}}return s}function Wa(n,e,t,s,i){if(!s&&!i){let r=Ve(n.visibleWrites,e);if(r!=null)return r;{let o=ke(n.visibleWrites,e);if(Pi(o))return t;if(t==null&&!Ai(o,b()))return null;{let a=t||y.EMPTY_NODE;return ut(o,a)}}}else{let r=ke(n.visibleWrites,e);if(!i&&Pi(r))return t;if(!i&&t==null&&!Ai(r,b()))return null;{let o=function(c){return(c.visible||i)&&(!s||!~s.indexOf(c.writeId))&&(ie(c.path,e)||ie(e,c.path))},a=Ba(n.allWrites,o,e),l=t||y.EMPTY_NODE;return ut(a,l)}}}function Yu(n,e,t){let s=y.EMPTY_NODE,i=Ve(n.visibleWrites,e);if(i)return i.isLeafNode()||i.forEachChild(S,(r,o)=>{s=s.updateImmediateChild(r,o)}),s;if(t){let r=ke(n.visibleWrites,e);return t.forEachChild(S,(o,a)=>{let l=ut(ke(r,new I(o)),a);s=s.updateImmediateChild(o,l)}),Yo(r).forEach(o=>{s=s.updateImmediateChild(o.name,o.node)}),s}else{let r=ke(n.visibleWrites,e);return Yo(r).forEach(o=>{s=s.updateImmediateChild(o.name,o.node)}),s}}function Xu(n,e,t,s,i){_(s||i,"Either existingEventSnap or existingServerSnap must exist");let r=N(e,t);if(Ai(n.visibleWrites,r))return null;{let o=ke(n.visibleWrites,r);return Pi(o)?i.getChild(t):ut(o,i.getChild(t))}}function Ju(n,e,t,s){let i=N(e,t),r=Ve(n.visibleWrites,i);if(r!=null)return r;if(s.isCompleteForChild(t)){let o=ke(n.visibleWrites,i);return ut(o,s.getNode().getImmediateChild(t))}else return null}function Zu(n,e){return Ve(n.visibleWrites,e)}function eh(n,e,t,s,i,r,o){let a,l=ke(n.visibleWrites,e),c=Ve(l,b());if(c!=null)a=c;else if(t!=null)a=ut(l,t);else return[];if(a=a.withIndex(o),!a.isEmpty()&&!a.isLeafNode()){let u=[],h=o.getCompare(),d=r?a.getReverseIteratorFrom(s,o):a.getIteratorFrom(s,o),f=d.getNext();for(;f&&u.length<i;)h(f,s)!==0&&u.push(f),f=d.getNext();return u}else return[]}function th(){return{visibleWrites:le.empty(),allWrites:[],lastWriteId:-1}}function Qn(n,e,t,s){return Wa(n.writeTree,n.treePath,e,t,s)}function pr(n,e){return Yu(n.writeTree,n.treePath,e)}function Xo(n,e,t,s){return Xu(n.writeTree,n.treePath,e,t,s)}function Yn(n,e){return Zu(n.writeTree,N(n.treePath,e))}function nh(n,e,t,s,i,r){return eh(n.writeTree,n.treePath,e,t,s,i,r)}function gr(n,e,t){return Ju(n.writeTree,n.treePath,e,t)}function Ha(n,e){return ja(N(n.treePath,e),n.writeTree)}function ja(n,e){return{treePath:n,writeTree:e}}var xi=class{constructor(){this.changeMap=new Map}trackChildChange(e){let t=e.type,s=e.childName;_(t==="child_added"||t==="child_changed"||t==="child_removed","Only child changes supported for tracking"),_(s!==".priority","Only non-priority child changes can be tracked.");let i=this.changeMap.get(s);if(i){let r=i.type;if(t==="child_added"&&r==="child_removed")this.changeMap.set(s,qt(s,e.snapshotNode,i.snapshotNode));else if(t==="child_removed"&&r==="child_added")this.changeMap.delete(s);else if(t==="child_removed"&&r==="child_changed")this.changeMap.set(s,jt(s,i.oldSnap));else if(t==="child_changed"&&r==="child_added")this.changeMap.set(s,lt(s,e.snapshotNode));else if(t==="child_changed"&&r==="child_changed")this.changeMap.set(s,qt(s,e.snapshotNode,i.oldSnap));else throw Ze("Illegal combination of changes: "+e+" occurred after "+i)}else this.changeMap.set(s,e)}getChanges(){return Array.from(this.changeMap.values())}};var Oi=class{getCompleteChild(e){return null}getChildAfterChild(e,t,s){return null}},qa=new Oi,zt=class{constructor(e,t,s=null){this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=s}getCompleteChild(e){let t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);{let s=this.optCompleteServerCache_!=null?new me(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return gr(this.writes_,e,s)}}getChildAfterChild(e,t,s){let i=this.optCompleteServerCache_!=null?this.optCompleteServerCache_:je(this.viewCache_),r=nh(this.writes_,i,t,1,s,e);return r.length===0?null:r[0]}};function sh(n){return{filter:n}}function ih(n,e){_(e.eventCache.getNode().isIndexed(n.filter.getIndex()),"Event snap not indexed"),_(e.serverCache.getNode().isIndexed(n.filter.getIndex()),"Server snap not indexed")}function rh(n,e,t,s,i){let r=new xi,o,a;if(t.type===_e.OVERWRITE){let c=t;c.source.fromUser?o=Di(n,e,c.path,c.snap,s,i,r):(_(c.source.fromServer,"Unknown source."),a=c.source.tagged||e.serverCache.isFiltered()&&!E(c.path),o=Xn(n,e,c.path,c.snap,s,i,a,r))}else if(t.type===_e.MERGE){let c=t;c.source.fromUser?o=ah(n,e,c.path,c.children,s,i,r):(_(c.source.fromServer,"Unknown source."),a=c.source.tagged||e.serverCache.isFiltered(),o=Li(n,e,c.path,c.children,s,i,a,r))}else if(t.type===_e.ACK_USER_WRITE){let c=t;c.revert?o=uh(n,e,c.path,s,i,r):o=lh(n,e,c.path,c.affectedTree,s,i,r)}else if(t.type===_e.LISTEN_COMPLETE)o=ch(n,e,t.path,s,r);else throw Ze("Unknown operation type: "+t.type);let l=r.getChanges();return oh(e,o,l),{viewCache:o,changes:l}}function oh(n,e,t){let s=e.eventCache;if(s.isFullyInitialized()){let i=s.getNode().isLeafNode()||s.getNode().isEmpty(),r=Kn(n);(t.length>0||!n.eventCache.isFullyInitialized()||i&&!s.getNode().equals(r)||!s.getNode().getPriority().equals(r.getPriority()))&&t.push(Ma(Kn(e)))}}function Va(n,e,t,s,i,r){let o=e.eventCache;if(Yn(s,t)!=null)return e;{let a,l;if(E(t))if(_(e.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),e.serverCache.isFiltered()){let c=je(e),u=c instanceof y?c:y.EMPTY_NODE,h=pr(s,u);a=n.filter.updateFullNode(e.eventCache.getNode(),h,r)}else{let c=Qn(s,je(e));a=n.filter.updateFullNode(e.eventCache.getNode(),c,r)}else{let c=w(t);if(c===".priority"){_(Pe(t)===1,"Can't have a priority with additional path components");let u=o.getNode();l=e.serverCache.getNode();let h=Xo(s,t,u,l);h!=null?a=n.filter.updatePriority(u,h):a=o.getNode()}else{let u=R(t),h;if(o.isCompleteForChild(c)){l=e.serverCache.getNode();let d=Xo(s,t,o.getNode(),l);d!=null?h=o.getNode().getImmediateChild(c).updateChild(u,d):h=o.getNode().getImmediateChild(c)}else h=gr(s,c,e.serverCache);h!=null?a=n.filter.updateChild(o.getNode(),c,h,u,i,r):a=o.getNode()}}return Mt(e,a,o.isFullyInitialized()||E(t),n.filter.filtersNodes())}}function Xn(n,e,t,s,i,r,o,a){let l=e.serverCache,c,u=o?n.filter:n.filter.getIndexedFilter();if(E(t))c=u.updateFullNode(l.getNode(),s,null);else if(u.filtersNodes()&&!l.isFiltered()){let f=l.getNode().updateChild(t,s);c=u.updateFullNode(l.getNode(),f,null)}else{let f=w(t);if(!l.isCompleteForPath(t)&&Pe(t)>1)return e;let p=R(t),v=l.getNode().getImmediateChild(f).updateChild(p,s);f===".priority"?c=u.updatePriority(l.getNode(),v):c=u.updateChild(l.getNode(),f,v,p,qa,null)}let h=Fa(e,c,l.isFullyInitialized()||E(t),u.filtersNodes()),d=new zt(i,h,r);return Va(n,h,t,i,d,a)}function Di(n,e,t,s,i,r,o){let a=e.eventCache,l,c,u=new zt(i,e,r);if(E(t))c=n.filter.updateFullNode(e.eventCache.getNode(),s,o),l=Mt(e,c,!0,n.filter.filtersNodes());else{let h=w(t);if(h===".priority")c=n.filter.updatePriority(e.eventCache.getNode(),s),l=Mt(e,c,a.isFullyInitialized(),a.isFiltered());else{let d=R(t),f=a.getNode().getImmediateChild(h),p;if(E(d))p=s;else{let m=u.getCompleteChild(h);m!=null?ar(d)===".priority"&&m.getChild(Aa(d)).isEmpty()?p=m:p=m.updateChild(d,s):p=y.EMPTY_NODE}if(f.equals(p))l=e;else{let m=n.filter.updateChild(a.getNode(),h,p,d,u,o);l=Mt(e,m,a.isFullyInitialized(),n.filter.filtersNodes())}}}return l}function Jo(n,e){return n.eventCache.isCompleteForChild(e)}function ah(n,e,t,s,i,r,o){let a=e;return s.foreach((l,c)=>{let u=N(t,l);Jo(e,w(u))&&(a=Di(n,a,u,c,i,r,o))}),s.foreach((l,c)=>{let u=N(t,l);Jo(e,w(u))||(a=Di(n,a,u,c,i,r,o))}),a}function Zo(n,e,t){return t.foreach((s,i)=>{e=e.updateChild(s,i)}),e}function Li(n,e,t,s,i,r,o,a){if(e.serverCache.getNode().isEmpty()&&!e.serverCache.isFullyInitialized())return e;let l=e,c;E(t)?c=s:c=new K(null).setTree(t,s);let u=e.serverCache.getNode();return c.children.inorderTraversal((h,d)=>{if(u.hasChild(h)){let f=e.serverCache.getNode().getImmediateChild(h),p=Zo(n,f,d);l=Xn(n,l,new I(h),p,i,r,o,a)}}),c.children.inorderTraversal((h,d)=>{let f=!e.serverCache.isCompleteForChild(h)&&d.value===null;if(!u.hasChild(h)&&!f){let p=e.serverCache.getNode().getImmediateChild(h),m=Zo(n,p,d);l=Xn(n,l,new I(h),m,i,r,o,a)}}),l}function lh(n,e,t,s,i,r,o){if(Yn(i,t)!=null)return e;let a=e.serverCache.isFiltered(),l=e.serverCache;if(s.value!=null){if(E(t)&&l.isFullyInitialized()||l.isCompleteForPath(t))return Xn(n,e,t,l.getNode().getChild(t),i,r,a,o);if(E(t)){let c=new K(null);return l.getNode().forEachChild(pe,(u,h)=>{c=c.set(new I(u),h)}),Li(n,e,t,c,i,r,a,o)}else return e}else{let c=new K(null);return s.foreach((u,h)=>{let d=N(t,u);l.isCompleteForPath(d)&&(c=c.set(u,l.getNode().getChild(d)))}),Li(n,e,t,c,i,r,a,o)}}function ch(n,e,t,s,i){let r=e.serverCache,o=Fa(e,r.getNode(),r.isFullyInitialized()||E(t),r.isFiltered());return Va(n,o,t,s,qa,i)}function uh(n,e,t,s,i,r){let o;if(Yn(s,t)!=null)return e;{let a=new zt(s,e,i),l=e.eventCache.getNode(),c;if(E(t)||w(t)===".priority"){let u;if(e.serverCache.isFullyInitialized())u=Qn(s,je(e));else{let h=e.serverCache.getNode();_(h instanceof y,"serverChildren would be complete if leaf node"),u=pr(s,h)}u=u,c=n.filter.updateFullNode(l,u,r)}else{let u=w(t),h=gr(s,u,e.serverCache);h==null&&e.serverCache.isCompleteForChild(u)&&(h=l.getImmediateChild(u)),h!=null?c=n.filter.updateChild(l,u,h,R(t),a,r):e.eventCache.getNode().hasChild(u)?c=n.filter.updateChild(l,u,y.EMPTY_NODE,R(t),a,r):c=l,c.isEmpty()&&e.serverCache.isFullyInitialized()&&(o=Qn(s,je(e)),o.isLeafNode()&&(c=n.filter.updateFullNode(c,o,r)))}return o=e.serverCache.isFullyInitialized()||Yn(s,b())!=null,Mt(e,c,o,n.filter.filtersNodes())}}var Mi=class{constructor(e,t){this.query_=e,this.eventRegistrations_=[];let s=this.query_._queryParams,i=new Vt(s.getIndex()),r=Pu(s);this.processor_=sh(r);let o=t.serverCache,a=t.eventCache,l=i.updateFullNode(y.EMPTY_NODE,o.getNode(),null),c=r.updateFullNode(y.EMPTY_NODE,a.getNode(),null),u=new me(l,o.isFullyInitialized(),i.filtersNodes()),h=new me(c,a.isFullyInitialized(),r.filtersNodes());this.viewCache_=hs(h,u),this.eventGenerator_=new ki(this.query_)}get query(){return this.query_}};function hh(n){return n.viewCache_.serverCache.getNode()}function dh(n){return Kn(n.viewCache_)}function fh(n,e){let t=je(n.viewCache_);return t&&(n.query._queryParams.loadsAllData()||!E(e)&&!t.getImmediateChild(w(e)).isEmpty())?t.getChild(e):null}function ea(n){return n.eventRegistrations_.length===0}function _h(n,e){n.eventRegistrations_.push(e)}function ta(n,e,t){let s=[];if(t){_(e==null,"A cancel should cancel all event registrations.");let i=n.query._path;n.eventRegistrations_.forEach(r=>{let o=r.createCancelEvent(t,i);o&&s.push(o)})}if(e){let i=[];for(let r=0;r<n.eventRegistrations_.length;++r){let o=n.eventRegistrations_[r];if(!o.matches(e))i.push(o);else if(e.hasAnyCallback()){i=i.concat(n.eventRegistrations_.slice(r+1));break}}n.eventRegistrations_=i}else n.eventRegistrations_=[];return s}function na(n,e,t,s){e.type===_e.MERGE&&e.source.queryId!==null&&(_(je(n.viewCache_),"We should always have a full cache before handling merges"),_(Kn(n.viewCache_),"Missing event cache, even though we have a server cache"));let i=n.viewCache_,r=rh(n.processor_,i,e,t,s);return ih(n.processor_,r.viewCache),_(r.viewCache.serverCache.isFullyInitialized()||!i.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),n.viewCache_=r.viewCache,Ga(n,r.changes,r.viewCache.eventCache.getNode(),null)}function ph(n,e){let t=n.viewCache_.eventCache,s=[];return t.getNode().isLeafNode()||t.getNode().forEachChild(S,(r,o)=>{s.push(lt(r,o))}),t.isFullyInitialized()&&s.push(Ma(t.getNode())),Ga(n,s,t.getNode(),e)}function Ga(n,e,t,s){let i=s?[s]:n.eventRegistrations_;return Bu(n.eventGenerator_,e,t,i)}var Jn,Zn=class{constructor(){this.views=new Map}};function gh(n){_(!Jn,"__referenceConstructor has already been defined"),Jn=n}function mh(){return _(Jn,"Reference.ts has not been loaded"),Jn}function yh(n){return n.views.size===0}function mr(n,e,t,s){let i=e.source.queryId;if(i!==null){let r=n.views.get(i);return _(r!=null,"SyncTree gave us an op for an invalid query."),na(r,e,t,s)}else{let r=[];for(let o of n.views.values())r=r.concat(na(o,e,t,s));return r}}function $a(n,e,t,s,i){let r=e._queryIdentifier,o=n.views.get(r);if(!o){let a=Qn(t,i?s:null),l=!1;a?l=!0:s instanceof y?(a=pr(t,s),l=!1):(a=y.EMPTY_NODE,l=!1);let c=hs(new me(a,l,!1),new me(s,i,!1));return new Mi(e,c)}return o}function vh(n,e,t,s,i,r){let o=$a(n,e,s,i,r);return n.views.has(e._queryIdentifier)||n.views.set(e._queryIdentifier,o),_h(o,t),ph(o,t)}function wh(n,e,t,s){let i=e._queryIdentifier,r=[],o=[],a=xe(n);if(i==="default")for(let[l,c]of n.views.entries())o=o.concat(ta(c,t,s)),ea(c)&&(n.views.delete(l),c.query._queryParams.loadsAllData()||r.push(c.query));else{let l=n.views.get(i);l&&(o=o.concat(ta(l,t,s)),ea(l)&&(n.views.delete(i),l.query._queryParams.loadsAllData()||r.push(l.query)))}return a&&!xe(n)&&r.push(new(mh())(e._repo,e._path)),{removed:r,events:o}}function za(n){let e=[];for(let t of n.views.values())t.query._queryParams.loadsAllData()||e.push(t);return e}function Ne(n,e){let t=null;for(let s of n.views.values())t=t||fh(s,e);return t}function Ka(n,e){if(e._queryParams.loadsAllData())return fs(n);{let s=e._queryIdentifier;return n.views.get(s)}}function Qa(n,e){return Ka(n,e)!=null}function xe(n){return fs(n)!=null}function fs(n){for(let e of n.views.values())if(e.query._queryParams.loadsAllData())return e;return null}var es;function Eh(n){_(!es,"__referenceConstructor has already been defined"),es=n}function Ch(){return _(es,"Reference.ts has not been loaded"),es}var Th=1,ts=class{constructor(e){this.listenProvider_=e,this.syncPointTree_=new K(null),this.pendingWriteTree_=th(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}};function yr(n,e,t,s,i){return qu(n.pendingWriteTree_,e,t,s,i),i?pt(n,new ct(dr(),e,t)):[]}function bh(n,e,t,s){Vu(n.pendingWriteTree_,e,t,s);let i=K.fromObject(t);return pt(n,new $t(dr(),e,i))}function Se(n,e,t=!1){let s=Gu(n.pendingWriteTree_,e);if($u(n.pendingWriteTree_,e)){let r=new K(null);return s.snap!=null?r=r.set(b(),!0):H(s.children,o=>{r=r.set(new I(o),!0)}),pt(n,new Si(s.path,r,t))}else return[]}function nn(n,e,t){return pt(n,new ct(fr(),e,t))}function Ih(n,e,t){let s=K.fromObject(t);return pt(n,new $t(fr(),e,s))}function Rh(n,e){return pt(n,new zn(fr(),e))}function Sh(n,e,t){let s=vr(n,t);if(s){let i=wr(s),r=i.path,o=i.queryId,a=z(r,e),l=new zn(_r(o),a);return Er(n,r,l)}else return[]}function ns(n,e,t,s,i=!1){let r=e._path,o=n.syncPointTree_.get(r),a=[];if(o&&(e._queryIdentifier==="default"||Qa(o,e))){let l=wh(o,e,t,s);yh(o)&&(n.syncPointTree_=n.syncPointTree_.remove(r));let c=l.removed;if(a=l.events,!i){let u=c.findIndex(d=>d._queryParams.loadsAllData())!==-1,h=n.syncPointTree_.findOnPath(r,(d,f)=>xe(f));if(u&&!h){let d=n.syncPointTree_.subtree(r);if(!d.isEmpty()){let f=Ah(d);for(let p=0;p<f.length;++p){let m=f[p],v=m.query,L=Za(n,m);n.listenProvider_.startListening(Ut(v),Kt(n,v),L.hashFn,L.onComplete)}}}!h&&c.length>0&&!s&&(u?n.listenProvider_.stopListening(Ut(e),null):c.forEach(d=>{let f=n.queryToTagMap.get(ps(d));n.listenProvider_.stopListening(Ut(d),f)}))}Ph(n,c)}return a}function Ya(n,e,t,s){let i=vr(n,s);if(i!=null){let r=wr(i),o=r.path,a=r.queryId,l=z(o,e),c=new ct(_r(a),l,t);return Er(n,o,c)}else return[]}function kh(n,e,t,s){let i=vr(n,s);if(i){let r=wr(i),o=r.path,a=r.queryId,l=z(o,e),c=K.fromObject(t),u=new $t(_r(a),l,c);return Er(n,o,u)}else return[]}function Fi(n,e,t,s=!1){let i=e._path,r=null,o=!1;n.syncPointTree_.foreachOnPath(i,(d,f)=>{let p=z(d,i);r=r||Ne(f,p),o=o||xe(f)});let a=n.syncPointTree_.get(i);a?(o=o||xe(a),r=r||Ne(a,b())):(a=new Zn,n.syncPointTree_=n.syncPointTree_.set(i,a));let l;r!=null?l=!0:(l=!1,r=y.EMPTY_NODE,n.syncPointTree_.subtree(i).foreachChild((f,p)=>{let m=Ne(p,b());m&&(r=r.updateImmediateChild(f,m))}));let c=Qa(a,e);if(!c&&!e._queryParams.loadsAllData()){let d=ps(e);_(!n.queryToTagMap.has(d),"View does not exist, but we have a tag");let f=xh();n.queryToTagMap.set(d,f),n.tagToQueryMap.set(f,d)}let u=ds(n.pendingWriteTree_,i),h=vh(a,e,t,u,r,l);if(!c&&!o&&!s){let d=Ka(a,e);h=h.concat(Oh(n,e,d))}return h}function _s(n,e,t){let i=n.pendingWriteTree_,r=n.syncPointTree_.findOnPath(e,(o,a)=>{let l=z(o,e),c=Ne(a,l);if(c)return c});return Wa(i,e,r,t,!0)}function Nh(n,e){let t=e._path,s=null;n.syncPointTree_.foreachOnPath(t,(c,u)=>{let h=z(c,t);s=s||Ne(u,h)});let i=n.syncPointTree_.get(t);i?s=s||Ne(i,b()):(i=new Zn,n.syncPointTree_=n.syncPointTree_.set(t,i));let r=s!=null,o=r?new me(s,!0,!1):null,a=ds(n.pendingWriteTree_,e._path),l=$a(i,e,a,r?o.getNode():y.EMPTY_NODE,r);return dh(l)}function pt(n,e){return Xa(e,n.syncPointTree_,null,ds(n.pendingWriteTree_,b()))}function Xa(n,e,t,s){if(E(n.path))return Ja(n,e,t,s);{let i=e.get(b());t==null&&i!=null&&(t=Ne(i,b()));let r=[],o=w(n.path),a=n.operationForChild(o),l=e.children.get(o);if(l&&a){let c=t?t.getImmediateChild(o):null,u=Ha(s,o);r=r.concat(Xa(a,l,c,u))}return i&&(r=r.concat(mr(i,n,s,t))),r}}function Ja(n,e,t,s){let i=e.get(b());t==null&&i!=null&&(t=Ne(i,b()));let r=[];return e.children.inorderTraversal((o,a)=>{let l=t?t.getImmediateChild(o):null,c=Ha(s,o),u=n.operationForChild(o);u&&(r=r.concat(Ja(u,a,l,c)))}),i&&(r=r.concat(mr(i,n,s,t))),r}function Za(n,e){let t=e.query,s=Kt(n,t);return{hashFn:()=>(hh(e)||y.EMPTY_NODE).hash(),onComplete:i=>{if(i==="ok")return s?Sh(n,t._path,s):Rh(n,t._path);{let r=qc(i,t);return ns(n,t,null,r)}}}}function Kt(n,e){let t=ps(e);return n.queryToTagMap.get(t)}function ps(n){return n._path.toString()+"$"+n._queryIdentifier}function vr(n,e){return n.tagToQueryMap.get(e)}function wr(n){let e=n.indexOf("$");return _(e!==-1&&e<n.length-1,"Bad queryKey."),{queryId:n.substr(e+1),path:new I(n.substr(0,e))}}function Er(n,e,t){let s=n.syncPointTree_.get(e);_(s,"Missing sync point for query tag that we're tracking");let i=ds(n.pendingWriteTree_,e);return mr(s,t,i,null)}function Ah(n){return n.fold((e,t,s)=>{if(t&&xe(t))return[fs(t)];{let i=[];return t&&(i=za(t)),H(s,(r,o)=>{i=i.concat(o)}),i}})}function Ut(n){return n._queryParams.loadsAllData()&&!n._queryParams.isDefault()?new(Ch())(n._repo,n._path):n}function Ph(n,e){for(let t=0;t<e.length;++t){let s=e[t];if(!s._queryParams.loadsAllData()){let i=ps(s),r=n.queryToTagMap.get(i);n.queryToTagMap.delete(i),n.tagToQueryMap.delete(r)}}}function xh(){return Th++}function Oh(n,e,t){let s=e._path,i=Kt(n,e),r=Za(n,t),o=n.listenProvider_.startListening(Ut(e),i,r.hashFn,r.onComplete),a=n.syncPointTree_.subtree(s);if(i)_(!xe(a.value),"If we're adding a query, it shouldn't be shadowed");else{let l=a.fold((c,u,h)=>{if(!E(c)&&u&&xe(u))return[fs(u).query];{let d=[];return u&&(d=d.concat(za(u).map(f=>f.query))),H(h,(f,p)=>{d=d.concat(p)}),d}});for(let c=0;c<l.length;++c){let u=l[c];n.listenProvider_.stopListening(Ut(u),Kt(n,u))}}return o}var Ui=class n{constructor(e){this.node_=e}getImmediateChild(e){let t=this.node_.getImmediateChild(e);return new n(t)}node(){return this.node_}},Bi=class n{constructor(e,t){this.syncTree_=e,this.path_=t}getImmediateChild(e){let t=N(this.path_,e);return new n(this.syncTree_,t)}node(){return _s(this.syncTree_,this.path_)}},Dh=function(n){return n=n||{},n.timestamp=n.timestamp||new Date().getTime(),n},sa=function(n,e,t){if(!n||typeof n!="object")return n;if(_(".sv"in n,"Unexpected leaf node or priority contents"),typeof n[".sv"]=="string")return Lh(n[".sv"],e,t);if(typeof n[".sv"]=="object")return Mh(n[".sv"],e);_(!1,"Unexpected server value: "+JSON.stringify(n,null,2))},Lh=function(n,e,t){switch(n){case"timestamp":return t.timestamp;default:_(!1,"Unexpected server value: "+n)}},Mh=function(n,e,t){n.hasOwnProperty("increment")||_(!1,"Unexpected server value: "+JSON.stringify(n,null,2));let s=n.increment;typeof s!="number"&&_(!1,"Unexpected increment value: "+s);let i=e.node();if(_(i!==null&&typeof i<"u","Expected ChildrenNode.EMPTY_NODE for nulls"),!i.isLeafNode())return s;let o=i.getValue();return typeof o!="number"?s:o+s},el=function(n,e,t,s){return Tr(e,new Bi(t,n),s)},Cr=function(n,e,t){return Tr(n,new Ui(e),t)};function Tr(n,e,t){let s=n.getPriority().val(),i=sa(s,e.getImmediateChild(".priority"),t),r;if(n.isLeafNode()){let o=n,a=sa(o.getValue(),e,t);return a!==o.getValue()||i!==o.getPriority().val()?new ot(a,x(i)):n}else{let o=n;return r=o,i!==o.getPriority().val()&&(r=r.updatePriority(new ot(i))),o.forEachChild(S,(a,l)=>{let c=Tr(l,e.getImmediateChild(a),t);c!==l&&(r=r.updateImmediateChild(a,c))}),r}}var Qt=class{constructor(e="",t=null,s={children:{},childCount:0}){this.name=e,this.parent=t,this.node=s}};function gs(n,e){let t=e instanceof I?e:new I(e),s=n,i=w(t);for(;i!==null;){let r=Re(s.node.children,i)||{children:{},childCount:0};s=new Qt(i,s,r),t=R(t),i=w(t)}return s}function Ge(n){return n.node.value}function br(n,e){n.node.value=e,Wi(n)}function tl(n){return n.node.childCount>0}function Fh(n){return Ge(n)===void 0&&!tl(n)}function ms(n,e){H(n.node.children,(t,s)=>{e(new Qt(t,n,s))})}function nl(n,e,t,s){t&&!s&&e(n),ms(n,i=>{nl(i,e,!0,s)}),t&&s&&e(n)}function Uh(n,e,t){let s=t?n:n.parent;for(;s!==null;){if(e(s))return!0;s=s.parent}return!1}function sn(n){return new I(n.parent===null?n.name:sn(n.parent)+"/"+n.name)}function Wi(n){n.parent!==null&&Bh(n.parent,n.name,n)}function Bh(n,e,t){let s=Fh(t),i=se(n.node.children,e);s&&i?(delete n.node.children[e],n.node.childCount--,Wi(n)):!s&&!i&&(n.node.children[e]=t.node,n.node.childCount++,Wi(n))}var Wh=/[\[\].#$\/\u0000-\u001F\u007F]/,Hh=/[\[\].#$\u0000-\u001F\u007F]/,Xs=10*1024*1024,ys=function(n){return typeof n=="string"&&n.length!==0&&!Wh.test(n)},sl=function(n){return typeof n=="string"&&n.length!==0&&!Hh.test(n)},jh=function(n){return n&&(n=n.replace(/^\/*\.info(\/|$)/,"/")),sl(n)},Yt=function(n){return n===null||typeof n=="string"||typeof n=="number"&&!cs(n)||n&&typeof n=="object"&&se(n,".sv")},ye=function(n,e,t,s){s&&e===void 0||rn(X(n,"value"),e,t)},rn=function(n,e,t){let s=t instanceof I?new ui(t,n):t;if(e===void 0)throw new Error(n+"contains undefined "+Be(s));if(typeof e=="function")throw new Error(n+"contains a function "+Be(s)+" with contents = "+e.toString());if(cs(e))throw new Error(n+"contains "+e.toString()+" "+Be(s));if(typeof e=="string"&&e.length>Xs/3&&Nt(e)>Xs)throw new Error(n+"contains a string greater than "+Xs+" utf8 bytes "+Be(s)+" ('"+e.substring(0,50)+"...')");if(e&&typeof e=="object"){let i=!1,r=!1;if(H(e,(o,a)=>{if(o===".value")i=!0;else if(o!==".priority"&&o!==".sv"&&(r=!0,!ys(o)))throw new Error(n+" contains an invalid key ("+o+") "+Be(s)+`.  Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`);yu(s,o),rn(n,a,s),vu(s)}),i&&r)throw new Error(n+' contains ".value" child '+Be(s)+" in addition to actual children.")}},qh=function(n,e){let t,s;for(t=0;t<e.length;t++){s=e[t];let r=Wt(s);for(let o=0;o<r.length;o++)if(!(r[o]===".priority"&&o===r.length-1)){if(!ys(r[o]))throw new Error(n+"contains an invalid key ("+r[o]+") in path "+s.toString()+`. Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`)}}e.sort(mu);let i=null;for(t=0;t<e.length;t++){if(s=e[t],i!==null&&ie(i,s))throw new Error(n+"contains a path "+i.toString()+" that is ancestor of another path "+s.toString());i=s}},il=function(n,e,t,s){if(s&&e===void 0)return;let i=X(n,"values");if(!(e&&typeof e=="object")||Array.isArray(e))throw new Error(i+" must be an object containing the children to replace.");let r=[];H(e,(o,a)=>{let l=new I(o);if(rn(i,a,N(t,l)),ar(l)===".priority"&&!Yt(a))throw new Error(i+"contains an invalid value for '"+l.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");r.push(l)}),qh(i,r)},Ir=function(n,e,t){if(!(t&&e===void 0)){if(cs(e))throw new Error(X(n,"priority")+"is "+e.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!Yt(e))throw new Error(X(n,"priority")+"must be a valid Firebase priority (a string, finite number, server value, or null).")}},on=function(n,e,t,s){if(!(s&&t===void 0)&&!ys(t))throw new Error(X(n,e)+'was an invalid key = "'+t+`".  Firebase keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]").`)},gt=function(n,e,t,s){if(!(s&&t===void 0)&&!sl(t))throw new Error(X(n,e)+'was an invalid path = "'+t+`". Paths must be non-empty strings and can't contain ".", "#", "$", "[", or "]"`)},Vh=function(n,e,t,s){t&&(t=t.replace(/^\/*\.info(\/|$)/,"/")),gt(n,e,t,s)},J=function(n,e){if(w(e)===".info")throw new Error(n+" failed = Can't modify data under /.info/")},rl=function(n,e){let t=e.path.toString();if(typeof e.repoInfo.host!="string"||e.repoInfo.host.length===0||!ys(e.repoInfo.namespace)&&e.repoInfo.host.split(":")[0]!=="localhost"||t.length!==0&&!jh(t))throw new Error(X(n,"url")+`must be a valid firebase URL and the path can't contain ".", "#", "$", "[", or "]".`)};var Hi=class{constructor(){this.eventLists_=[],this.recursionDepth_=0}};function vs(n,e){let t=null;for(let s=0;s<e.length;s++){let i=e[s],r=i.getPath();t!==null&&!lr(r,t.path)&&(n.eventLists_.push(t),t=null),t===null&&(t={events:[],path:r}),t.events.push(i)}t&&n.eventLists_.push(t)}function ol(n,e,t){vs(n,t),al(n,s=>lr(s,e))}function Z(n,e,t){vs(n,t),al(n,s=>ie(s,e)||ie(e,s))}function al(n,e){n.recursionDepth_++;let t=!0;for(let s=0;s<n.eventLists_.length;s++){let i=n.eventLists_[s];if(i){let r=i.path;e(r)?(Gh(n.eventLists_[s]),n.eventLists_[s]=null):t=!1}}t&&(n.eventLists_=[]),n.recursionDepth_--}function Gh(n){for(let e=0;e<n.events.length;e++){let t=n.events[e];if(t!==null){n.events[e]=null;let s=t.getEventRunner();He&&W("event: "+t.toString()),ft(s)}}}var ll="repo_interrupt",$h=25,ji=class{constructor(e,t,s,i){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=s,this.appCheckProvider_=i,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new Hi,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=$n(),this.transactionQueueTree_=new Qt,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}};function zh(n,e,t){if(n.stats_=or(n.repoInfo_),n.forceRestClient_||zc())n.server_=new Ei(n.repoInfo_,(s,i,r,o)=>{ia(n,s,i,r,o)},n.authTokenProvider_,n.appCheckProvider_),setTimeout(()=>ra(n,!0),0);else{if(typeof t<"u"&&t!==null){if(typeof t!="object")throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{M(t)}catch(s){throw new Error("Invalid authOverride provided: "+s)}}n.persistentConnection_=new cr(n.repoInfo_,e,(s,i,r,o)=>{ia(n,s,i,r,o)},s=>{ra(n,s)},s=>{Kh(n,s)},n.authTokenProvider_,n.appCheckProvider_,t),n.server_=n.persistentConnection_}n.authTokenProvider_.addTokenChangeListener(s=>{n.server_.refreshAuthToken(s)}),n.appCheckProvider_.addTokenChangeListener(s=>{n.server_.refreshAppCheckToken(s.token)}),n.statsReporter_=Qc(n.repoInfo_,()=>new Ri(n.stats_,n.server_)),n.infoData_=new Ci,n.infoSyncTree_=new ts({startListening:(s,i,r,o)=>{let a=[],l=n.infoData_.getNode(s._path);return l.isEmpty()||(a=nn(n.infoSyncTree_,s._path,l),setTimeout(()=>{o("ok")},0)),a},stopListening:()=>{}}),Rr(n,"connected",!1),n.serverSyncTree_=new ts({startListening:(s,i,r,o)=>(n.server_.listen(s,r,i,(a,l)=>{let c=o(a,l);Z(n.eventQueue_,s._path,c)}),[]),stopListening:(s,i)=>{n.server_.unlisten(s,i)}})}function cl(n){let t=n.infoData_.getNode(new I(".info/serverTimeOffset")).val()||0;return new Date().getTime()+t}function an(n){return Dh({timestamp:cl(n)})}function ia(n,e,t,s,i){n.dataUpdateCount++;let r=new I(e);t=n.interceptServerDataCallback_?n.interceptServerDataCallback_(e,t):t;let o=[];if(i)if(s){let l=kt(t,c=>x(c));o=kh(n.serverSyncTree_,r,l,i)}else{let l=x(t);o=Ya(n.serverSyncTree_,r,l,i)}else if(s){let l=kt(t,c=>x(c));o=Ih(n.serverSyncTree_,r,l)}else{let l=x(t);o=nn(n.serverSyncTree_,r,l)}let a=r;o.length>0&&(a=ht(n,r)),Z(n.eventQueue_,a,o)}function ra(n,e){Rr(n,"connected",e),e===!1&&Xh(n)}function Kh(n,e){H(e,(t,s)=>{Rr(n,t,s)})}function Rr(n,e,t){let s=new I("/.info/"+e),i=x(t);n.infoData_.updateSnapshot(s,i);let r=nn(n.infoSyncTree_,s,i);Z(n.eventQueue_,s,r)}function ws(n){return n.nextWriteId_++}function Qh(n,e,t){let s=Nh(n.serverSyncTree_,e);return s!=null?Promise.resolve(s):n.server_.get(e).then(i=>{let r=x(i).withIndex(e._queryParams.getIndex());Fi(n.serverSyncTree_,e,t,!0);let o;if(e._queryParams.loadsAllData())o=nn(n.serverSyncTree_,e._path,r);else{let a=Kt(n.serverSyncTree_,e);o=Ya(n.serverSyncTree_,e._path,r,a)}return Z(n.eventQueue_,e._path,o),ns(n.serverSyncTree_,e,t,null,!0),r},i=>(mt(n,"get for query "+M(e)+" failed: "+i),Promise.reject(new Error(i))))}function Sr(n,e,t,s,i){mt(n,"set",{path:e.toString(),value:t,priority:s});let r=an(n),o=x(t,s),a=_s(n.serverSyncTree_,e),l=Cr(o,a,r),c=ws(n),u=yr(n.serverSyncTree_,e,l,c,!0);vs(n.eventQueue_,u),n.server_.put(e.toString(),o.val(!0),(d,f)=>{let p=d==="ok";p||q("set at "+e+" failed: "+d);let m=Se(n.serverSyncTree_,c,!p);Z(n.eventQueue_,e,m),Oe(n,i,d,f)});let h=Nr(n,e);ht(n,h),Z(n.eventQueue_,h,[])}function Yh(n,e,t,s){mt(n,"update",{path:e.toString(),value:t});let i=!0,r=an(n),o={};if(H(t,(a,l)=>{i=!1,o[a]=el(N(e,a),x(l),n.serverSyncTree_,r)}),i)W("update() called with empty data.  Don't do anything."),Oe(n,s,"ok",void 0);else{let a=ws(n),l=bh(n.serverSyncTree_,e,o,a);vs(n.eventQueue_,l),n.server_.merge(e.toString(),t,(c,u)=>{let h=c==="ok";h||q("update at "+e+" failed: "+c);let d=Se(n.serverSyncTree_,a,!h),f=d.length>0?ht(n,e):e;Z(n.eventQueue_,f,d),Oe(n,s,c,u)}),H(t,c=>{let u=Nr(n,N(e,c));ht(n,u)}),Z(n.eventQueue_,e,[])}}function Xh(n){mt(n,"onDisconnectEvents");let e=an(n),t=$n();bi(n.onDisconnect_,b(),(i,r)=>{let o=el(i,r,n.serverSyncTree_,e);_t(t,i,o)});let s=[];bi(t,b(),(i,r)=>{s=s.concat(nn(n.serverSyncTree_,i,r));let o=Nr(n,i);ht(n,o)}),n.onDisconnect_=$n(),Z(n.eventQueue_,b(),s)}function Jh(n,e,t){n.server_.onDisconnectCancel(e.toString(),(s,i)=>{s==="ok"&&Ti(n.onDisconnect_,e),Oe(n,t,s,i)})}function oa(n,e,t,s){let i=x(t);n.server_.onDisconnectPut(e.toString(),i.val(!0),(r,o)=>{r==="ok"&&_t(n.onDisconnect_,e,i),Oe(n,s,r,o)})}function Zh(n,e,t,s,i){let r=x(t,s);n.server_.onDisconnectPut(e.toString(),r.val(!0),(o,a)=>{o==="ok"&&_t(n.onDisconnect_,e,r),Oe(n,i,o,a)})}function ed(n,e,t,s){if(Cn(t)){W("onDisconnect().update() called with empty data.  Don't do anything."),Oe(n,s,"ok",void 0);return}n.server_.onDisconnectMerge(e.toString(),t,(i,r)=>{i==="ok"&&H(t,(o,a)=>{let l=x(a);_t(n.onDisconnect_,N(e,o),l)}),Oe(n,s,i,r)})}function td(n,e,t){let s;w(e._path)===".info"?s=Fi(n.infoSyncTree_,e,t):s=Fi(n.serverSyncTree_,e,t),ol(n.eventQueue_,e._path,s)}function qi(n,e,t){let s;w(e._path)===".info"?s=ns(n.infoSyncTree_,e,t):s=ns(n.serverSyncTree_,e,t),ol(n.eventQueue_,e._path,s)}function ul(n){n.persistentConnection_&&n.persistentConnection_.interrupt(ll)}function nd(n){n.persistentConnection_&&n.persistentConnection_.resume(ll)}function mt(n,...e){let t="";n.persistentConnection_&&(t=n.persistentConnection_.id+":"),W(t,...e)}function Oe(n,e,t,s){e&&ft(()=>{if(t==="ok")e(null);else{let i=(t||"error").toUpperCase(),r=i;s&&(r+=": "+s);let o=new Error(r);o.code=i,e(o)}})}function sd(n,e,t,s,i,r){mt(n,"transaction on "+e);let o={path:e,update:t,onComplete:s,status:null,order:ca(),applyLocally:r,retryCount:0,unwatcher:i,abortReason:null,currentWriteId:null,currentInputSnapshot:null,currentOutputSnapshotRaw:null,currentOutputSnapshotResolved:null},a=kr(n,e,void 0);o.currentInputSnapshot=a;let l=o.update(a.val());if(l===void 0)o.unwatcher(),o.currentOutputSnapshotRaw=null,o.currentOutputSnapshotResolved=null,o.onComplete&&o.onComplete(null,!1,o.currentInputSnapshot);else{rn("transaction failed: Data returned ",l,o.path),o.status=0;let c=gs(n.transactionQueueTree_,e),u=Ge(c)||[];u.push(o),br(c,u);let h;typeof l=="object"&&l!==null&&se(l,".priority")?(h=Re(l,".priority"),_(Yt(h),"Invalid priority returned by transaction. Priority must be a valid string, finite number, server value, or null.")):h=(_s(n.serverSyncTree_,e)||y.EMPTY_NODE).getPriority().val();let d=an(n),f=x(l,h),p=Cr(f,a,d);o.currentOutputSnapshotRaw=f,o.currentOutputSnapshotResolved=p,o.currentWriteId=ws(n);let m=yr(n.serverSyncTree_,e,p,o.currentWriteId,o.applyLocally);Z(n.eventQueue_,e,m),Es(n,n.transactionQueueTree_)}}function kr(n,e,t){return _s(n.serverSyncTree_,e,t)||y.EMPTY_NODE}function Es(n,e=n.transactionQueueTree_){if(e||Cs(n,e),Ge(e)){let t=dl(n,e);_(t.length>0,"Sending zero length transaction queue"),t.every(i=>i.status===0)&&id(n,sn(e),t)}else tl(e)&&ms(e,t=>{Es(n,t)})}function id(n,e,t){let s=t.map(c=>c.currentWriteId),i=kr(n,e,s),r=i,o=i.hash();for(let c=0;c<t.length;c++){let u=t[c];_(u.status===0,"tryToSendTransactionQueue_: items in queue should all be run."),u.status=1,u.retryCount++;let h=z(e,u.path);r=r.updateChild(h,u.currentOutputSnapshotRaw)}let a=r.val(!0),l=e;n.server_.put(l.toString(),a,c=>{mt(n,"transaction put response",{path:l.toString(),status:c});let u=[];if(c==="ok"){let h=[];for(let d=0;d<t.length;d++)t[d].status=2,u=u.concat(Se(n.serverSyncTree_,t[d].currentWriteId)),t[d].onComplete&&h.push(()=>t[d].onComplete(null,!0,t[d].currentOutputSnapshotResolved)),t[d].unwatcher();Cs(n,gs(n.transactionQueueTree_,e)),Es(n,n.transactionQueueTree_),Z(n.eventQueue_,e,u);for(let d=0;d<h.length;d++)ft(h[d])}else{if(c==="datastale")for(let h=0;h<t.length;h++)t[h].status===3?t[h].status=4:t[h].status=0;else{q("transaction at "+l.toString()+" failed: "+c);for(let h=0;h<t.length;h++)t[h].status=4,t[h].abortReason=c}ht(n,e)}},o)}function ht(n,e){let t=hl(n,e),s=sn(t),i=dl(n,t);return rd(n,i,s),s}function rd(n,e,t){if(e.length===0)return;let s=[],i=[],o=e.filter(a=>a.status===0).map(a=>a.currentWriteId);for(let a=0;a<e.length;a++){let l=e[a],c=z(t,l.path),u=!1,h;if(_(c!==null,"rerunTransactionsUnderNode_: relativePath should not be null."),l.status===4)u=!0,h=l.abortReason,i=i.concat(Se(n.serverSyncTree_,l.currentWriteId,!0));else if(l.status===0)if(l.retryCount>=$h)u=!0,h="maxretry",i=i.concat(Se(n.serverSyncTree_,l.currentWriteId,!0));else{let d=kr(n,l.path,o);l.currentInputSnapshot=d;let f=e[a].update(d.val());if(f!==void 0){rn("transaction failed: Data returned ",f,l.path);let p=x(f);typeof f=="object"&&f!=null&&se(f,".priority")||(p=p.updatePriority(d.getPriority()));let v=l.currentWriteId,L=an(n),F=Cr(p,d,L);l.currentOutputSnapshotRaw=p,l.currentOutputSnapshotResolved=F,l.currentWriteId=ws(n),o.splice(o.indexOf(v),1),i=i.concat(yr(n.serverSyncTree_,l.path,F,l.currentWriteId,l.applyLocally)),i=i.concat(Se(n.serverSyncTree_,v,!0))}else u=!0,h="nodata",i=i.concat(Se(n.serverSyncTree_,l.currentWriteId,!0))}Z(n.eventQueue_,t,i),i=[],u&&(e[a].status=2,function(d){setTimeout(d,Math.floor(0))}(e[a].unwatcher),e[a].onComplete&&(h==="nodata"?s.push(()=>e[a].onComplete(null,!1,e[a].currentInputSnapshot)):s.push(()=>e[a].onComplete(new Error(h),!1,null))))}Cs(n,n.transactionQueueTree_);for(let a=0;a<s.length;a++)ft(s[a]);Es(n,n.transactionQueueTree_)}function hl(n,e){let t,s=n.transactionQueueTree_;for(t=w(e);t!==null&&Ge(s)===void 0;)s=gs(s,t),e=R(e),t=w(e);return s}function dl(n,e){let t=[];return fl(n,e,t),t.sort((s,i)=>s.order-i.order),t}function fl(n,e,t){let s=Ge(e);if(s)for(let i=0;i<s.length;i++)t.push(s[i]);ms(e,i=>{fl(n,i,t)})}function Cs(n,e){let t=Ge(e);if(t){let s=0;for(let i=0;i<t.length;i++)t[i].status!==2&&(t[s]=t[i],s++);t.length=s,br(e,t.length>0?t:void 0)}ms(e,s=>{Cs(n,s)})}function Nr(n,e){let t=sn(hl(n,e)),s=gs(n.transactionQueueTree_,e);return Uh(s,i=>{Js(n,i)}),Js(n,s),nl(s,i=>{Js(n,i)}),t}function Js(n,e){let t=Ge(e);if(t){let s=[],i=[],r=-1;for(let o=0;o<t.length;o++)t[o].status===3||(t[o].status===1?(_(r===o-1,"All SENT items should be at beginning of queue."),r=o,t[o].status=3,t[o].abortReason="set"):(_(t[o].status===0,"Unexpected transaction status in abort"),t[o].unwatcher(),i=i.concat(Se(n.serverSyncTree_,t[o].currentWriteId,!0)),t[o].onComplete&&s.push(t[o].onComplete.bind(null,new Error("set"),!1,null))));r===-1?br(e,void 0):t.length=r+1,Z(n.eventQueue_,sn(e),i);for(let o=0;o<s.length;o++)ft(s[o])}}function od(n){let e="",t=n.split("/");for(let s=0;s<t.length;s++)if(t[s].length>0){let i=t[s];try{i=decodeURIComponent(i.replace(/\+/g," "))}catch{}e+="/"+i}return e}function ad(n){let e={};n.charAt(0)==="?"&&(n=n.substring(1));for(let t of n.split("&")){if(t.length===0)continue;let s=t.split("=");s.length===2?e[decodeURIComponent(s[0])]=decodeURIComponent(s[1]):q(`Invalid query segment '${t}' in query '${n}'`)}return e}var Vi=function(n,e){let t=ld(n),s=t.namespace;t.domain==="firebase.com"&&ge(t.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),(!s||s==="undefined")&&t.domain!=="localhost"&&ge("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),t.secure||Uc();let i=t.scheme==="ws"||t.scheme==="wss";return{repoInfo:new Un(t.host,t.secure,s,i,e,"",s!==t.subdomain),path:new I(t.pathString)}},ld=function(n){let e="",t="",s="",i="",r="",o=!0,a="https",l=443;if(typeof n=="string"){let c=n.indexOf("//");c>=0&&(a=n.substring(0,c-1),n=n.substring(c+2));let u=n.indexOf("/");u===-1&&(u=n.length);let h=n.indexOf("?");h===-1&&(h=n.length),e=n.substring(0,Math.min(u,h)),u<h&&(i=od(n.substring(u,h)));let d=ad(n.substring(Math.min(n.length,h)));c=e.indexOf(":"),c>=0?(o=a==="https"||a==="wss",l=parseInt(e.substring(c+1),10)):c=e.length;let f=e.slice(0,c);if(f.toLowerCase()==="localhost")t="localhost";else if(f.split(".").length<=2)t=f;else{let p=e.indexOf(".");s=e.substring(0,p).toLowerCase(),t=e.substring(p+1),r=s}"ns"in d&&(r=d.ns)}return{host:e,port:l,domain:t,subdomain:s,secure:o,scheme:a,pathString:i,namespace:r}};var aa="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",cd=function(){let n=0,e=[];return function(t){let s=t===n;n=t;let i,r=new Array(8);for(i=7;i>=0;i--)r[i]=aa.charAt(t%64),t=Math.floor(t/64);_(t===0,"Cannot push at time == 0");let o=r.join("");if(s){for(i=11;i>=0&&e[i]===63;i--)e[i]=0;e[i]++}else for(i=0;i<12;i++)e[i]=Math.floor(Math.random()*64);for(i=0;i<12;i++)o+=aa.charAt(e[i]);return _(o.length===20,"nextPushId: Length should be 20."),o}}();var ss=class{constructor(e,t,s,i){this.eventType=e,this.eventRegistration=t,this.snapshot=s,this.prevName=i}getPath(){let e=this.snapshot.ref;return this.eventType==="value"?e._path:e.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+M(this.snapshot.exportVal())}},is=class{constructor(e,t,s){this.eventRegistration=e,this.error=t,this.path=s}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}};var Xt=class{constructor(e,t){this.snapshotCallback=e,this.cancelCallback=t}onValue(e,t){this.snapshotCallback.call(null,e,t)}onCancel(e){return _(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,e)}get hasCancelCallback(){return!!this.cancelCallback}matches(e){return this.snapshotCallback===e.snapshotCallback||this.snapshotCallback.userCallback!==void 0&&this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context}};var rs=class{constructor(e,t){this._repo=e,this._path=t}cancel(){let e=new $;return Jh(this._repo,this._path,e.wrapCallback(()=>{})),e.promise}remove(){J("OnDisconnect.remove",this._path);let e=new $;return oa(this._repo,this._path,null,e.wrapCallback(()=>{})),e.promise}set(e){J("OnDisconnect.set",this._path),ye("OnDisconnect.set",e,this._path,!1);let t=new $;return oa(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}setWithPriority(e,t){J("OnDisconnect.setWithPriority",this._path),ye("OnDisconnect.setWithPriority",e,this._path,!1),Ir("OnDisconnect.setWithPriority",t,!1);let s=new $;return Zh(this._repo,this._path,e,t,s.wrapCallback(()=>{})),s.promise}update(e){J("OnDisconnect.update",this._path),il("OnDisconnect.update",e,this._path,!1);let t=new $;return ed(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}};var Q=class n{constructor(e,t,s,i){this._repo=e,this._path=t,this._queryParams=s,this._orderByCalled=i}get key(){return E(this._path)?null:ar(this._path)}get ref(){return new ee(this._repo,this._path)}get _queryIdentifier(){let e=zo(this._queryParams),t=rr(e);return t==="{}"?"default":t}get _queryObject(){return zo(this._queryParams)}isEqual(e){if(e=k(e),!(e instanceof n))return!1;let t=this._repo===e._repo,s=lr(this._path,e._path),i=this._queryIdentifier===e._queryIdentifier;return t&&s&&i}toJSON(){return this.toString()}toString(){return this._repo.toString()+gu(this._path)}};function Ts(n,e){if(n._orderByCalled===!0)throw new Error(e+": You can't combine multiple orderBy calls.")}function Le(n){let e=null,t=null;if(n.hasStart()&&(e=n.getIndexStartValue()),n.hasEnd()&&(t=n.getIndexEndValue()),n.getIndex()===pe){let s="Query: When ordering by key, you may only pass one argument to startAt(), endAt(), or equalTo().",i="Query: When ordering by key, the argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() must be a string.";if(n.hasStart()){if(n.getIndexStartName()!==Ae)throw new Error(s);if(typeof e!="string")throw new Error(i)}if(n.hasEnd()){if(n.getIndexEndName()!==Te)throw new Error(s);if(typeof t!="string")throw new Error(i)}}else if(n.getIndex()===S){if(e!=null&&!Yt(e)||t!=null&&!Yt(t))throw new Error("Query: When ordering by priority, the first argument passed to startAt(), startAfter() endAt(), endBefore(), or equalTo() must be a valid priority value (null, a number, or a string).")}else if(_(n.getIndex()instanceof Ht||n.getIndex()===hr,"unknown index type."),e!=null&&typeof e=="object"||t!=null&&typeof t=="object")throw new Error("Query: First argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() cannot be an object.")}function bs(n){if(n.hasStart()&&n.hasEnd()&&n.hasLimit()&&!n.hasAnchoredLimit())throw new Error("Query: Can't combine startAt(), startAfter(), endAt(), endBefore(), and limit(). Use limitToFirst() or limitToLast() instead.")}var ee=class n extends Q{constructor(e,t){super(e,t,new Gt,!1)}get parent(){let e=Aa(this._path);return e===null?null:new n(this._repo,e)}get root(){let e=this;for(;e.parent!==null;)e=e.parent;return e}},dt=class n{constructor(e,t,s){this._node=e,this.ref=t,this._index=s}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(e){let t=new I(e),s=De(this.ref,e);return new n(this._node.getChild(t),s,S)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(e){return this._node.isLeafNode()?!1:!!this._node.forEachChild(this._index,(s,i)=>e(new n(i,De(this.ref,s),S)))}hasChild(e){let t=new I(e);return!this._node.getChild(t).isEmpty()}hasChildren(){return this._node.isLeafNode()?!1:!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}};function Ar(n,e){return n=k(n),n._checkNotDeleted("ref"),e!==void 0?De(n._root,e):n._root}function Pr(n,e){n=k(n),n._checkNotDeleted("refFromURL");let t=Vi(e,n._repo.repoInfo_.nodeAdmin);rl("refFromURL",t);let s=t.repoInfo;return!n._repo.repoInfo_.isCustomHost()&&s.host!==n._repo.repoInfo_.host&&ge("refFromURL: Host name does not match the current database: (found "+s.host+" but expected "+n._repo.repoInfo_.host+")"),Ar(n,t.path.toString())}function De(n,e){return n=k(n),w(n._path)===null?Vh("child","path",e,!1):gt("child","path",e,!1),new ee(n._repo,N(n._path,e))}function _l(n,e){n=k(n),J("push",n._path),ye("push",e,n._path,!0);let t=cl(n._repo),s=cd(t),i=De(n,s),r=De(n,s),o;return e!=null?o=Is(r,e).then(()=>r):o=Promise.resolve(r),i.then=o.then.bind(o),i.catch=o.then.bind(o,void 0),i}function pl(n){return J("remove",n._path),Is(n,null)}function Is(n,e){n=k(n),J("set",n._path),ye("set",e,n._path,!1);let t=new $;return Sr(n._repo,n._path,e,null,t.wrapCallback(()=>{})),t.promise}function gl(n,e){n=k(n),J("setPriority",n._path),Ir("setPriority",e,!1);let t=new $;return Sr(n._repo,N(n._path,".priority"),e,null,t.wrapCallback(()=>{})),t.promise}function ml(n,e,t){if(J("setWithPriority",n._path),ye("setWithPriority",e,n._path,!1),Ir("setWithPriority",t,!1),n.key===".length"||n.key===".keys")throw"setWithPriority failed: "+n.key+" is a read-only object.";let s=new $;return Sr(n._repo,n._path,e,t,s.wrapCallback(()=>{})),s.promise}function yl(n,e){il("update",e,n._path,!1);let t=new $;return Yh(n._repo,n._path,e,t.wrapCallback(()=>{})),t.promise}function vl(n){n=k(n);let e=new Xt(()=>{}),t=new Jt(e);return Qh(n._repo,n,t).then(s=>new dt(s,new ee(n._repo,n._path),n._queryParams.getIndex()))}var Jt=class n{constructor(e){this.callbackContext=e}respondsTo(e){return e==="value"}createEvent(e,t){let s=t._queryParams.getIndex();return new ss("value",this,new dt(e.snapshotNode,new ee(t._repo,t._path),s))}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,null)}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new is(this,e,t):null}matches(e){return e instanceof n?!e.callbackContext||!this.callbackContext?!0:e.callbackContext.matches(this.callbackContext):!1}hasAnyCallback(){return this.callbackContext!==null}},os=class n{constructor(e,t){this.eventType=e,this.callbackContext=t}respondsTo(e){let t=e==="children_added"?"child_added":e;return t=t==="children_removed"?"child_removed":t,this.eventType===t}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new is(this,e,t):null}createEvent(e,t){_(e.childName!=null,"Child events should have a childName.");let s=De(new ee(t._repo,t._path),e.childName),i=t._queryParams.getIndex();return new ss(e.type,this,new dt(e.snapshotNode,s,i),e.prevName)}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,e.prevName)}matches(e){return e instanceof n?this.eventType===e.eventType&&(!this.callbackContext||!e.callbackContext||this.callbackContext.matches(e.callbackContext)):!1}hasAnyCallback(){return!!this.callbackContext}};function ln(n,e,t,s,i){let r;if(typeof s=="object"&&(r=void 0,i=s),typeof s=="function"&&(r=s),i&&i.onlyOnce){let l=t,c=(u,h)=>{qi(n._repo,n,a),l(u,h)};c.userCallback=t.userCallback,c.context=t.context,t=c}let o=new Xt(t,r||void 0),a=e==="value"?new Jt(o):new os(e,o);return td(n._repo,n,a),()=>qi(n._repo,n,a)}function Rs(n,e,t,s){return ln(n,"value",e,t,s)}function xr(n,e,t,s){return ln(n,"child_added",e,t,s)}function Or(n,e,t,s){return ln(n,"child_changed",e,t,s)}function Dr(n,e,t,s){return ln(n,"child_moved",e,t,s)}function Lr(n,e,t,s){return ln(n,"child_removed",e,t,s)}function Mr(n,e,t){let s=null,i=t?new Xt(t):null;e==="value"?s=new Jt(i):e&&(s=new os(e,i)),qi(n._repo,n,s)}var te=class{},as=class extends te{constructor(e,t){super(),this._value=e,this._key=t,this.type="endAt"}_apply(e){ye("endAt",this._value,e._path,!0);let t=wi(e._queryParams,this._value,this._key);if(bs(t),Le(t),e._queryParams.hasEnd())throw new Error("endAt: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new Q(e._repo,e._path,t,e._orderByCalled)}};function wl(n,e){return on("endAt","key",e,!0),new as(n,e)}var Gi=class extends te{constructor(e,t){super(),this._value=e,this._key=t,this.type="endBefore"}_apply(e){ye("endBefore",this._value,e._path,!1);let t=Lu(e._queryParams,this._value,this._key);if(bs(t),Le(t),e._queryParams.hasEnd())throw new Error("endBefore: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new Q(e._repo,e._path,t,e._orderByCalled)}};function El(n,e){return on("endBefore","key",e,!0),new Gi(n,e)}var ls=class extends te{constructor(e,t){super(),this._value=e,this._key=t,this.type="startAt"}_apply(e){ye("startAt",this._value,e._path,!0);let t=vi(e._queryParams,this._value,this._key);if(bs(t),Le(t),e._queryParams.hasStart())throw new Error("startAt: Starting point was already set (by another call to startAt, startBefore or equalTo).");return new Q(e._repo,e._path,t,e._orderByCalled)}};function Cl(n=null,e){return on("startAt","key",e,!0),new ls(n,e)}var $i=class extends te{constructor(e,t){super(),this._value=e,this._key=t,this.type="startAfter"}_apply(e){ye("startAfter",this._value,e._path,!1);let t=Du(e._queryParams,this._value,this._key);if(bs(t),Le(t),e._queryParams.hasStart())throw new Error("startAfter: Starting point was already set (by another call to startAt, startAfter, or equalTo).");return new Q(e._repo,e._path,t,e._orderByCalled)}};function Tl(n,e){return on("startAfter","key",e,!0),new $i(n,e)}var zi=class extends te{constructor(e){super(),this._limit=e,this.type="limitToFirst"}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToFirst: Limit was already set (by another call to limitToFirst or limitToLast).");return new Q(e._repo,e._path,xu(e._queryParams,this._limit),e._orderByCalled)}};function bl(n){if(typeof n!="number"||Math.floor(n)!==n||n<=0)throw new Error("limitToFirst: First argument must be a positive integer.");return new zi(n)}var Ki=class extends te{constructor(e){super(),this._limit=e,this.type="limitToLast"}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToLast: Limit was already set (by another call to limitToFirst or limitToLast).");return new Q(e._repo,e._path,Ou(e._queryParams,this._limit),e._orderByCalled)}};function Il(n){if(typeof n!="number"||Math.floor(n)!==n||n<=0)throw new Error("limitToLast: First argument must be a positive integer.");return new Ki(n)}var Qi=class extends te{constructor(e){super(),this._path=e,this.type="orderByChild"}_apply(e){Ts(e,"orderByChild");let t=new I(this._path);if(E(t))throw new Error("orderByChild: cannot pass in empty path. Use orderByValue() instead.");let s=new Ht(t),i=us(e._queryParams,s);return Le(i),new Q(e._repo,e._path,i,!0)}};function Rl(n){if(n==="$key")throw new Error('orderByChild: "$key" is invalid.  Use orderByKey() instead.');if(n==="$priority")throw new Error('orderByChild: "$priority" is invalid.  Use orderByPriority() instead.');if(n==="$value")throw new Error('orderByChild: "$value" is invalid.  Use orderByValue() instead.');return gt("orderByChild","path",n,!1),new Qi(n)}var Yi=class extends te{constructor(){super(...arguments),this.type="orderByKey"}_apply(e){Ts(e,"orderByKey");let t=us(e._queryParams,pe);return Le(t),new Q(e._repo,e._path,t,!0)}};function Sl(){return new Yi}var Xi=class extends te{constructor(){super(...arguments),this.type="orderByPriority"}_apply(e){Ts(e,"orderByPriority");let t=us(e._queryParams,S);return Le(t),new Q(e._repo,e._path,t,!0)}};function kl(){return new Xi}var Ji=class extends te{constructor(){super(...arguments),this.type="orderByValue"}_apply(e){Ts(e,"orderByValue");let t=us(e._queryParams,hr);return Le(t),new Q(e._repo,e._path,t,!0)}};function Nl(){return new Ji}var Zi=class extends te{constructor(e,t){super(),this._value=e,this._key=t,this.type="equalTo"}_apply(e){if(ye("equalTo",this._value,e._path,!1),e._queryParams.hasStart())throw new Error("equalTo: Starting point was already set (by another call to startAt/startAfter or equalTo).");if(e._queryParams.hasEnd())throw new Error("equalTo: Ending point was already set (by another call to endAt/endBefore or equalTo).");return new as(this._value,this._key)._apply(new ls(this._value,this._key)._apply(e))}};function Al(n,e){return on("equalTo","key",e,!0),new Zi(n,e)}function oe(n,...e){let t=k(n);for(let s of e)t=s._apply(t);return t}gh(ee);Eh(ee);var ud="FIREBASE_DATABASE_EMULATOR_HOST",er={},hd=!1;function dd(n,e,t,s){n.repoInfo_=new Un(`${e}:${t}`,!1,n.repoInfo_.namespace,n.repoInfo_.webSocketOnly,n.repoInfo_.nodeAdmin,n.repoInfo_.persistenceKey,n.repoInfo_.includeNamespaceInQueryParams,!0),s&&(n.authTokenProvider_=s)}function Fr(n,e,t,s,i){let r=s||n.options.databaseURL;r===void 0&&(n.options.projectId||ge("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),W("Using default host for project ",n.options.projectId),r=`${n.options.projectId}-default-rtdb.firebaseio.com`);let o=Vi(r,i),a=o.repoInfo,l,c;typeof process<"u"&&process.env&&(c=process.env[ud]),c?(l=!0,r=`http://${c}?ns=${a.namespace}`,o=Vi(r,i),a=o.repoInfo):l=!o.repoInfo.secure;let u=i&&l?new Lt(Lt.OWNER):new ii(n.name,n.options,e);rl("Invalid Firebase Database URL",o),E(o.path)||ge("Database URL must point to the root of a Firebase Database (not including a child path).");let h=_d(a,n,u,new si(n.name,t));return new tr(h,n)}function fd(n,e){let t=er[e];(!t||t[n.key]!==n)&&ge(`Database ${e}(${n.repoInfo_}) has already been deleted.`),ul(n),delete t[n.key]}function _d(n,e,t,s){let i=er[e.name];i||(i={},er[e.name]=i);let r=i[n.toURLString()];return r&&ge("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),r=new ji(n,hd,t,s),i[n.toURLString()]=r,r}var tr=class{constructor(e,t){this._repoInternal=e,this.app=t,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(zh(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new ee(this._repo,b())),this._rootInternal}_delete(){return this._rootInternal!==null&&(fd(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){this._rootInternal===null&&ge("Cannot call "+e+" on a deleted database.")}};function Pl(){Na.IS_TRANSPORT_INITIALIZED&&q("Transport has already been initialized. Please call this function before calling ref or setting up a listener")}function xl(){Pl(),Bt.forceDisallow()}function Ol(){Pl(),nt.forceDisallow(),Bt.forceAllow()}function v_(n=kn(),e){let t=Rn(n,"database").getImmediate({identifier:e});if(!t._instanceStarted){let s=vn("database");s&&Ur(t,...s)}return t}function Ur(n,e,t,s={}){n=k(n),n._checkNotDeleted("useEmulator"),n._instanceStarted&&ge("Cannot call useEmulator() after instance has already been initialized.");let i=n._repoInternal,r;if(i.repoInfo_.nodeAdmin)s.mockUserToken&&ge('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),r=new Lt(Lt.OWNER);else if(s.mockUserToken){let o=typeof s.mockUserToken=="string"?s.mockUserToken:wn(s.mockUserToken,n.app.options.projectId);r=new Lt(o)}dd(i,e,t,r)}function Dl(n){n=k(n),n._checkNotDeleted("goOffline"),ul(n._repo)}function Ll(n){n=k(n),n._checkNotDeleted("goOnline"),nd(n._repo)}function Ml(n,e){ha(n,e)}function pd(n){ir(Sn),In(new he("database",(e,{instanceIdentifier:t})=>{let s=e.getProvider("app").getImmediate(),i=e.getProvider("auth-internal"),r=e.getProvider("app-check-internal");return Fr(s,i,r,t)},"PUBLIC").setMultipleInstances(!0)),et(Ao,Po,n),et(Ao,Po,"esm2017")}var gd={".sv":"timestamp"};function Fl(){return gd}function Ul(n){return{".sv":{increment:n}}}var nr=class{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return{committed:this.committed,snapshot:this.snapshot.toJSON()}}};function Bl(n,e,t){var s;if(n=k(n),J("Reference.transaction",n._path),n.key===".length"||n.key===".keys")throw"Reference.transaction failed: "+n.key+" is a read-only object.";let i=(s=t?.applyLocally)!==null&&s!==void 0?s:!0,r=new $,o=(l,c,u)=>{let h=null;l?r.reject(l):(h=new dt(u,new ee(n._repo,n._path),S),r.resolve(new nr(c,h)))},a=Rs(n,()=>{});return sd(n._repo,n._path,e,o,a,i),r.promise}cr.prototype.simpleListen=function(n,e){this.sendRequest("q",{p:n},e)};cr.prototype.echo=function(n,e){this.sendRequest("echo",{d:n},e)};pd();var md="@firebase/database-compat",yd="1.0.5";var vd=new bn("@firebase/database-compat"),Wl=function(n){let e="FIREBASE WARNING: "+n;vd.warn(e)};var wd=function(n,e,t,s){if(!(s&&t===void 0)&&typeof t!="boolean")throw new Error(X(n,e)+"must be a boolean.")},Ed=function(n,e,t){if(!(t&&e===void 0))switch(e){case"value":case"child_added":case"child_removed":case"child_changed":case"child_moved":break;default:throw new Error(X(n,"eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}};var Br=class{constructor(e){this._delegate=e}cancel(e){g("OnDisconnect.cancel",0,1,arguments.length),B("OnDisconnect.cancel","onComplete",e,!0);let t=this._delegate.cancel();return e&&t.then(()=>e(null),s=>e(s)),t}remove(e){g("OnDisconnect.remove",0,1,arguments.length),B("OnDisconnect.remove","onComplete",e,!0);let t=this._delegate.remove();return e&&t.then(()=>e(null),s=>e(s)),t}set(e,t){g("OnDisconnect.set",1,2,arguments.length),B("OnDisconnect.set","onComplete",t,!0);let s=this._delegate.set(e);return t&&s.then(()=>t(null),i=>t(i)),s}setWithPriority(e,t,s){g("OnDisconnect.setWithPriority",2,3,arguments.length),B("OnDisconnect.setWithPriority","onComplete",s,!0);let i=this._delegate.setWithPriority(e,t);return s&&i.then(()=>s(null),r=>s(r)),i}update(e,t){if(g("OnDisconnect.update",1,2,arguments.length),Array.isArray(e)){let i={};for(let r=0;r<e.length;++r)i[""+r]=e[r];e=i,Wl("Passing an Array to firebase.database.onDisconnect().update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}B("OnDisconnect.update","onComplete",t,!0);let s=this._delegate.update(e);return t&&s.then(()=>t(null),i=>t(i)),s}};var Wr=class{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return g("TransactionResult.toJSON",0,1,arguments.length),{committed:this.committed,snapshot:this.snapshot.toJSON()}}};var $e=class n{constructor(e,t){this._database=e,this._delegate=t}val(){return g("DataSnapshot.val",0,0,arguments.length),this._delegate.val()}exportVal(){return g("DataSnapshot.exportVal",0,0,arguments.length),this._delegate.exportVal()}toJSON(){return g("DataSnapshot.toJSON",0,1,arguments.length),this._delegate.toJSON()}exists(){return g("DataSnapshot.exists",0,0,arguments.length),this._delegate.exists()}child(e){return g("DataSnapshot.child",0,1,arguments.length),e=String(e),gt("DataSnapshot.child","path",e,!1),new n(this._database,this._delegate.child(e))}hasChild(e){return g("DataSnapshot.hasChild",1,1,arguments.length),gt("DataSnapshot.hasChild","path",e,!1),this._delegate.hasChild(e)}getPriority(){return g("DataSnapshot.getPriority",0,0,arguments.length),this._delegate.priority}forEach(e){return g("DataSnapshot.forEach",1,1,arguments.length),B("DataSnapshot.forEach","action",e,!1),this._delegate.forEach(t=>e(new n(this._database,t)))}hasChildren(){return g("DataSnapshot.hasChildren",0,0,arguments.length),this._delegate.hasChildren()}get key(){return this._delegate.key}numChildren(){return g("DataSnapshot.numChildren",0,0,arguments.length),this._delegate.size}getRef(){return g("DataSnapshot.ref",0,0,arguments.length),new be(this._database,this._delegate.ref)}get ref(){return this.getRef()}},Ss=class n{constructor(e,t){this.database=e,this._delegate=t}on(e,t,s,i){var r;g("Query.on",2,4,arguments.length),B("Query.on","callback",t,!1);let o=n.getCancelAndContextArgs_("Query.on",s,i),a=(c,u)=>{t.call(o.context,new $e(this.database,c),u)};a.userCallback=t,a.context=o.context;let l=(r=o.cancel)===null||r===void 0?void 0:r.bind(o.context);switch(e){case"value":return Rs(this._delegate,a,l),t;case"child_added":return xr(this._delegate,a,l),t;case"child_removed":return Lr(this._delegate,a,l),t;case"child_changed":return Or(this._delegate,a,l),t;case"child_moved":return Dr(this._delegate,a,l),t;default:throw new Error(X("Query.on","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}}off(e,t,s){if(g("Query.off",0,3,arguments.length),Ed("Query.off",e,!0),B("Query.off","callback",t,!0),qs("Query.off","context",s,!0),t){let i=()=>{};i.userCallback=t,i.context=s,Mr(this._delegate,e,i)}else Mr(this._delegate,e)}get(){return vl(this._delegate).then(e=>new $e(this.database,e))}once(e,t,s,i){g("Query.once",1,4,arguments.length),B("Query.once","callback",t,!0);let r=n.getCancelAndContextArgs_("Query.once",s,i),o=new $,a=(c,u)=>{let h=new $e(this.database,c);t&&t.call(r.context,h,u),o.resolve(h)};a.userCallback=t,a.context=r.context;let l=c=>{r.cancel&&r.cancel.call(r.context,c),o.reject(c)};switch(e){case"value":Rs(this._delegate,a,l,{onlyOnce:!0});break;case"child_added":xr(this._delegate,a,l,{onlyOnce:!0});break;case"child_removed":Lr(this._delegate,a,l,{onlyOnce:!0});break;case"child_changed":Or(this._delegate,a,l,{onlyOnce:!0});break;case"child_moved":Dr(this._delegate,a,l,{onlyOnce:!0});break;default:throw new Error(X("Query.once","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}return o.promise}limitToFirst(e){return g("Query.limitToFirst",1,1,arguments.length),new n(this.database,oe(this._delegate,bl(e)))}limitToLast(e){return g("Query.limitToLast",1,1,arguments.length),new n(this.database,oe(this._delegate,Il(e)))}orderByChild(e){return g("Query.orderByChild",1,1,arguments.length),new n(this.database,oe(this._delegate,Rl(e)))}orderByKey(){return g("Query.orderByKey",0,0,arguments.length),new n(this.database,oe(this._delegate,Sl()))}orderByPriority(){return g("Query.orderByPriority",0,0,arguments.length),new n(this.database,oe(this._delegate,kl()))}orderByValue(){return g("Query.orderByValue",0,0,arguments.length),new n(this.database,oe(this._delegate,Nl()))}startAt(e=null,t){return g("Query.startAt",0,2,arguments.length),new n(this.database,oe(this._delegate,Cl(e,t)))}startAfter(e=null,t){return g("Query.startAfter",0,2,arguments.length),new n(this.database,oe(this._delegate,Tl(e,t)))}endAt(e=null,t){return g("Query.endAt",0,2,arguments.length),new n(this.database,oe(this._delegate,wl(e,t)))}endBefore(e=null,t){return g("Query.endBefore",0,2,arguments.length),new n(this.database,oe(this._delegate,El(e,t)))}equalTo(e,t){return g("Query.equalTo",1,2,arguments.length),new n(this.database,oe(this._delegate,Al(e,t)))}toString(){return g("Query.toString",0,0,arguments.length),this._delegate.toString()}toJSON(){return g("Query.toJSON",0,1,arguments.length),this._delegate.toJSON()}isEqual(e){if(g("Query.isEqual",1,1,arguments.length),!(e instanceof n)){let t="Query.isEqual failed: First argument must be an instance of firebase.database.Query.";throw new Error(t)}return this._delegate.isEqual(e._delegate)}static getCancelAndContextArgs_(e,t,s){let i={cancel:void 0,context:void 0};if(t&&s)i.cancel=t,B(e,"cancel",i.cancel,!0),i.context=s,qs(e,"context",i.context,!0);else if(t)if(typeof t=="object"&&t!==null)i.context=t;else if(typeof t=="function")i.cancel=t;else throw new Error(X(e,"cancelOrContext")+" must either be a cancel callback or a context object.");return i}get ref(){return new be(this.database,new ee(this._delegate._repo,this._delegate._path))}},be=class n extends Ss{constructor(e,t){super(e,new Q(t._repo,t._path,new Gt,!1)),this.database=e,this._delegate=t}getKey(){return g("Reference.key",0,0,arguments.length),this._delegate.key}child(e){return g("Reference.child",1,1,arguments.length),typeof e=="number"&&(e=String(e)),new n(this.database,De(this._delegate,e))}getParent(){g("Reference.parent",0,0,arguments.length);let e=this._delegate.parent;return e?new n(this.database,e):null}getRoot(){return g("Reference.root",0,0,arguments.length),new n(this.database,this._delegate.root)}set(e,t){g("Reference.set",1,2,arguments.length),B("Reference.set","onComplete",t,!0);let s=Is(this._delegate,e);return t&&s.then(()=>t(null),i=>t(i)),s}update(e,t){if(g("Reference.update",1,2,arguments.length),Array.isArray(e)){let i={};for(let r=0;r<e.length;++r)i[""+r]=e[r];e=i,Wl("Passing an Array to Firebase.update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}J("Reference.update",this._delegate._path),B("Reference.update","onComplete",t,!0);let s=yl(this._delegate,e);return t&&s.then(()=>t(null),i=>t(i)),s}setWithPriority(e,t,s){g("Reference.setWithPriority",2,3,arguments.length),B("Reference.setWithPriority","onComplete",s,!0);let i=ml(this._delegate,e,t);return s&&i.then(()=>s(null),r=>s(r)),i}remove(e){g("Reference.remove",0,1,arguments.length),B("Reference.remove","onComplete",e,!0);let t=pl(this._delegate);return e&&t.then(()=>e(null),s=>e(s)),t}transaction(e,t,s){g("Reference.transaction",1,3,arguments.length),B("Reference.transaction","transactionUpdate",e,!1),B("Reference.transaction","onComplete",t,!0),wd("Reference.transaction","applyLocally",s,!0);let i=Bl(this._delegate,e,{applyLocally:s}).then(r=>new Wr(r.committed,new $e(this.database,r.snapshot)));return t&&i.then(r=>t(null,r.committed,r.snapshot),r=>t(r,!1,null)),i}setPriority(e,t){g("Reference.setPriority",1,2,arguments.length),B("Reference.setPriority","onComplete",t,!0);let s=gl(this._delegate,e);return t&&s.then(()=>t(null),i=>t(i)),s}push(e,t){g("Reference.push",0,2,arguments.length),B("Reference.push","onComplete",t,!0);let s=_l(this._delegate,e),i=s.then(o=>new n(this.database,o));t&&i.then(()=>t(null),o=>t(o));let r=new n(this.database,s);return r.then=i.then.bind(i),r.catch=i.catch.bind(i,void 0),r}onDisconnect(){return J("Reference.onDisconnect",this._delegate._path),new Br(new rs(this._delegate._repo,this._delegate._path))}get key(){return this.getKey()}get parent(){return this.getParent()}get root(){return this.getRoot()}};var ze=class{constructor(e,t){this._delegate=e,this.app=t,this.INTERNAL={delete:()=>this._delegate._delete(),forceWebSockets:xl,forceLongPolling:Ol}}useEmulator(e,t,s={}){Ur(this._delegate,e,t,s)}ref(e){if(g("database.ref",0,1,arguments.length),e instanceof be){let t=Pr(this._delegate,e.toString());return new be(this,t)}else{let t=Ar(this._delegate,e);return new be(this,t)}}refFromURL(e){g("database.refFromURL",1,1,arguments.length);let s=Pr(this._delegate,e);return new be(this,s)}goOffline(){return g("database.goOffline",0,0,arguments.length),Dl(this._delegate)}goOnline(){return g("database.goOnline",0,0,arguments.length),Ll(this._delegate)}};ze.ServerValue={TIMESTAMP:Fl(),increment:n=>Ul(n)};function Cd({app:n,url:e,version:t,customAuthImpl:s,customAppCheckImpl:i,namespace:r,nodeAdmin:o=!1}){ir(t);let a=new Vs("database-standalone"),l=new Tn("auth-internal",a);l.setComponent(new he("auth-internal",()=>s,"PRIVATE"));let c;return i&&(c=new Tn("app-check-internal",a),c.setComponent(new he("app-check-internal",()=>i,"PRIVATE"))),{instance:new ze(Fr(n,l,c,e,o),n),namespace:r}}var Td=Object.freeze({__proto__:null,initStandalone:Cd});var bd=ze.ServerValue;function Id(n){n.INTERNAL.registerComponent(new he("database-compat",(e,{instanceIdentifier:t})=>{let s=e.getProvider("app-compat").getImmediate(),i=e.getProvider("database").getImmediate({identifier:t});return new ze(i,s)},"PUBLIC").setServiceProps({Reference:be,Query:Ss,Database:ze,DataSnapshot:$e,enableLogging:Ml,INTERNAL:Td,ServerValue:bd}).setMultipleInstances(!0)),n.registerVersion(md,yd)}Id(de);function cn(n,e,t="on",s=io){return new gn(i=>{let r=null;return r=n[t](e,(o,a)=>{s.schedule(()=>{i.next({snapshot:o,prevKey:a})}),t==="once"&&s.schedule(()=>i.complete())},o=>{s.schedule(()=>i.error(o))}),t==="on"?{unsubscribe(){r!=null&&n.off(e,r)}}:{unsubscribe(){}}}).pipe(G(i=>{let{snapshot:r,prevKey:o}=i,a=null;return r.exists()&&(a=r.key),{type:e,payload:r,prevKey:o,key:a}}),ao())}function xd(n){return typeof n=="string"}function Od(n){return typeof n.exportVal=="function"}function $l(n){return n==null}function zl(n){return typeof n.set=="function"}function Hl(n,e){return zl(e)?e:n.ref(e)}function Kl(n,e){if(xd(n))return e.stringCase();if(zl(n))return e.firebaseCase();if(Od(n))return e.snapshotCase();throw new Error(`Expects a string, snapshot, or reference. Got: ${typeof n}`)}function Ql(n){return($l(n)||n.length===0)&&(n=["child_added","child_removed","child_changed","child_moved"]),n}function Yl(n,e,t){e=Ql(e);let s=e.map(i=>cn(n,i,"on",t));return Ws(...s)}function Dd(n,e,t){let s=Yl(n,e).pipe(Hs((i,r)=>[...i,r],[]));return Md(n,s,t)}function Ld(n,e){return cn(n,"value","on",e).pipe(G(t=>{let s;return t.payload.forEach(i=>(s=i.key,!1)),{data:t,lastKeyToLoad:s}}))}function Md(n,e,t){return Ld(n,t).pipe(co(e),G(([i,r])=>{let o=i.lastKeyToLoad,a=r.map(l=>l.key);return{actions:r,lastKeyToLoad:o,loadedKeys:a}}),lo(i=>i.loadedKeys.indexOf(i.lastKeyToLoad)===-1),G(i=>i.actions))}function jl(n,e){return function(s,i){return Kl(s,{stringCase:()=>n.child(s)[e](i),firebaseCase:()=>s[e](i),snapshotCase:()=>s.ref[e](i)})}}function Fd(n){return function(t){return t?Kl(t,{stringCase:()=>n.child(t).remove(),firebaseCase:()=>t.remove(),snapshotCase:()=>t.ref.remove()}):n.remove()}}function Ud(n,e,t){return cn(n,"value","once",t).pipe(Ce(s=>{let i=[Ee(s)];return e.forEach(r=>i.push(cn(n,r,"on",t))),Ws(...i).pipe(Hs(Wd,[]))}),oo())}function Xl(n,e){let t=n.length;for(let s=0;s<t;s++)if(n[s].payload.key===e)return s;return-1}function Bd(n,e){if($l(e))return 0;{let t=Xl(n,e);return t===-1?n.length:t+1}}function Wd(n,e){let{payload:t,prevKey:s,key:i}=e,r=Xl(n,i),o=Bd(n,s);switch(e.type){case"value":if(e.payload?.exists()){let a=null;e.payload.forEach(l=>{let c={payload:l,type:"value",prevKey:a,key:l.key};return a=l.key,n=[...n,c],!1})}return n;case"child_added":if(r>-1)(n[r-1]?.key||null)!==s&&(n=n.filter(l=>l.payload.key!==t.key),n.splice(o,0,e));else{if(s==null)return[e,...n];n=n.slice(),n.splice(o,0,e)}return n;case"child_removed":return n.filter(a=>a.payload.key!==t.key);case"child_changed":return n.map(a=>a.payload.key===i?e:a);case"child_moved":if(r>-1){let a=n.splice(r,1)[0];return n=n.slice(),n.splice(o,0,a),n}return n;default:return n}}function ql(n,e,t){return e=Ql(e),Ud(n,e,t)}function Hd(n,e){let t=e.schedulers.outsideAngular,s=e.schedulers.ngZone.run(()=>n.ref);return{query:n,update:jl(s,"update"),set:jl(s,"set"),push:i=>s.push(i),remove:Fd(s),snapshotChanges(i){return ql(n,i,t).pipe(fe)},stateChanges(i){return Yl(n,i,t).pipe(fe)},auditTrail(i){return Dd(n,i,t).pipe(fe)},valueChanges(i,r){return ql(n,i,t).pipe(G(a=>a.map(l=>r&&r.idField?pn(Fe({},l.payload.val()),{[r.idField]:l.key}):l.payload.val())),fe)}}}function Vl(n,e){return function(){return cn(n,"value","on",e)}}function jd(n,e){return{query:n,snapshotChanges(){return Vl(n,e.schedulers.outsideAngular)().pipe(fe)},update(t){return n.ref.update(t)},set(t){return n.ref.set(t)},remove(){return n.ref.remove()},valueChanges(){return Vl(n,e.schedulers.outsideAngular)().pipe(fe,G(s=>s.payload.exists()?s.payload.val():null))}}}var qd=new Ie("angularfire2.realtimeDatabaseURL"),Vd=new Ie("angularfire2.database.use-emulator"),Jl=(()=>{class n{schedulers;database;constructor(t,s,i,r,o,a,l,c,u,h,d,f,p,m,v){this.schedulers=a;let L=l,F=On(t,o,s);c&&ko(F,o,u,d,f,p,h,m),this.database=Dn(`${F.name}.database.${i}`,"AngularFireDatabase",F.name,()=>{let P=o.runOutsideAngular(()=>F.database(i||void 0));return L&&P.useEmulator(...L),P},[L])}list(t,s){let i=this.schedulers.ngZone.runOutsideAngular(()=>Hl(this.database,t)),r=i;return s&&(r=s(i)),Hd(r,this)}object(t){let s=this.schedulers.ngZone.runOutsideAngular(()=>Hl(this.database,t));return jd(s,this)}createPushId(){return this.schedulers.ngZone.runOutsideAngular(()=>this.database.ref()).push().key}static \u0275fac=function(s){return new(s||n)(T(Pn),T(xn,8),T(qd,8),T(mn),T(yn),T(An),T(Vd,8),T(Ln,8),T(Co,8),T(To,8),T(bo,8),T(Io,8),T(Ro,8),T(So,8),T(Nn,8))};static \u0275prov=Je({token:n,factory:n.\u0275fac,providedIn:"any"})}return n})();var ac="firebasestorage.googleapis.com",lc="storageBucket",$d=2*60*1e3,zd=10*60*1e3,Kd=1e3;var O=class n extends po{constructor(e,t,s=0){super(Hr(e),`Firebase Storage: ${t} (${Hr(e)})`),this.status_=s,this.customData={serverResponse:null},this._baseMessage=this.message,Object.setPrototypeOf(this,n.prototype)}get status(){return this.status_}set status(e){this.status_=e}_codeEquals(e){return Hr(e)===this.code}get serverResponse(){return this.customData.serverResponse}set serverResponse(e){this.customData.serverResponse=e,this.customData.serverResponse?this.message=`${this._baseMessage}
${this.customData.serverResponse}`:this.message=this._baseMessage}},A=function(n){return n.UNKNOWN="unknown",n.OBJECT_NOT_FOUND="object-not-found",n.BUCKET_NOT_FOUND="bucket-not-found",n.PROJECT_NOT_FOUND="project-not-found",n.QUOTA_EXCEEDED="quota-exceeded",n.UNAUTHENTICATED="unauthenticated",n.UNAUTHORIZED="unauthorized",n.UNAUTHORIZED_APP="unauthorized-app",n.RETRY_LIMIT_EXCEEDED="retry-limit-exceeded",n.INVALID_CHECKSUM="invalid-checksum",n.CANCELED="canceled",n.INVALID_EVENT_NAME="invalid-event-name",n.INVALID_URL="invalid-url",n.INVALID_DEFAULT_BUCKET="invalid-default-bucket",n.NO_DEFAULT_BUCKET="no-default-bucket",n.CANNOT_SLICE_BLOB="cannot-slice-blob",n.SERVER_FILE_WRONG_SIZE="server-file-wrong-size",n.NO_DOWNLOAD_URL="no-download-url",n.INVALID_ARGUMENT="invalid-argument",n.INVALID_ARGUMENT_COUNT="invalid-argument-count",n.APP_DELETED="app-deleted",n.INVALID_ROOT_OPERATION="invalid-root-operation",n.INVALID_FORMAT="invalid-format",n.INTERNAL_ERROR="internal-error",n.UNSUPPORTED_ENVIRONMENT="unsupported-environment",n}(A||{});function Hr(n){return"storage/"+n}function Qr(){let n="An unknown error occurred, please check the error payload for server response.";return new O(A.UNKNOWN,n)}function Qd(n){return new O(A.OBJECT_NOT_FOUND,"Object '"+n+"' does not exist.")}function Yd(n){return new O(A.QUOTA_EXCEEDED,"Quota for bucket '"+n+"' exceeded, please view quota on https://firebase.google.com/pricing/.")}function Xd(){let n="User is not authenticated, please authenticate using Firebase Authentication and try again.";return new O(A.UNAUTHENTICATED,n)}function Jd(){return new O(A.UNAUTHORIZED_APP,"This app does not have permission to access Firebase Storage on this project.")}function Zd(n){return new O(A.UNAUTHORIZED,"User does not have permission to access '"+n+"'.")}function cc(){return new O(A.RETRY_LIMIT_EXCEEDED,"Max retry time for operation exceeded, please try again.")}function uc(){return new O(A.CANCELED,"User canceled the upload/download.")}function ef(n){return new O(A.INVALID_URL,"Invalid URL '"+n+"'.")}function tf(n){return new O(A.INVALID_DEFAULT_BUCKET,"Invalid default bucket '"+n+"'.")}function nf(){return new O(A.NO_DEFAULT_BUCKET,"No default bucket found. Did you set the '"+lc+"' property when initializing the app?")}function hc(){return new O(A.CANNOT_SLICE_BLOB,"Cannot slice blob for upload. Please retry the upload.")}function sf(){return new O(A.SERVER_FILE_WRONG_SIZE,"Server recorded incorrect upload file size, please retry the upload.")}function rf(){return new O(A.NO_DOWNLOAD_URL,"The given file does not have any download URLs.")}function of(n){return new O(A.UNSUPPORTED_ENVIRONMENT,`${n} is missing. Make sure to install the required polyfills. See https://firebase.google.com/docs/web/environments-js-sdk#polyfills for more information.`)}function Ke(n){return new O(A.INVALID_ARGUMENT,n)}function dc(){return new O(A.APP_DELETED,"The Firebase app was deleted.")}function Yr(n){return new O(A.INVALID_ROOT_OPERATION,"The operation '"+n+"' cannot be performed on a root reference, create a non-root reference using child, such as .child('file.png').")}function hn(n,e){return new O(A.INVALID_FORMAT,"String does not match format '"+n+"': "+e)}function un(n){throw new O(A.INTERNAL_ERROR,"Internal error: "+n)}var Y=class n{constructor(e,t){this.bucket=e,this.path_=t}get path(){return this.path_}get isRoot(){return this.path.length===0}fullServerUrl(){let e=encodeURIComponent;return"/b/"+e(this.bucket)+"/o/"+e(this.path)}bucketOnlyServerUrl(){return"/b/"+encodeURIComponent(this.bucket)+"/o"}static makeFromBucketSpec(e,t){let s;try{s=n.makeFromUrl(e,t)}catch{return new n(e,"")}if(s.path==="")return s;throw tf(e)}static makeFromUrl(e,t){let s=null,i="([A-Za-z0-9.\\-_]+)";function r(U){U.path.charAt(U.path.length-1)==="/"&&(U.path_=U.path_.slice(0,-1))}let o="(/(.*))?$",a=new RegExp("^gs://"+i+o,"i"),l={bucket:1,path:3};function c(U){U.path_=decodeURIComponent(U.path)}let u="v[A-Za-z0-9_]+",h=t.replace(/[.]/g,"\\."),d="(/([^?#]*).*)?$",f=new RegExp(`^https?://${h}/${u}/b/${i}/o${d}`,"i"),p={bucket:1,path:3},m=t===ac?"(?:storage.googleapis.com|storage.cloud.google.com)":t,v="([^?#]*)",L=new RegExp(`^https?://${m}/${i}/${v}`,"i"),P=[{regex:a,indices:l,postModify:r},{regex:f,indices:p,postModify:c},{regex:L,indices:{bucket:1,path:2},postModify:c}];for(let U=0;U<P.length;U++){let Ye=P[U],Xe=Ye.regex.exec(e);if(Xe){let Us=Xe[Ye.indices.bucket],Rt=Xe[Ye.indices.path];Rt||(Rt=""),s=new n(Us,Rt),Ye.postModify(s);break}}if(s==null)throw ef(e);return s}},qr=class{constructor(e){this.promise_=Promise.reject(e)}getPromise(){return this.promise_}cancel(e=!1){}};function af(n,e,t){let s=1,i=null,r=null,o=!1,a=0;function l(){return a===2}let c=!1;function u(...v){c||(c=!0,e.apply(null,v))}function h(v){i=setTimeout(()=>{i=null,n(f,l())},v)}function d(){r&&clearTimeout(r)}function f(v,...L){if(c){d();return}if(v){d(),u.call(null,v,...L);return}if(l()||o){d(),u.call(null,v,...L);return}s<64&&(s*=2);let P;a===1?(a=2,P=0):P=(s+Math.random())*1e3,h(P)}let p=!1;function m(v){p||(p=!0,d(),!c&&(i!==null?(v||(a=2),clearTimeout(i),h(0)):v||(a=1)))}return h(0),r=setTimeout(()=>{o=!0,m(!0)},t),m}function lf(n){n(!1)}function cf(n){return n!==void 0}function uf(n){return typeof n=="function"}function hf(n){return typeof n=="object"&&!Array.isArray(n)}function As(n){return typeof n=="string"||n instanceof String}function Zl(n){return Xr()&&n instanceof Blob}function Xr(){return typeof Blob<"u"}function Vr(n,e,t,s){if(s<e)throw Ke(`Invalid value for '${n}'. Expected ${e} or greater.`);if(s>t)throw Ke(`Invalid value for '${n}'. Expected ${t} or less.`)}function Me(n,e,t){let s=e;return t==null&&(s=`https://${e}`),`${t}://${s}/v0${n}`}function fc(n){let e=encodeURIComponent,t="?";for(let s in n)if(n.hasOwnProperty(s)){let i=e(s)+"="+e(n[s]);t=t+i+"&"}return t=t.slice(0,-1),t}var wt=function(n){return n[n.NO_ERROR=0]="NO_ERROR",n[n.NETWORK_ERROR=1]="NETWORK_ERROR",n[n.ABORT=2]="ABORT",n}(wt||{});function _c(n,e){let t=n>=500&&n<600,i=[408,429].indexOf(n)!==-1,r=e.indexOf(n)!==-1;return t||i||r}var Gr=class{constructor(e,t,s,i,r,o,a,l,c,u,h,d=!0){this.url_=e,this.method_=t,this.headers_=s,this.body_=i,this.successCodes_=r,this.additionalRetryCodes_=o,this.callback_=a,this.errorCallback_=l,this.timeout_=c,this.progressCallback_=u,this.connectionFactory_=h,this.retry=d,this.pendingConnection_=null,this.backoffId_=null,this.canceled_=!1,this.appDelete_=!1,this.promise_=new Promise((f,p)=>{this.resolve_=f,this.reject_=p,this.start_()})}start_(){let e=(s,i)=>{if(i){s(!1,new vt(!1,null,!0));return}let r=this.connectionFactory_();this.pendingConnection_=r;let o=a=>{let l=a.loaded,c=a.lengthComputable?a.total:-1;this.progressCallback_!==null&&this.progressCallback_(l,c)};this.progressCallback_!==null&&r.addUploadProgressListener(o),r.send(this.url_,this.method_,this.body_,this.headers_).then(()=>{this.progressCallback_!==null&&r.removeUploadProgressListener(o),this.pendingConnection_=null;let a=r.getErrorCode()===wt.NO_ERROR,l=r.getStatus();if(!a||_c(l,this.additionalRetryCodes_)&&this.retry){let u=r.getErrorCode()===wt.ABORT;s(!1,new vt(!1,null,u));return}let c=this.successCodes_.indexOf(l)!==-1;s(!0,new vt(c,r))})},t=(s,i)=>{let r=this.resolve_,o=this.reject_,a=i.connection;if(i.wasSuccessCode)try{let l=this.callback_(a,a.getResponse());cf(l)?r(l):r()}catch(l){o(l)}else if(a!==null){let l=Qr();l.serverResponse=a.getErrorText(),this.errorCallback_?o(this.errorCallback_(a,l)):o(l)}else if(i.canceled){let l=this.appDelete_?dc():uc();o(l)}else{let l=cc();o(l)}};this.canceled_?t(!1,new vt(!1,null,!0)):this.backoffId_=af(e,t,this.timeout_)}getPromise(){return this.promise_}cancel(e){this.canceled_=!0,this.appDelete_=e||!1,this.backoffId_!==null&&lf(this.backoffId_),this.pendingConnection_!==null&&this.pendingConnection_.abort()}},vt=class{constructor(e,t,s){this.wasSuccessCode=e,this.connection=t,this.canceled=!!s}};function df(n,e){e!==null&&e.length>0&&(n.Authorization="Firebase "+e)}function ff(n,e){n["X-Firebase-Storage-Version"]="webjs/"+(e??"AppManager")}function _f(n,e){e&&(n["X-Firebase-GMPID"]=e)}function pf(n,e){e!==null&&(n["X-Firebase-AppCheck"]=e)}function gf(n,e,t,s,i,r,o=!0){let a=fc(n.urlParams),l=n.url+a,c=Object.assign({},n.headers);return _f(c,e),df(c,t),ff(c,r),pf(c,s),new Gr(l,n.method,c,n.body,n.successCodes,n.additionalRetryCodes,n.handler,n.errorHandler,n.timeout,n.progressCallback,i,o)}function mf(){return typeof BlobBuilder<"u"?BlobBuilder:typeof WebKitBlobBuilder<"u"?WebKitBlobBuilder:void 0}function yf(...n){let e=mf();if(e!==void 0){let t=new e;for(let s=0;s<n.length;s++)t.append(n[s]);return t.getBlob()}else{if(Xr())return new Blob(n);throw new O(A.UNSUPPORTED_ENVIRONMENT,"This browser doesn't seem to support creating Blobs")}}function vf(n,e,t){return n.webkitSlice?n.webkitSlice(e,t):n.mozSlice?n.mozSlice(e,t):n.slice?n.slice(e,t):null}function wf(n){if(typeof atob>"u")throw of("base-64");return atob(n)}var ne={RAW:"raw",BASE64:"base64",BASE64URL:"base64url",DATA_URL:"data_url"},dn=class{constructor(e,t){this.data=e,this.contentType=t||null}};function Jr(n,e){switch(n){case ne.RAW:return new dn(pc(e));case ne.BASE64:case ne.BASE64URL:return new dn(gc(n,e));case ne.DATA_URL:return new dn(Cf(e),Tf(e))}throw Qr()}function pc(n){let e=[];for(let t=0;t<n.length;t++){let s=n.charCodeAt(t);if(s<=127)e.push(s);else if(s<=2047)e.push(192|s>>6,128|s&63);else if((s&64512)===55296)if(!(t<n.length-1&&(n.charCodeAt(t+1)&64512)===56320))e.push(239,191,189);else{let r=s,o=n.charCodeAt(++t);s=65536|(r&1023)<<10|o&1023,e.push(240|s>>18,128|s>>12&63,128|s>>6&63,128|s&63)}else(s&64512)===56320?e.push(239,191,189):e.push(224|s>>12,128|s>>6&63,128|s&63)}return new Uint8Array(e)}function Ef(n){let e;try{e=decodeURIComponent(n)}catch{throw hn(ne.DATA_URL,"Malformed data URL.")}return pc(e)}function gc(n,e){switch(n){case ne.BASE64:{let i=e.indexOf("-")!==-1,r=e.indexOf("_")!==-1;if(i||r)throw hn(n,"Invalid character '"+(i?"-":"_")+"' found: is it base64url encoded?");break}case ne.BASE64URL:{let i=e.indexOf("+")!==-1,r=e.indexOf("/")!==-1;if(i||r)throw hn(n,"Invalid character '"+(i?"+":"/")+"' found: is it base64 encoded?");e=e.replace(/-/g,"+").replace(/_/g,"/");break}}let t;try{t=wf(e)}catch(i){throw i.message.includes("polyfill")?i:hn(n,"Invalid character found")}let s=new Uint8Array(t.length);for(let i=0;i<t.length;i++)s[i]=t.charCodeAt(i);return s}var Ns=class{constructor(e){this.base64=!1,this.contentType=null;let t=e.match(/^data:([^,]+)?,/);if(t===null)throw hn(ne.DATA_URL,"Must be formatted 'data:[<mediatype>][;base64],<data>");let s=t[1]||null;s!=null&&(this.base64=bf(s,";base64"),this.contentType=this.base64?s.substring(0,s.length-7):s),this.rest=e.substring(e.indexOf(",")+1)}};function Cf(n){let e=new Ns(n);return e.base64?gc(ne.BASE64,e.rest):Ef(e.rest)}function Tf(n){return new Ns(n).contentType}function bf(n,e){return n.length>=e.length?n.substring(n.length-e.length)===e:!1}var Et=class n{constructor(e,t){let s=0,i="";Zl(e)?(this.data_=e,s=e.size,i=e.type):e instanceof ArrayBuffer?(t?this.data_=new Uint8Array(e):(this.data_=new Uint8Array(e.byteLength),this.data_.set(new Uint8Array(e))),s=this.data_.length):e instanceof Uint8Array&&(t?this.data_=e:(this.data_=new Uint8Array(e.length),this.data_.set(e)),s=e.length),this.size_=s,this.type_=i}size(){return this.size_}type(){return this.type_}slice(e,t){if(Zl(this.data_)){let s=this.data_,i=vf(s,e,t);return i===null?null:new n(i)}else{let s=new Uint8Array(this.data_.buffer,e,t-e);return new n(s,!0)}}static getBlob(...e){if(Xr()){let t=e.map(s=>s instanceof n?s.data_:s);return new n(yf.apply(null,t))}else{let t=e.map(o=>As(o)?Jr(ne.RAW,o).data:o.data_),s=0;t.forEach(o=>{s+=o.byteLength});let i=new Uint8Array(s),r=0;return t.forEach(o=>{for(let a=0;a<o.length;a++)i[r++]=o[a]}),new n(i,!0)}}uploadData(){return this.data_}};function Zr(n){let e;try{e=JSON.parse(n)}catch{return null}return hf(e)?e:null}function If(n){if(n.length===0)return null;let e=n.lastIndexOf("/");return e===-1?"":n.slice(0,e)}function Rf(n,e){let t=e.split("/").filter(s=>s.length>0).join("/");return n.length===0?t:n+"/"+t}function mc(n){let e=n.lastIndexOf("/",n.length-2);return e===-1?n:n.slice(e+1)}function Sf(n,e){return e}var j=class{constructor(e,t,s,i){this.server=e,this.local=t||e,this.writable=!!s,this.xform=i||Sf}},ks=null;function kf(n){return!As(n)||n.length<2?n:mc(n)}function Ps(){if(ks)return ks;let n=[];n.push(new j("bucket")),n.push(new j("generation")),n.push(new j("metageneration")),n.push(new j("name","fullPath",!0));function e(r,o){return kf(o)}let t=new j("name");t.xform=e,n.push(t);function s(r,o){return o!==void 0?Number(o):o}let i=new j("size");return i.xform=s,n.push(i),n.push(new j("timeCreated")),n.push(new j("updated")),n.push(new j("md5Hash",null,!0)),n.push(new j("cacheControl",null,!0)),n.push(new j("contentDisposition",null,!0)),n.push(new j("contentEncoding",null,!0)),n.push(new j("contentLanguage",null,!0)),n.push(new j("contentType",null,!0)),n.push(new j("metadata","customMetadata",!0)),ks=n,ks}function Nf(n,e){function t(){let s=n.bucket,i=n.fullPath,r=new Y(s,i);return e._makeStorageReference(r)}Object.defineProperty(n,"ref",{get:t})}function Af(n,e,t){let s={};s.type="file";let i=t.length;for(let r=0;r<i;r++){let o=t[r];s[o.local]=o.xform(s,e[o.server])}return Nf(s,n),s}function yc(n,e,t){let s=Zr(e);return s===null?null:Af(n,s,t)}function Pf(n,e,t,s){let i=Zr(e);if(i===null||!As(i.downloadTokens))return null;let r=i.downloadTokens;if(r.length===0)return null;let o=encodeURIComponent;return r.split(",").map(c=>{let u=n.bucket,h=n.fullPath,d="/b/"+o(u)+"/o/"+o(h),f=Me(d,t,s),p=fc({alt:"media",token:c});return f+p})[0]}function eo(n,e){let t={},s=e.length;for(let i=0;i<s;i++){let r=e[i];r.writable&&(t[r.server]=n[r.local])}return JSON.stringify(t)}var ec="prefixes",tc="items";function xf(n,e,t){let s={prefixes:[],items:[],nextPageToken:t.nextPageToken};if(t[ec])for(let i of t[ec]){let r=i.replace(/\/$/,""),o=n._makeStorageReference(new Y(e,r));s.prefixes.push(o)}if(t[tc])for(let i of t[tc]){let r=n._makeStorageReference(new Y(e,i.name));s.items.push(r)}return s}function Of(n,e,t){let s=Zr(t);return s===null?null:xf(n,e,s)}var ce=class{constructor(e,t,s,i){this.url=e,this.method=t,this.handler=s,this.timeout=i,this.urlParams={},this.headers={},this.body=null,this.errorHandler=null,this.progressCallback=null,this.successCodes=[200],this.additionalRetryCodes=[]}};function we(n){if(!n)throw Qr()}function xs(n,e){function t(s,i){let r=yc(n,i,e);return we(r!==null),r}return t}function Df(n,e){function t(s,i){let r=Of(n,e,i);return we(r!==null),r}return t}function Lf(n,e){function t(s,i){let r=yc(n,i,e);return we(r!==null),Pf(r,i,n.host,n._protocol)}return t}function bt(n){function e(t,s){let i;return t.getStatus()===401?t.getErrorText().includes("Firebase App Check token is invalid")?i=Jd():i=Xd():t.getStatus()===402?i=Yd(n.bucket):t.getStatus()===403?i=Zd(n.path):i=s,i.status=t.getStatus(),i.serverResponse=s.serverResponse,i}return e}function Os(n){let e=bt(n);function t(s,i){let r=e(s,i);return s.getStatus()===404&&(r=Qd(n.path)),r.serverResponse=i.serverResponse,r}return t}function vc(n,e,t){let s=e.fullServerUrl(),i=Me(s,n.host,n._protocol),r="GET",o=n.maxOperationRetryTime,a=new ce(i,r,xs(n,t),o);return a.errorHandler=Os(e),a}function Mf(n,e,t,s,i){let r={};e.isRoot?r.prefix="":r.prefix=e.path+"/",t&&t.length>0&&(r.delimiter=t),s&&(r.pageToken=s),i&&(r.maxResults=i);let o=e.bucketOnlyServerUrl(),a=Me(o,n.host,n._protocol),l="GET",c=n.maxOperationRetryTime,u=new ce(a,l,Df(n,e.bucket),c);return u.urlParams=r,u.errorHandler=bt(e),u}function Ff(n,e,t){let s=e.fullServerUrl(),i=Me(s,n.host,n._protocol),r="GET",o=n.maxOperationRetryTime,a=new ce(i,r,Lf(n,t),o);return a.errorHandler=Os(e),a}function Uf(n,e,t,s){let i=e.fullServerUrl(),r=Me(i,n.host,n._protocol),o="PATCH",a=eo(t,s),l={"Content-Type":"application/json; charset=utf-8"},c=n.maxOperationRetryTime,u=new ce(r,o,xs(n,s),c);return u.headers=l,u.body=a,u.errorHandler=Os(e),u}function Bf(n,e){let t=e.fullServerUrl(),s=Me(t,n.host,n._protocol),i="DELETE",r=n.maxOperationRetryTime;function o(l,c){}let a=new ce(s,i,o,r);return a.successCodes=[200,204],a.errorHandler=Os(e),a}function Wf(n,e){return n&&n.contentType||e&&e.type()||"application/octet-stream"}function wc(n,e,t){let s=Object.assign({},t);return s.fullPath=n.path,s.size=e.size(),s.contentType||(s.contentType=Wf(null,e)),s}function Hf(n,e,t,s,i){let r=e.bucketOnlyServerUrl(),o={"X-Goog-Upload-Protocol":"multipart"};function a(){let P="";for(let U=0;U<2;U++)P=P+Math.random().toString().slice(2);return P}let l=a();o["Content-Type"]="multipart/related; boundary="+l;let c=wc(e,s,i),u=eo(c,t),h="--"+l+`\r
Content-Type: application/json; charset=utf-8\r
\r
`+u+`\r
--`+l+`\r
Content-Type: `+c.contentType+`\r
\r
`,d=`\r
--`+l+"--",f=Et.getBlob(h,s,d);if(f===null)throw hc();let p={name:c.fullPath},m=Me(r,n.host,n._protocol),v="POST",L=n.maxUploadRetryTime,F=new ce(m,v,xs(n,t),L);return F.urlParams=p,F.headers=o,F.body=f.uploadData(),F.errorHandler=bt(e),F}var Ct=class{constructor(e,t,s,i){this.current=e,this.total=t,this.finalized=!!s,this.metadata=i||null}};function to(n,e){let t=null;try{t=n.getResponseHeader("X-Goog-Upload-Status")}catch{we(!1)}return we(!!t&&(e||["active"]).indexOf(t)!==-1),t}function jf(n,e,t,s,i){let r=e.bucketOnlyServerUrl(),o=wc(e,s,i),a={name:o.fullPath},l=Me(r,n.host,n._protocol),c="POST",u={"X-Goog-Upload-Protocol":"resumable","X-Goog-Upload-Command":"start","X-Goog-Upload-Header-Content-Length":`${s.size()}`,"X-Goog-Upload-Header-Content-Type":o.contentType,"Content-Type":"application/json; charset=utf-8"},h=eo(o,t),d=n.maxUploadRetryTime;function f(m){to(m);let v;try{v=m.getResponseHeader("X-Goog-Upload-URL")}catch{we(!1)}return we(As(v)),v}let p=new ce(l,c,f,d);return p.urlParams=a,p.headers=u,p.body=h,p.errorHandler=bt(e),p}function qf(n,e,t,s){let i={"X-Goog-Upload-Command":"query"};function r(c){let u=to(c,["active","final"]),h=null;try{h=c.getResponseHeader("X-Goog-Upload-Size-Received")}catch{we(!1)}h||we(!1);let d=Number(h);return we(!isNaN(d)),new Ct(d,s.size(),u==="final")}let o="POST",a=n.maxUploadRetryTime,l=new ce(t,o,r,a);return l.headers=i,l.errorHandler=bt(e),l}var nc=256*1024;function Vf(n,e,t,s,i,r,o,a){let l=new Ct(0,0);if(o?(l.current=o.current,l.total=o.total):(l.current=0,l.total=s.size()),s.size()!==l.total)throw sf();let c=l.total-l.current,u=c;i>0&&(u=Math.min(u,i));let h=l.current,d=h+u,f="";u===0?f="finalize":c===u?f="upload, finalize":f="upload";let p={"X-Goog-Upload-Command":f,"X-Goog-Upload-Offset":`${l.current}`},m=s.slice(h,d);if(m===null)throw hc();function v(U,Ye){let Xe=to(U,["active","final"]),Us=l.current+u,Rt=s.size(),Bs;return Xe==="final"?Bs=xs(e,r)(U,Ye):Bs=null,new Ct(Us,Rt,Xe==="final",Bs)}let L="POST",F=e.maxUploadRetryTime,P=new ce(t,L,v,F);return P.headers=p,P.body=m.uploadData(),P.progressCallback=a||null,P.errorHandler=bt(n),P}var Ec={STATE_CHANGED:"state_changed"},V={RUNNING:"running",PAUSED:"paused",SUCCESS:"success",CANCELED:"canceled",ERROR:"error"};function jr(n){switch(n){case"running":case"pausing":case"canceling":return V.RUNNING;case"paused":return V.PAUSED;case"success":return V.SUCCESS;case"canceled":return V.CANCELED;case"error":return V.ERROR;default:return V.ERROR}}var $r=class{constructor(e,t,s){if(uf(e)||t!=null||s!=null)this.next=e,this.error=t??void 0,this.complete=s??void 0;else{let r=e;this.next=r.next,this.error=r.error,this.complete=r.complete}}};function yt(n){return(...e)=>{Promise.resolve().then(()=>n(...e))}}var sc=null,zr=class{constructor(){this.sent_=!1,this.xhr_=new XMLHttpRequest,this.initXhr(),this.errorCode_=wt.NO_ERROR,this.sendPromise_=new Promise(e=>{this.xhr_.addEventListener("abort",()=>{this.errorCode_=wt.ABORT,e()}),this.xhr_.addEventListener("error",()=>{this.errorCode_=wt.NETWORK_ERROR,e()}),this.xhr_.addEventListener("load",()=>{e()})})}send(e,t,s,i){if(this.sent_)throw un("cannot .send() more than once");if(this.sent_=!0,this.xhr_.open(t,e,!0),i!==void 0)for(let r in i)i.hasOwnProperty(r)&&this.xhr_.setRequestHeader(r,i[r].toString());return s!==void 0?this.xhr_.send(s):this.xhr_.send(),this.sendPromise_}getErrorCode(){if(!this.sent_)throw un("cannot .getErrorCode() before sending");return this.errorCode_}getStatus(){if(!this.sent_)throw un("cannot .getStatus() before sending");try{return this.xhr_.status}catch{return-1}}getResponse(){if(!this.sent_)throw un("cannot .getResponse() before sending");return this.xhr_.response}getErrorText(){if(!this.sent_)throw un("cannot .getErrorText() before sending");return this.xhr_.statusText}abort(){this.xhr_.abort()}getResponseHeader(e){return this.xhr_.getResponseHeader(e)}addUploadProgressListener(e){this.xhr_.upload!=null&&this.xhr_.upload.addEventListener("progress",e)}removeUploadProgressListener(e){this.xhr_.upload!=null&&this.xhr_.upload.removeEventListener("progress",e)}},Kr=class extends zr{initXhr(){this.xhr_.responseType="text"}};function ve(){return sc?sc():new Kr}var fn=class{constructor(e,t,s=null){this._transferred=0,this._needToFetchStatus=!1,this._needToFetchMetadata=!1,this._observers=[],this._error=void 0,this._uploadUrl=void 0,this._request=void 0,this._chunkMultiplier=1,this._resolve=void 0,this._reject=void 0,this._ref=e,this._blob=t,this._metadata=s,this._mappings=Ps(),this._resumable=this._shouldDoResumable(this._blob),this._state="running",this._errorHandler=i=>{if(this._request=void 0,this._chunkMultiplier=1,i._codeEquals(A.CANCELED))this._needToFetchStatus=!0,this.completeTransitions_();else{let r=this.isExponentialBackoffExpired();if(_c(i.status,[]))if(r)i=cc();else{this.sleepTime=Math.max(this.sleepTime*2,Kd),this._needToFetchStatus=!0,this.completeTransitions_();return}this._error=i,this._transition("error")}},this._metadataErrorHandler=i=>{this._request=void 0,i._codeEquals(A.CANCELED)?this.completeTransitions_():(this._error=i,this._transition("error"))},this.sleepTime=0,this.maxSleepTime=this._ref.storage.maxUploadRetryTime,this._promise=new Promise((i,r)=>{this._resolve=i,this._reject=r,this._start()}),this._promise.then(null,()=>{})}isExponentialBackoffExpired(){return this.sleepTime>this.maxSleepTime}_makeProgressCallback(){let e=this._transferred;return t=>this._updateProgress(e+t)}_shouldDoResumable(e){return e.size()>256*1024}_start(){this._state==="running"&&this._request===void 0&&(this._resumable?this._uploadUrl===void 0?this._createResumable():this._needToFetchStatus?this._fetchStatus():this._needToFetchMetadata?this._fetchMetadata():this.pendingTimeout=setTimeout(()=>{this.pendingTimeout=void 0,this._continueUpload()},this.sleepTime):this._oneShotUpload())}_resolveToken(e){Promise.all([this._ref.storage._getAuthToken(),this._ref.storage._getAppCheckToken()]).then(([t,s])=>{switch(this._state){case"running":e(t,s);break;case"canceling":this._transition("canceled");break;case"pausing":this._transition("paused");break}})}_createResumable(){this._resolveToken((e,t)=>{let s=jf(this._ref.storage,this._ref._location,this._mappings,this._blob,this._metadata),i=this._ref.storage._makeRequest(s,ve,e,t);this._request=i,i.getPromise().then(r=>{this._request=void 0,this._uploadUrl=r,this._needToFetchStatus=!1,this.completeTransitions_()},this._errorHandler)})}_fetchStatus(){let e=this._uploadUrl;this._resolveToken((t,s)=>{let i=qf(this._ref.storage,this._ref._location,e,this._blob),r=this._ref.storage._makeRequest(i,ve,t,s);this._request=r,r.getPromise().then(o=>{o=o,this._request=void 0,this._updateProgress(o.current),this._needToFetchStatus=!1,o.finalized&&(this._needToFetchMetadata=!0),this.completeTransitions_()},this._errorHandler)})}_continueUpload(){let e=nc*this._chunkMultiplier,t=new Ct(this._transferred,this._blob.size()),s=this._uploadUrl;this._resolveToken((i,r)=>{let o;try{o=Vf(this._ref._location,this._ref.storage,s,this._blob,e,this._mappings,t,this._makeProgressCallback())}catch(l){this._error=l,this._transition("error");return}let a=this._ref.storage._makeRequest(o,ve,i,r,!1);this._request=a,a.getPromise().then(l=>{this._increaseMultiplier(),this._request=void 0,this._updateProgress(l.current),l.finalized?(this._metadata=l.metadata,this._transition("success")):this.completeTransitions_()},this._errorHandler)})}_increaseMultiplier(){nc*this._chunkMultiplier*2<32*1024*1024&&(this._chunkMultiplier*=2)}_fetchMetadata(){this._resolveToken((e,t)=>{let s=vc(this._ref.storage,this._ref._location,this._mappings),i=this._ref.storage._makeRequest(s,ve,e,t);this._request=i,i.getPromise().then(r=>{this._request=void 0,this._metadata=r,this._transition("success")},this._metadataErrorHandler)})}_oneShotUpload(){this._resolveToken((e,t)=>{let s=Hf(this._ref.storage,this._ref._location,this._mappings,this._blob,this._metadata),i=this._ref.storage._makeRequest(s,ve,e,t);this._request=i,i.getPromise().then(r=>{this._request=void 0,this._metadata=r,this._updateProgress(this._blob.size()),this._transition("success")},this._errorHandler)})}_updateProgress(e){let t=this._transferred;this._transferred=e,this._transferred!==t&&this._notifyObservers()}_transition(e){if(this._state!==e)switch(e){case"canceling":case"pausing":this._state=e,this._request!==void 0?this._request.cancel():this.pendingTimeout&&(clearTimeout(this.pendingTimeout),this.pendingTimeout=void 0,this.completeTransitions_());break;case"running":let t=this._state==="paused";this._state=e,t&&(this._notifyObservers(),this._start());break;case"paused":this._state=e,this._notifyObservers();break;case"canceled":this._error=uc(),this._state=e,this._notifyObservers();break;case"error":this._state=e,this._notifyObservers();break;case"success":this._state=e,this._notifyObservers();break}}completeTransitions_(){switch(this._state){case"pausing":this._transition("paused");break;case"canceling":this._transition("canceled");break;case"running":this._start();break}}get snapshot(){let e=jr(this._state);return{bytesTransferred:this._transferred,totalBytes:this._blob.size(),state:e,metadata:this._metadata,task:this,ref:this._ref}}on(e,t,s,i){let r=new $r(t||void 0,s||void 0,i||void 0);return this._addObserver(r),()=>{this._removeObserver(r)}}then(e,t){return this._promise.then(e,t)}catch(e){return this.then(null,e)}_addObserver(e){this._observers.push(e),this._notifyObserver(e)}_removeObserver(e){let t=this._observers.indexOf(e);t!==-1&&this._observers.splice(t,1)}_notifyObservers(){this._finishPromise(),this._observers.slice().forEach(t=>{this._notifyObserver(t)})}_finishPromise(){if(this._resolve!==void 0){let e=!0;switch(jr(this._state)){case V.SUCCESS:yt(this._resolve.bind(null,this.snapshot))();break;case V.CANCELED:case V.ERROR:let t=this._reject;yt(t.bind(null,this._error))();break;default:e=!1;break}e&&(this._resolve=void 0,this._reject=void 0)}}_notifyObserver(e){switch(jr(this._state)){case V.RUNNING:case V.PAUSED:e.next&&yt(e.next.bind(e,this.snapshot))();break;case V.SUCCESS:e.complete&&yt(e.complete.bind(e))();break;case V.CANCELED:case V.ERROR:e.error&&yt(e.error.bind(e,this._error))();break;default:e.error&&yt(e.error.bind(e,this._error))()}}resume(){let e=this._state==="paused"||this._state==="pausing";return e&&this._transition("running"),e}pause(){let e=this._state==="running";return e&&this._transition("pausing"),e}cancel(){let e=this._state==="running"||this._state==="pausing";return e&&this._transition("canceling"),e}};var Tt=class n{constructor(e,t){this._service=e,t instanceof Y?this._location=t:this._location=Y.makeFromUrl(t,e.host)}toString(){return"gs://"+this._location.bucket+"/"+this._location.path}_newRef(e,t){return new n(e,t)}get root(){let e=new Y(this._location.bucket,"");return this._newRef(this._service,e)}get bucket(){return this._location.bucket}get fullPath(){return this._location.path}get name(){return mc(this._location.path)}get storage(){return this._service}get parent(){let e=If(this._location.path);if(e===null)return null;let t=new Y(this._location.bucket,e);return new n(this._service,t)}_throwIfRoot(e){if(this._location.path==="")throw Yr(e)}};function Gf(n,e,t){return n._throwIfRoot("uploadBytesResumable"),new fn(n,new Et(e),t)}function $f(n){let e={prefixes:[],items:[]};return Cc(n,e).then(()=>e)}function Cc(n,e,t){return D(this,null,function*(){let i=yield Tc(n,{pageToken:t});e.prefixes.push(...i.prefixes),e.items.push(...i.items),i.nextPageToken!=null&&(yield Cc(n,e,i.nextPageToken))})}function Tc(n,e){e!=null&&typeof e.maxResults=="number"&&Vr("options.maxResults",1,1e3,e.maxResults);let t=e||{},s=Mf(n.storage,n._location,"/",t.pageToken,t.maxResults);return n.storage.makeRequestWithTokens(s,ve)}function zf(n){n._throwIfRoot("getMetadata");let e=vc(n.storage,n._location,Ps());return n.storage.makeRequestWithTokens(e,ve)}function Kf(n,e){n._throwIfRoot("updateMetadata");let t=Uf(n.storage,n._location,e,Ps());return n.storage.makeRequestWithTokens(t,ve)}function Qf(n){n._throwIfRoot("getDownloadURL");let e=Ff(n.storage,n._location,Ps());return n.storage.makeRequestWithTokens(e,ve).then(t=>{if(t===null)throw rf();return t})}function Yf(n){n._throwIfRoot("deleteObject");let e=Bf(n.storage,n._location);return n.storage.makeRequestWithTokens(e,ve)}function bc(n,e){let t=Rf(n._location.path,e),s=new Y(n._location.bucket,t);return new Tt(n.storage,s)}function Xf(n){return/^[A-Za-z]+:\/\//.test(n)}function Jf(n,e){return new Tt(n,e)}function Ic(n,e){if(n instanceof _n){let t=n;if(t._bucket==null)throw nf();let s=new Tt(t,t._bucket);return e!=null?Ic(s,e):s}else return e!==void 0?bc(n,e):n}function Zf(n,e){if(e&&Xf(e)){if(n instanceof _n)return Jf(n,e);throw Ke("To use ref(service, url), the first argument must be a Storage instance.")}else return Ic(n,e)}function ic(n,e){let t=e?.[lc];return t==null?null:Y.makeFromBucketSpec(t,n)}function e_(n,e,t,s={}){n.host=`${e}:${t}`,n._protocol="http";let{mockUserToken:i}=s;i&&(n._overrideAuthToken=typeof i=="string"?i:wn(i,n.app.options.projectId))}var _n=class{constructor(e,t,s,i,r){this.app=e,this._authProvider=t,this._appCheckProvider=s,this._url=i,this._firebaseVersion=r,this._bucket=null,this._host=ac,this._protocol="https",this._appId=null,this._deleted=!1,this._maxOperationRetryTime=$d,this._maxUploadRetryTime=zd,this._requests=new Set,i!=null?this._bucket=Y.makeFromBucketSpec(i,this._host):this._bucket=ic(this._host,this.app.options)}get host(){return this._host}set host(e){this._host=e,this._url!=null?this._bucket=Y.makeFromBucketSpec(this._url,e):this._bucket=ic(e,this.app.options)}get maxUploadRetryTime(){return this._maxUploadRetryTime}set maxUploadRetryTime(e){Vr("time",0,Number.POSITIVE_INFINITY,e),this._maxUploadRetryTime=e}get maxOperationRetryTime(){return this._maxOperationRetryTime}set maxOperationRetryTime(e){Vr("time",0,Number.POSITIVE_INFINITY,e),this._maxOperationRetryTime=e}_getAuthToken(){return D(this,null,function*(){if(this._overrideAuthToken)return this._overrideAuthToken;let e=this._authProvider.getImmediate({optional:!0});if(e){let t=yield e.getToken();if(t!==null)return t.accessToken}return null})}_getAppCheckToken(){return D(this,null,function*(){let e=this._appCheckProvider.getImmediate({optional:!0});return e?(yield e.getToken()).token:null})}_delete(){return this._deleted||(this._deleted=!0,this._requests.forEach(e=>e.cancel()),this._requests.clear()),Promise.resolve()}_makeStorageReference(e){return new Tt(this,e)}_makeRequest(e,t,s,i,r=!0){if(this._deleted)return new qr(dc());{let o=gf(e,this._appId,s,i,t,this._firebaseVersion,r);return this._requests.add(o),o.getPromise().then(()=>this._requests.delete(o),()=>this._requests.delete(o)),o}}makeRequestWithTokens(e,t){return D(this,null,function*(){let[s,i]=yield Promise.all([this._getAuthToken(),this._getAppCheckToken()]);return this._makeRequest(e,t,s,i).getPromise()})}},rc="@firebase/storage",oc="0.12.5";var Rc="storage";function Sc(n,e,t){return n=k(n),Gf(n,e,t)}function kc(n){return n=k(n),zf(n)}function Nc(n,e){return n=k(n),Kf(n,e)}function Ac(n,e){return n=k(n),Tc(n,e)}function Pc(n){return n=k(n),$f(n)}function xc(n){return n=k(n),Qf(n)}function Oc(n){return n=k(n),Yf(n)}function no(n,e){return n=k(n),Zf(n,e)}function Dc(n,e){return bc(n,e)}function $_(n=kn(),e){n=k(n);let s=Rn(n,Rc).getImmediate({identifier:e}),i=vn("storage");return i&&so(s,...i),s}function so(n,e,t,s={}){e_(n,e,t,s)}function t_(n,{instanceIdentifier:e}){let t=n.getProvider("app").getImmediate(),s=n.getProvider("auth-internal"),i=n.getProvider("app-check-internal");return new _n(t,s,i,e,Sn)}function n_(){In(new he(Rc,t_,"PUBLIC").setMultipleInstances(!0)),et(rc,oc,""),et(rc,oc,"esm2017")}n_();var It=class{constructor(e,t,s){this._delegate=e,this.task=t,this.ref=s}get bytesTransferred(){return this._delegate.bytesTransferred}get metadata(){return this._delegate.metadata}get state(){return this._delegate.state}get totalBytes(){return this._delegate.totalBytes}};var Ds=class{constructor(e,t){this._delegate=e,this._ref=t,this.cancel=this._delegate.cancel.bind(this._delegate),this.catch=this._delegate.catch.bind(this._delegate),this.pause=this._delegate.pause.bind(this._delegate),this.resume=this._delegate.resume.bind(this._delegate)}get snapshot(){return new It(this._delegate.snapshot,this,this._ref)}then(e,t){return this._delegate.then(s=>{if(e)return e(new It(s,this,this._ref))},t)}on(e,t,s,i){let r;return t&&(typeof t=="function"?r=o=>t(new It(o,this,this._ref)):r={next:t.next?o=>t.next(new It(o,this,this._ref)):void 0,complete:t.complete||void 0,error:t.error||void 0}),this._delegate.on(e,r,s||void 0,i||void 0)}},Ls=class{constructor(e,t){this._delegate=e,this._service=t}get prefixes(){return this._delegate.prefixes.map(e=>new Qe(e,this._service))}get items(){return this._delegate.items.map(e=>new Qe(e,this._service))}get nextPageToken(){return this._delegate.nextPageToken||null}};var Qe=class n{constructor(e,t){this._delegate=e,this.storage=t}get name(){return this._delegate.name}get bucket(){return this._delegate.bucket}get fullPath(){return this._delegate.fullPath}toString(){return this._delegate.toString()}child(e){let t=Dc(this._delegate,e);return new n(t,this.storage)}get root(){return new n(this._delegate.root,this.storage)}get parent(){let e=this._delegate.parent;return e==null?null:new n(e,this.storage)}put(e,t){return this._throwIfRoot("put"),new Ds(Sc(this._delegate,e,t),this)}putString(e,t=ne.RAW,s){this._throwIfRoot("putString");let i=Jr(t,e),r=Object.assign({},s);return r.contentType==null&&i.contentType!=null&&(r.contentType=i.contentType),new Ds(new fn(this._delegate,new Et(i.data,!0),r),this)}listAll(){return Pc(this._delegate).then(e=>new Ls(e,this.storage))}list(e){return Ac(this._delegate,e||void 0).then(t=>new Ls(t,this.storage))}getMetadata(){return kc(this._delegate)}updateMetadata(e){return Nc(this._delegate,e)}getDownloadURL(){return xc(this._delegate)}delete(){return this._throwIfRoot("delete"),Oc(this._delegate)}_throwIfRoot(e){if(this._delegate._location.path==="")throw Yr(e)}};var Ms=class{constructor(e,t){this.app=e,this._delegate=t}get maxOperationRetryTime(){return this._delegate.maxOperationRetryTime}get maxUploadRetryTime(){return this._delegate.maxUploadRetryTime}ref(e){if(Lc(e))throw Ke("ref() expected a child path but got a URL, use refFromURL instead.");return new Qe(no(this._delegate,e),this)}refFromURL(e){if(!Lc(e))throw Ke("refFromURL() expected a full URL but got a child path, use ref() instead.");try{Y.makeFromUrl(e,this._delegate.host)}catch{throw Ke("refFromUrl() expected a valid full URL but got an invalid one.")}return new Qe(no(this._delegate,e),this)}setMaxUploadRetryTime(e){this._delegate.maxUploadRetryTime=e}setMaxOperationRetryTime(e){this._delegate.maxOperationRetryTime=e}useEmulator(e,t,s={}){so(this._delegate,e,t,s)}};function Lc(n){return/^[A-Za-z]+:\/\//.test(n)}var s_="@firebase/storage-compat",i_="0.3.8";var r_="storage-compat";function o_(n,{instanceIdentifier:e}){let t=n.getProvider("app-compat").getImmediate(),s=n.getProvider("storage").getImmediate({identifier:e});return new Ms(t,s)}function a_(n){let e={TaskState:V,TaskEvent:Ec,StringFormat:ne,Storage:Ms,Reference:Qe};n.INTERNAL.registerComponent(new he(r_,o_,"PUBLIC").setServiceProps(e).setMultipleInstances(!0)),n.registerVersion(s_,i_)}a_(de);function l_(n){return new gn(e=>{let t=o=>e.next(o),s=o=>e.error(o),i=()=>e.complete();t(n.snapshot);let r=n.on("state_changed",t);return n.then(o=>{t(o),i()},o=>{t(n.snapshot),s(o)}),function(){r()}}).pipe(ro(0))}function Mc(n){let e=l_(n);return{task:n,then:n.then.bind(n),catch:n.catch.bind(n),pause:n.pause.bind(n),cancel:n.cancel.bind(n),resume:n.resume.bind(n),snapshotChanges:()=>e,percentageChanges:()=>e.pipe(G(t=>t.bytesTransferred/t.totalBytes*100))}}function Fs(n){return{getDownloadURL:()=>Ee(void 0).pipe(Gs,Ce(()=>n.getDownloadURL()),fe),getMetadata:()=>Ee(void 0).pipe(Gs,Ce(()=>n.getMetadata()),fe),delete:()=>St(n.delete()),child:e=>Fs(n.child(e)),updateMetadata:e=>St(n.updateMetadata(e)),put:(e,t)=>{let s=n.put(e,t);return Mc(s)},putString:(e,t,s)=>{let i=n.putString(e,t,s);return Mc(i)},list:e=>St(n.list(e)),listAll:()=>St(n.listAll())}}var c_=new Ie("angularfire2.storageBucket"),u_=new Ie("angularfire2.storage.maxUploadRetryTime"),h_=new Ie("angularfire2.storage.maxOperationRetryTime"),d_=new Ie("angularfire2.storage.use-emulator"),Fc=(()=>{class n{storage;constructor(t,s,i,r,o,a,l,c,u,h){let d=On(t,o,s);this.storage=Dn(`${d.name}.storage.${i}`,"AngularFireStorage",d.name,()=>{let f=o.runOutsideAngular(()=>d.storage(i||void 0)),p=u;return p&&f.useEmulator(...p),l&&f.setMaxUploadRetryTime(l),c&&f.setMaxOperationRetryTime(c),f},[l,c])}ref(t){return Fs(this.storage.ref(t))}refFromURL(t){return Fs(this.storage.refFromURL(t))}upload(t,s,i){let r=this.storage.ref(t);return Fs(r).put(s,i)}static \u0275fac=function(s){return new(s||n)(T(Pn),T(xn,8),T(c_,8),T(mn),T(yn),T(An),T(u_,8),T(h_,8),T(d_,8),T(Nn,8))};static \u0275prov=Je({token:n,factory:n.\u0275fac,providedIn:"any"})}return n})();var Tp=(()=>{let e=class e{constructor(s,i,r,o){this.auth=s,this.firestore=i,this.db=r,this.storage=o,this.PATH="Usuarios",this.loguado=!1,this.esAdmin=!1,this.items$=this.db.list(this.PATH).valueChanges()}getAll(){return this.firestore.collection(this.PATH).snapshotChanges().pipe(G(s=>(console.log("Acciones Firestore:",s),s.map(i=>{let r=i.payload.doc.data(),o=i.payload.doc.id;return Fe({id:o},r)}))))}registrar(s){return D(this,null,function*(){let{mail:i,contrase\u00F1a:r,imagenes:o}=s,l=(yield this.auth.createUserWithEmailAndPassword(i,r)).user?.uid;if(l){let c=Array.isArray(o)?o:[o],u=yield this.uploadImages(c,l);yield this.firestore.collection(this.PATH).doc(l).set(pn(Fe({},s),{uid:l,imagenes:u}))}})}uploadImages(s,i){return D(this,null,function*(){let r=s.map((o,a)=>{let l=`users/${i}/profile_${a}`;return this.storage.upload(l,o).then(()=>this.storage.ref(l).getDownloadURL().toPromise())});return Promise.all(r)})}login(s,i){return D(this,null,function*(){try{let r=yield this.auth.signInWithEmailAndPassword(s,i),a=(yield this.firestore.collection(this.PATH).doc(r.user.uid).get().toPromise()).data();if(a){if(a.especialidad.length>0&&!a.aprobado)throw new Error("El especialista no ha sido aprobado.");this.loguado=!0,this.esAdmin=a.esAdmin,localStorage.setItem("dni",a.dni),yield this.updateLastLogin(r.user.uid)}}catch(r){let o;switch(r.code){case"auth/user-not-found":o="No se encontr\xF3 un usuario con ese correo.";break;case"auth/wrong-password":o="Contrase\xF1a incorrecta.";break;case"auth/too-many-requests":o="Demasiados intentos fallidos. Intenta m\xE1s tarde.";break;default:o=r.message||"Error desconocido al iniciar sesi\xF3n."}throw console.error("Error de inicio de sesi\xF3n:",r),new Error(o)}})}loginWithGoogle(){return D(this,null,function*(){try{let s=new de.auth.GoogleAuthProvider,i=yield this.auth.signInWithPopup(s);yield this.updateLastLogin(i.user?.uid)}catch(s){throw console.error("Error de inicio de sesi\xF3n con Google:",s),s}})}updateLastLogin(s){return D(this,null,function*(){yield this.firestore.collection(this.PATH).doc(s).update({lastLogin:new Date})})}guardarUsuarioFirestore(s,i,r,o,a,l,c,u,h,d,f=!1){return D(this,null,function*(){yield this.firestore.collection(this.PATH).doc(s).set({nombre:i,apellido:o,dni:a,obraSocial:l,especialidad:c,mail:r,imagenes:h,aprobado:d,esAdmin:f,lastLogin:de.firestore.FieldValue.serverTimestamp()})})}logout(){return D(this,null,function*(){try{yield this.auth.signOut()}catch(s){throw console.error("Error al cerrar sesi\xF3n:",s),s}})}estaLogueado(){return this.auth.currentUser!==null}usuarioActual(){return new Promise((s,i)=>{this.auth.onAuthStateChanged(r=>{r?this.firestore.collection(this.PATH).doc(r.uid).valueChanges().subscribe(o=>{o?(o.lastLogin=o.lastLogin?o.lastLogin.toDate():null,s(new Ue(r.uid,o.nombre,o.apellido,o.dni,o.edad,o.obraSocial,o.especialidad,"",o.mail,o.imagenes,o.code,o.lastLogin,o.esAdmin,o.aprobado))):i("No se encontr\xF3 el usuario en la base de datos")},o=>i(o)):i("No hay un usuario logueado")})})}getUserById(s){return this.firestore.collection("usuarios").doc(s).valueChanges()}getCurrentUser(){return this.auth.authState.pipe(Ce(s=>s?this.firestore.collection("Usuarios").doc(s.uid).valueChanges():Ee(null)))}getCurrentUserName(){return this.auth.authState.pipe(Ce(s=>s?this.firestore.collection(this.PATH).doc(s.uid).valueChanges().pipe(Ce(i=>Ee(i?.nombre||null))):Ee(null)))}verificarMensajeExistenteAlIniciarSesion(){return D(this,null,function*(){let s=de.auth().currentUser;if(!s){console.error("Usuario no autenticado al verificar el mensaje existente al iniciar sesi\xF3n");return}let i=yield this.firestore.collection("messages").ref.where("userEmail","==",s.email).get();if(i.empty){console.log("No hay mensajes existentes para este usuario al iniciar sesi\xF3n");return}let r=this.firestore.firestore.batch();i.forEach(o=>{r.delete(o.ref)}),yield r.commit(),console.log("Mensajes existentes eliminados para este usuario al iniciar sesi\xF3n")})}getAllUsers(){return this.firestore.collection(this.PATH).snapshotChanges().pipe(G(s=>s.map(i=>{let r=i.payload.doc.data(),o=i.payload.doc.id;return new Ue(o,r.nombre,r.apellido,r.dni,r.edad,r.obraSocial,r.especialidad,r.contrase\u00F1a,r.mail,r.imagenes,r.code,r.lastLogin?r.lastLogin.toDate():null,r.esAdmin,r.aprobado)})))}cambiarEstadoAdmin(s,i){return D(this,null,function*(){try{let r=yield this.firestore.collection(this.PATH).ref.where("mail","==",s).get();if(r.empty)throw new Error("No se encontr\xF3 el usuario con el email proporcionado");yield r.docs[0].ref.update({esAdmin:i})}catch(r){throw console.error("Error al cambiar estado de admin:",r),r}})}eliminarUsuario(s){return D(this,null,function*(){try{yield this.firestore.collection(this.PATH).doc(s).delete();let i=yield this.auth.currentUser;i&&i.uid===s&&(yield i.delete())}catch(i){throw console.error("Error al eliminar el usuario:",i),i}})}registrarEspecialista(s){return D(this,null,function*(){let{mail:i,contrase\u00F1a:r,imagenes:o}=s;try{let a=yield this.auth.createUserWithEmailAndPassword(i,r);if(a&&a.user){let l=a.user.uid,c=[];o&&o.length>0&&o[0]instanceof File&&(c=yield this.uploadImages(o,l)),s.uid=l,s.imagenes=c,s.aprobado=!1,yield Promise.all([this.firestore.collection(this.PATH).doc(l).set(Fe({},s)),this.firestore.collection("specialistRequests").doc(l).set(Fe({},s))]),console.log("Especialista registrado correctamente:",s)}else throw new Error("No se pudo crear el usuario correctamente.")}catch(a){throw console.error("Error al registrar especialista:",a),a}})}aceptarEspecialista(s){return D(this,null,function*(){yield this.firestore.collection(this.PATH).doc(s).update({aprobado:!0}),yield this.firestore.collection("specialistRequests").doc(s).delete()})}obtenerSolicitudesEspecialistas(){return this.firestore.collection("specialistRequests").snapshotChanges().pipe(G(s=>s.map(i=>{let r=i.payload.doc.data();return new Ue(r.uid,r.nombre,r.apellido,r.dni,r.edad,r.obraSocial,r.especialidad,"",r.mail,r.imagenes,r.code,r.lastLogin?r.lastLogin.toDate():null,r.aprobado)})))}rechazarEspecialista(s){return this.firestore.collection("specialistRequests").doc(s).delete()}getUserByDNI(s){return this.firestore.collection(this.PATH,i=>i.where("dni","==",s)).valueChanges().pipe(G(i=>i.map(r=>new Ue(r.uid,r.nombre,r.apellido,r.dni,r.edad,r.obraSocial,r.especialidad,r.contrase\u00F1a,r.mail,r.imagenes,r.code,r.lastLogin?r.lastLogin.toDate():null,r.esAdmin,r.aprobado))))}getCurrentUserDni(){return D(this,null,function*(){return new Promise((s,i)=>{this.auth.onAuthStateChanged(r=>D(this,null,function*(){if(r){let a=(yield this.firestore.collection(this.PATH).doc(r.uid).get().toPromise())?.data();a&&a.dni?s(a.dni):s(null)}else s(null)}))})})}obtenerEspecialidades(){return this.firestore.collection(this.PATH).valueChanges().pipe(G(s=>{let i=[];return s.forEach(r=>{r.especialidad.forEach(o=>{i.includes(o)||i.push(o)})}),i}))}getUsuariosByEspecialidad(s){return this.firestore.collection(this.PATH,i=>i.where("especialidad","array-contains",s)).valueChanges()}obtenerTurnosDisponibles(s){return this.firestore.collection(`Turnos/${s}/Disponibles`).valueChanges()}reservarTurno(s,i,r,o){return this.firestore.collection(`Turnos/${s}/Reservados`).doc(`${i} ${r}`).set(o)}};e.\u0275fac=function(i){return new(i||e)(T(Ln),T(No),T(Jl),T(Fc))},e.\u0275prov=Je({token:e,factory:e.\u0275fac,providedIn:"root"});let n=e;return n})();export{Ue as a,v_ as b,$_ as c,Tp as d};
